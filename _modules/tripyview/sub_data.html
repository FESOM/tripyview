<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tripyview.sub_data &#8212; tripyview 0.3.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/agogo.css?v=8513425a" />
    <script src="../../_static/documentation_options.js?v=e259d695"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../../index.html">tripyview 0.3.0 documentation</a></div>
        <div class="rel" role="navigation" aria-label="Related">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for tripyview.sub_data</h1><div class="highlight"><pre>
<span></span><span class="c1"># Patrick Scholz, 23.01.2018</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>  <span class="k">as</span> <span class="nn">clock</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">netCDF4</span> <span class="k">as</span> <span class="nn">nc</span>
<span class="kn">import</span> <span class="nn">seawater</span> <span class="k">as</span> <span class="nn">sw</span>
<span class="c1">#import gsw as gsw</span>
<span class="kn">from</span> <span class="nn">.sub_mesh</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">warnings</span>


<span class="c1">#xr.set_options(enable_cftimeindex=False)</span>
<span class="c1"># ___LOAD FESOM2 DATA INTO XARRAY DATASET CLASS________________________________</span>
<span class="c1">#|                                                                             |</span>
<span class="c1">#|           *** LOAD FESOM2 DATA INTO --&gt; XARRAY DATASET CLASS ***            |</span>
<span class="c1">#|                                                                             |</span>
<span class="c1">#|_____________________________________________________________________________|</span>
<div class="viewcode-block" id="load_data_fesom2">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.load_data_fesom2">[docs]</a>
<span class="k">def</span> <span class="nf">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> 
                     <span class="n">datapath</span><span class="p">,</span> 
                     <span class="n">vname</span>          <span class="o">=</span> <span class="kc">None</span>      <span class="p">,</span>
                     <span class="n">year</span>           <span class="o">=</span> <span class="kc">None</span>      <span class="p">,</span>
                     <span class="n">mon</span>            <span class="o">=</span> <span class="kc">None</span>      <span class="p">,</span>
                     <span class="n">day</span>            <span class="o">=</span> <span class="kc">None</span>      <span class="p">,</span>
                     <span class="n">record</span>         <span class="o">=</span> <span class="kc">None</span>      <span class="p">,</span>
                     <span class="n">depth</span>          <span class="o">=</span> <span class="kc">None</span>      <span class="p">,</span>
                     <span class="n">depidx</span>         <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span>
                     <span class="n">do_tarithm</span>     <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>    <span class="p">,</span>
                     <span class="n">do_zarithm</span>     <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>    <span class="p">,</span>
                     <span class="n">do_zweight</span>     <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span>
                     <span class="n">do_hweight</span>     <span class="o">=</span> <span class="kc">True</span>      <span class="p">,</span>
                     <span class="n">do_nan</span>         <span class="o">=</span> <span class="kc">True</span>      <span class="p">,</span>
                     <span class="n">do_ie2n</span>        <span class="o">=</span> <span class="kc">True</span>      <span class="p">,</span>
                     <span class="n">do_vecrot</span>      <span class="o">=</span> <span class="kc">True</span>      <span class="p">,</span>
                     <span class="n">do_filename</span>    <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span>
                     <span class="n">do_file</span>        <span class="o">=</span> <span class="s1">&#39;run&#39;</span>     <span class="p">,</span>
                     <span class="n">descript</span>       <span class="o">=</span> <span class="s1">&#39;&#39;</span>        <span class="p">,</span>
                     <span class="n">runid</span>          <span class="o">=</span> <span class="s1">&#39;fesom&#39;</span>   <span class="p">,</span>
                     <span class="n">do_prec</span>        <span class="o">=</span> <span class="s1">&#39;float32&#39;</span> <span class="p">,</span>
                     <span class="n">do_f14cmip6</span>    <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span>
                     <span class="n">do_compute</span>     <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span>
                     <span class="n">do_load</span>        <span class="o">=</span> <span class="kc">True</span>      <span class="p">,</span>
                     <span class="n">do_persist</span>     <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span>
                     <span class="n">do_parallel</span>    <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span>
                     <span class="n">chunks</span>         <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;time&#39;</span> <span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;elem&#39;</span><span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;nod2&#39;</span><span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> \
                                        <span class="s1">&#39;edg_n&#39;</span><span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span>  <span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;nz1&#39;</span> <span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> \
                                        <span class="s1">&#39;ndens&#39;</span><span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">},</span>
                     <span class="n">do_showtime</span>    <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span>
                     <span class="n">do_info</span>        <span class="o">=</span> <span class="kc">True</span>      <span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; general loading of fesom2 and fesom14cmip6 data</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :mesh:          fesom2 tripyview mesh object,  with all mesh information </span>
<span class="sd">        </span>
<span class="sd">        :datapath:      str, path that leads to the FESOM2 data</span>
<span class="sd">        </span>
<span class="sd">        :vname:         str, (default: None), variable name that should be loaded</span>
<span class="sd">        </span>
<span class="sd">        :year:          int, list, np.array, range, default: None, single year or </span>
<span class="sd">                        list/array of years whos file should be opened</span>
<span class="sd">        </span>
<span class="sd">        :mon:           list, (default=None), specific month that should be selected </span>
<span class="sd">                        from dataset. If mon selection leads to no data selection, </span>
<span class="sd">                        because data maybe annual, selection is set to mon=None</span>
<span class="sd">        </span>
<span class="sd">        :day:           list, (default=None), same as mon but for day</span>
<span class="sd">        </span>
<span class="sd">        :record:        int,list, (default=None), load specific record number from </span>
<span class="sd">                        dataset. Overwrites effect of mon and sel_day</span>
<span class="sd">        </span>
<span class="sd">        :depth:         int, list, np.array, range (default=None). Select single </span>
<span class="sd">                        depth level that will be interpolated or select list of depth </span>
<span class="sd">                        levels that will be interpolated and vertically averaged. If </span>
<span class="sd">                        None all vertical layers in data are loaded</span>
<span class="sd">        </span>
<span class="sd">        :depidx:        bool, (default:False) if depth is int and depidx=True, depth</span>
<span class="sd">                        index is selected that is closest to depth. No interpolation </span>
<span class="sd">                        will be done</span>
<span class="sd">        </span>
<span class="sd">        :do_tarithm:    str (default=&#39;mean&#39;) do time arithmetic on time selection</span>
<span class="sd">                        option are: None, &#39;None&#39;, &#39;mean&#39;, &#39;median&#39;, &#39;std&#39;, &#39;var&#39;, &#39;max&#39;</span>
<span class="sd">                        &#39;min&#39;, &#39;sum&#39;</span>
<span class="sd">        </span>
<span class="sd">        :do_zarithm:    str (default=&#39;mean&#39;) do arithmetic on selected vertical layers</span>
<span class="sd">                        options are: None, &#39;None&#39;, &#39;mean&#39;, &#39;max&#39;, &#39;min&#39;, &#39;sum&#39;</span>
<span class="sd">        </span>
<span class="sd">        :do_zweight:    bool, (defaull=False) store weights for vertical weigthed </span>
<span class="sd">                        averages within the dataset</span>
<span class="sd">        </span>
<span class="sd">        :do_hweight:    bool, (default=True), store weightsd for weighted horizontal</span>
<span class="sd">                        averages</span>
<span class="sd">        </span>
<span class="sd">        :do_nan:        bool (default=True), do replace bottom fill values with nan                </span>
<span class="sd">        </span>
<span class="sd">        :do_ie2n:       bool (default=True), if data are on elements automatically </span>
<span class="sd">                        interpolates them to vertices --&gt; easier to plot </span>
<span class="sd">        </span>
<span class="sd">        :do_vecrot:     bool (default=True), if vector data are loaded e.g. </span>
<span class="sd">                        vname=&#39;vec+u+v&#39; rotates the from rotated frame (in which </span>
<span class="sd">                        they are stored) to geo coordinates</span>
<span class="sd">        </span>
<span class="sd">        :do_filename:   str, (default=None) load this specific filname string instead</span>
<span class="sd">                        of path selection via datapath and year</span>
<span class="sd">        </span>
<span class="sd">        :do_file:       str, (default=&#39;run&#39;), which data should be loaded options are</span>
<span class="sd">        </span>
<span class="sd">                        - &#39;run&#39; ... fesom2 simulation files should be load, </span>
<span class="sd">                        - &#39;restart_oce&#39; ... fesom2 ocean restart file should be loaded, </span>
<span class="sd">                        - &#39;restart_ice&#39; ... fesom2 ice restart file should be loaded </span>
<span class="sd">                        - &#39;blowup&#39;      ... fesom2 ocean blowup file will be loaded</span>
<span class="sd">        </span>
<span class="sd">        :descript:      str (default=&#39;&#39;), string to describe dataset is written into </span>
<span class="sd">                        variable attributes</span>
<span class="sd">        </span>
<span class="sd">        :runid:         str (default=&#39;fesom&#39;), runid of loaded data        </span>
<span class="sd">        </span>
<span class="sd">        :do_prec:       str, (default=&#39;float32&#39;) which precision is used for the </span>
<span class="sd">                        loading of the data</span>
<span class="sd">                        </span>
<span class="sd">        :do_f14cmip6:   bool, (default=False), Set to true when loading cmorized </span>
<span class="sd">                        FESOM1.4 CMIP6 data when computing AMOC</span>
<span class="sd">        </span>
<span class="sd">        :do_compute:    bool (default=False), do xarray dataset compute() at the end</span>
<span class="sd">                        data = data.compute(), creates a new dataobject the original</span>
<span class="sd">                        data object seems to persist</span>
<span class="sd">        </span>
<span class="sd">        :do_load:       bool (default=True), do xarray dataset load() at the end</span>
<span class="sd">                        data = data.load(), applies all operations to the original</span>
<span class="sd">                        dataset</span>
<span class="sd">                        </span>
<span class="sd">        :do_persist:    bool (default=False), do xarray dataset persist() at the end</span>
<span class="sd">                        data = data.persist(), keeps the dataset as dask array, keeps</span>
<span class="sd">                        the chunking   </span>
<span class="sd">                        </span>
<span class="sd">        :chunks:        dict(), (default=dict({&#39;time&#39;:&#39;auto&#39;, ...})) dictionary </span>
<span class="sd">                        with chunksize of specific dimensions. By default setted </span>
<span class="sd">                        to auto but can also be setted to specific value. In my </span>
<span class="sd">                        observation it revealed that the loading of data was a factor 2-3</span>
<span class="sd">                        faster with auto-chunking but this might has its limitation</span>
<span class="sd">                        for very large meshes </span>
<span class="sd">                        </span>
<span class="sd">        :do_showtime:   bool, (default=False) show time information stored in dataset</span>
<span class="sd">        </span>
<span class="sd">        :do_info:       bool (defalt=True), print variable info at the end </span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :data:          object, returns xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># default values </span>
    <span class="n">is_data</span> <span class="o">=</span> <span class="s1">&#39;scalar&#39;</span>
    <span class="n">is_ie2n</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">do_vec</span>  <span class="o">=</span> <span class="kc">False</span>
    <span class="n">do_norm</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">do_pdens</span><span class="o">=</span> <span class="kc">False</span>
    <span class="n">str_adep</span><span class="p">,</span> <span class="n">str_atim</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="c1"># string for arithmetic</span>
    <span class="n">str_ldep</span><span class="p">,</span> <span class="n">str_ltim</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="c1"># string for labels</span>
    <span class="n">str_lsave</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>    
    <span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># Related to bug especially on albedo netcdf-c not being threat save since netcdf1.6.1: </span>
    <span class="c1"># https://github.com/pydata/xarray/issues/7079</span>
    <span class="c1"># https://github.com/xCDAT/xcdat/issues/561</span>
    <span class="c1"># https://forum.access-hive.org.au/t/netcdf-not-a-valid-id-errors/389/24</span>
    <span class="kn">import</span> <span class="nn">dask</span>
    <span class="kn">import</span> <span class="nn">distributed</span>
    <span class="k">if</span> <span class="n">distributed</span><span class="o">.</span><span class="n">worker_client</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s2">&quot;single-threaded&quot;</span><span class="p">)</span>

    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># Create xarray dataset object with all grid information </span>
    <span class="k">if</span> <span class="n">vname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;topography&#39;</span><span class="p">,</span><span class="s1">&#39;zcoord&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;narea&#39;</span><span class="p">,</span> <span class="s1">&#39;n_area&#39;</span><span class="p">,</span> <span class="s1">&#39;clusterarea&#39;</span><span class="p">,</span> <span class="s1">&#39;scalararea&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;earea&#39;</span><span class="p">,</span> <span class="s1">&#39;e_area&#39;</span><span class="p">,</span> <span class="s1">&#39;triarea&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;nresol&#39;</span><span class="p">,</span> <span class="s1">&#39;n_resol&#39;</span><span class="p">,</span> <span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;resol&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;eresol&#39;</span><span class="p">,</span><span class="s1">&#39;e_resol&#39;</span><span class="p">,</span><span class="s1">&#39;triresolution&#39;</span><span class="p">,</span><span class="s1">&#39;triresol&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;edepth&#39;</span><span class="p">,</span><span class="s1">&#39;etopo&#39;</span><span class="p">,</span><span class="s1">&#39;e_depth&#39;</span><span class="p">,</span><span class="s1">&#39;e_topo&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;ndepth&#39;</span><span class="p">,</span> <span class="s1">&#39;ntopo&#39;</span><span class="p">,</span> <span class="s1">&#39;n_depth&#39;</span><span class="p">,</span> <span class="s1">&#39;n_topo&#39;</span><span class="p">,</span> <span class="p">]:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>                        
        <span class="c1">#___________________________________________________________________________</span>
        <span class="c1"># store topography in data</span>
        <span class="k">if</span>   <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">vname</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ndepth&#39;</span><span class="p">,</span> <span class="s1">&#39;ntopo&#39;</span><span class="p">,</span> <span class="s1">&#39;n_depth&#39;</span><span class="p">,</span> <span class="s1">&#39;n_topo&#39;</span><span class="p">,</span> <span class="s1">&#39;topography&#39;</span><span class="p">,</span> <span class="s1">&#39;zcoord&#39;</span><span class="p">]):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ntopo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;nod2&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_z</span><span class="p">))</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ntopo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Depth&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ntopo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;descript&quot;</span>   <span class="p">]</span><span class="o">=</span><span class="s1">&#39;Depth&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ntopo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span>  <span class="p">]</span><span class="o">=</span><span class="s1">&#39;Depth&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ntopo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span>      <span class="p">]</span><span class="o">=</span><span class="s1">&#39;m&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ntopo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;is_data&quot;</span>    <span class="p">]</span><span class="o">=</span><span class="n">is_data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="s1">&#39;nod2&#39;</span><span class="p">])</span>
        
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">vname</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;edepth&#39;</span><span class="p">,</span> <span class="s1">&#39;etopo&#39;</span><span class="p">,</span> <span class="s1">&#39;e_depth&#39;</span><span class="p">,</span> <span class="s1">&#39;e_topo&#39;</span> <span class="p">]):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;etopo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;elem&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span><span class="p">]))</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;etopo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Depth&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;etopo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;descript&quot;</span>   <span class="p">]</span><span class="o">=</span><span class="s1">&#39;Depth&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;etopo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span>  <span class="p">]</span><span class="o">=</span><span class="s1">&#39;Depth&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;etopo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span>      <span class="p">]</span><span class="o">=</span><span class="s1">&#39;m&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;etopo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;is_data&quot;</span>    <span class="p">]</span><span class="o">=</span><span class="n">is_data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">])</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">dim_vert</span><span class="p">,</span> <span class="n">dim_horz</span> <span class="o">=</span> <span class="n">do_gridinfo_and_weights</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">do_zweight</span><span class="o">=</span><span class="n">do_zarithm</span><span class="p">)</span>
        
        <span class="c1"># store vertice cluster area in data    </span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">vname</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;narea&#39;</span><span class="p">,</span> <span class="s1">&#39;n_area&#39;</span><span class="p">,</span> <span class="s1">&#39;clusterarea&#39;</span><span class="p">,</span> <span class="s1">&#39;scalararea&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_area</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">compute_n_area</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;narea&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;nod2&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_area</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;narea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Vertice area&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;narea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;descript&quot;</span>   <span class="p">]</span><span class="o">=</span><span class="s1">&#39;Vertice area&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;narea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span>  <span class="p">]</span><span class="o">=</span><span class="s1">&#39;Vertice area&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;narea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span>      <span class="p">]</span><span class="o">=</span><span class="s1">&#39;m^2&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;narea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;is_data&quot;</span>    <span class="p">]</span><span class="o">=</span><span class="n">is_data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="s1">&#39;nod2&#39;</span><span class="p">])</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">dim_vert</span><span class="p">,</span> <span class="n">dim_horz</span> <span class="o">=</span> <span class="n">do_gridinfo_and_weights</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">do_zweight</span><span class="o">=</span><span class="n">do_zarithm</span><span class="p">)</span>
        
        <span class="c1"># store vertice resolution in data               </span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">vname</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nresol&#39;</span><span class="p">,</span> <span class="s1">&#39;n_resol&#39;</span><span class="p">,</span> <span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;resol&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_resol</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">compute_n_resol</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nresol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;nod2&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_resol</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nresol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Resolution&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nresol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;descript&quot;</span>   <span class="p">]</span><span class="o">=</span><span class="s1">&#39;Resolution&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nresol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span>  <span class="p">]</span><span class="o">=</span><span class="s1">&#39;Resolution&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nresol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span>      <span class="p">]</span><span class="o">=</span><span class="s1">&#39;km&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nresol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;is_data&quot;</span>    <span class="p">]</span><span class="o">=</span><span class="n">is_data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="s1">&#39;nod2&#39;</span><span class="p">])</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">dim_vert</span><span class="p">,</span> <span class="n">dim_horz</span> <span class="o">=</span> <span class="n">do_gridinfo_and_weights</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">do_zweight</span><span class="o">=</span><span class="n">do_zarithm</span><span class="p">)</span>
        
        <span class="c1"># store element area in data    </span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">vname</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;earea&#39;</span><span class="p">,</span> <span class="s1">&#39;e_area&#39;</span><span class="p">,</span> <span class="s1">&#39;triarea&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_area</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">compute_e_area</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;earea&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;elem&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">e_area</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;earea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Element area&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;earea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;descript&quot;</span>   <span class="p">]</span><span class="o">=</span><span class="s1">&#39;Element area&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;earea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span>  <span class="p">]</span><span class="o">=</span><span class="s1">&#39;Element area&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;earea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span>      <span class="p">]</span><span class="o">=</span><span class="s1">&#39;m^2&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;earea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;is_data&quot;</span>    <span class="p">]</span><span class="o">=</span><span class="n">is_data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">])</span>
           
        <span class="c1"># store element resolution in data               </span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">vname</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;eresol&#39;</span><span class="p">,</span> <span class="s1">&#39;e_resol&#39;</span><span class="p">,</span> <span class="s1">&#39;triresolution&#39;</span><span class="p">,</span> <span class="s1">&#39;triresol&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_resol</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">compute_e_resol</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;eresol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;elem&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">e_resol</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;eresol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Element resolution&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;eresol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;descript&quot;</span>   <span class="p">]</span><span class="o">=</span><span class="s1">&#39;Element resolution&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;eresol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span>  <span class="p">]</span><span class="o">=</span><span class="s1">&#39;Element resolution&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;eresol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span>      <span class="p">]</span><span class="o">=</span><span class="s1">&#39;km&#39;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;eresol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;is_data&quot;</span>    <span class="p">]</span><span class="o">=</span><span class="n">is_data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">])</span>
           
        <span class="c1">#_______________________________________________________________________</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">dim_vert</span><span class="p">,</span> <span class="n">dim_horz</span> <span class="o">=</span> <span class="n">do_gridinfo_and_weights</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">do_zweight</span><span class="o">=</span><span class="n">do_zarithm</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_compute</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_load</span>   <span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_persist</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>
        <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1">#  ||   ||   ||   ||   ||   ||   ||   ||   ||   ||   ||   ||   ||   ||   ||  </span>
    <span class="c1"># _||_ _||_ _||_ _||_ _||_ _||_ _||_ _||_ _||_ _||_ _||_ _||_ _||_ _||_ _||_ </span>
    <span class="c1"># \  / \  / \  / \  / \  / \  / \  / \  / \  / \  / \  / \  / \  / \  / \  / </span>
    <span class="c1">#  \/   \/   \/   \/   \/   \/   \/   \/   \/   \/   \/   \/   \/   \/   \/  </span>
    <span class="c1">#___________________________________________________________________________    </span>
    <span class="c1"># analyse vname input if vector data should be load  &quot;vec+vnameu+vnamev&quot;</span>
    <span class="n">vname2</span><span class="p">,</span> <span class="n">vname_tmp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;vec&#39;</span> <span class="ow">in</span> <span class="n">vname</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;norm&#39;</span> <span class="ow">in</span> <span class="n">vname</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;vec&#39;</span>  <span class="ow">in</span> <span class="n">vname</span><span class="p">):</span> <span class="n">do_vec</span> <span class="o">=</span><span class="kc">True</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;norm&#39;</span> <span class="ow">in</span> <span class="n">vname</span><span class="p">):</span> <span class="n">do_norm</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">vname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">aux</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot; to load vector or norm of data two variables need to be defined: vec+u+v&quot;</span><span class="p">)</span>
        <span class="n">vname</span><span class="p">,</span> <span class="n">vname2</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">aux</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">aux</span>
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;sigma&#39;</span> <span class="ow">in</span> <span class="n">vname</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;pdens&#39;</span> <span class="ow">in</span> <span class="n">vname</span><span class="p">):</span>
        <span class="n">do_pdens</span><span class="o">=</span><span class="kc">True</span> 
        <span class="n">vname_tmp</span> <span class="o">=</span> <span class="n">vname</span>
        <span class="n">vname</span><span class="p">,</span> <span class="n">vname2</span> <span class="o">=</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;salt&#39;</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># create path name list that needs to be loaded</span>
    <span class="k">if</span> <span class="s1">&#39;~/&#39;</span> <span class="ow">in</span> <span class="n">datapath</span><span class="p">:</span> <span class="n">datapath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">datapath</span><span class="p">))</span>
    <span class="n">pathlist</span><span class="p">,</span> <span class="n">str_ltim</span> <span class="o">=</span> <span class="n">do_pathlist</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">do_filename</span><span class="p">,</span> <span class="n">do_file</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">runid</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathlist</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> 
        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">data</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># set specfic type when loading --&gt; #convert to specific precision</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
    <span class="k">def</span> <span class="nf">_preprocess</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">do_prec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">do_prec</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1">#def _preprocess(x, do_prec):</span>
        <span class="c1">#for var in list(x.coords):</span>
            <span class="c1">#if var == &#39;time_bnds&#39;: x = x.drop_vars(var)</span>
        <span class="c1">#return x.astype(do_prec, copy=False)</span>

    <span class="n">partial_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_preprocess</span><span class="p">,</span> <span class="n">do_prec</span><span class="o">=</span><span class="n">do_prec</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># load multiple files</span>
    <span class="c1"># load normal FESOM2 run file</span>
    <span class="k">if</span> <span class="n">do_file</span><span class="o">==</span><span class="s1">&#39;run&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">pathlist</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span> 
                                 <span class="n">autoclose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="n">partial_func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_showtime</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time.year&#39;</span><span class="p">])</span>
        
        <span class="c1"># in case of vector load also meridional data and merge into </span>
        <span class="c1"># dataset structure</span>
        <span class="k">if</span> <span class="n">do_vec</span> <span class="ow">or</span> <span class="n">do_norm</span> <span class="ow">or</span> <span class="n">do_pdens</span><span class="p">:</span>
            <span class="n">pathlist</span><span class="p">,</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">do_pathlist</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">do_filename</span><span class="p">,</span> <span class="n">do_file</span><span class="p">,</span> <span class="n">vname2</span><span class="p">,</span> <span class="n">runid</span><span class="p">)</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">pathlist</span><span class="p">,</span>  <span class="n">parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span> 
                                                         <span class="n">autoclose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="n">partial_func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">do_vec</span><span class="p">:</span> <span class="n">is_data</span><span class="o">=</span><span class="s1">&#39;vector&#39;</span>
        
        <span class="c1">## rechunking leads to extended memory demand at runtime of xarray with</span>
        <span class="c1">## dask client!!! --&gt; this here is not a good idea!!!</span>
        <span class="c1">#data = data.chunk({&#39;time&#39;: data.sizes[&#39;time&#39;]})</span>
        
    <span class="c1"># load restart or blowup files</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pathlist</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">pathlist</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span> 
                                 <span class="n">autoclose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="n">partial_func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_vec</span> <span class="ow">or</span> <span class="n">do_norm</span> <span class="ow">or</span> <span class="n">do_pdens</span><span class="p">:</span>
            <span class="c1"># which variables should be dropped </span>
            <span class="n">vname_drop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &gt; var in file:&#39;</span><span class="p">,</span> <span class="n">vname_drop</span><span class="p">)</span>
            <span class="n">vname_drop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>
            <span class="n">vname_drop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">vname2</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>    
            <span class="c1"># which variables should be dropped </span>
            <span class="n">vname_drop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &gt; var in file:&#39;</span><span class="p">,</span> <span class="n">vname_drop</span><span class="p">)</span>
            <span class="n">vname_drop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>
            
        <span class="c1"># remove variables that are not needed</span>
        <span class="c1">#data = data.drop(labels=vname_drop)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="n">vname_drop</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________    </span>
    <span class="c1"># This is for icepack data over thickness classes make class selection always </span>
    <span class="c1"># based in indices</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ncat&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">depidx</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="c1">#___________________________________________________________________________    </span>
    <span class="c1"># rename old vertices dimension name to new</span>
    <span class="c1"># &#39;node&#39; --&gt; &#39;nod2&#39;</span>
    <span class="c1"># &#39;nz_1&#39; --&gt; &#39;nz1&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;node&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename_dims</span><span class="p">({</span><span class="s1">&#39;node&#39;</span><span class="p">:</span><span class="s1">&#39;nod2&#39;</span><span class="p">})</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;nz_1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename_dims</span><span class="p">({</span><span class="s1">&#39;nz_1&#39;</span><span class="p">:</span><span class="s1">&#39;nz1&#39;</span><span class="p">})</span>
    
    <span class="c1"># convert dimensions name from fesom14cmip6 --&gt; fesom2</span>
    <span class="k">if</span> <span class="n">do_f14cmip6</span><span class="p">:</span> 
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;lon_bnds&#39;</span><span class="p">,</span><span class="s1">&#39;lat_bnds&#39;</span><span class="p">,</span> <span class="s1">&#39;time_bnds&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ncells&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span>  <span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename_dims</span><span class="p">({</span><span class="s1">&#39;ncells&#39;</span><span class="p">:</span><span class="s1">&#39;nod2&#39;</span><span class="p">})</span>
        
        <span class="c1"># rename coordinate: depth --&gt; nz, do this first than rename dimension otherwise</span>
        <span class="c1"># it triggers a warning message</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;depth&#39;</span>  <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span> 
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;depth&#39;</span> <span class="p">:</span><span class="s1">&#39;nz&#39;</span>  <span class="p">})</span>
            <span class="k">if</span> <span class="s1">&#39;nz&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">nz</span><span class="o">=</span><span class="s1">&#39;nz&#39;</span><span class="p">)</span>
        <span class="c1"># rename dimension: depth --&gt; nz</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;depth&#39;</span>  <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span>  <span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="s1">&#39;nz&#39;</span><span class="p">})</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="s1">&#39;nod2&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="s1">&#39;nz&#39;</span>   <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;nod2&#39;</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">unify_chunks</span><span class="p">()</span>
        
    <span class="c1">#___________________________________________________________________________    </span>
    <span class="c1"># add depth axes since its not included in restart and blowup files</span>
    <span class="c1"># also add weights</span>
    <span class="k">if</span> <span class="n">do_zarithm</span> <span class="o">==</span> <span class="s1">&#39;wmean&#39;</span><span class="p">:</span> <span class="n">do_zweight</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">dim_vert</span><span class="p">,</span> <span class="n">dim_horz</span> <span class="o">=</span> <span class="n">do_gridinfo_and_weights</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">do_zweight</span><span class="o">=</span><span class="n">do_zweight</span><span class="p">,</span> <span class="n">do_hweight</span><span class="o">=</span><span class="n">do_hweight</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># years are selected by the files that are open, need to select mon or day </span>
    <span class="c1"># or record </span>
    <span class="n">data</span><span class="p">,</span> <span class="n">mon</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">str_ltim</span> <span class="o">=</span> <span class="n">do_select_time</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mon</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">str_ltim</span><span class="p">)</span>

    <span class="c1"># do time arithmetic on data</span>
    <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">str_atim</span> <span class="o">=</span> <span class="n">do_time_arithmetic</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_tarithm</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># make sure datas are alligned in [time, elem, nz] and not [time, nz, elem]</span>
    <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dim_vert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">dim_horz</span><span class="p">,</span> <span class="n">dim_vert</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">dim_vert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dim_horz</span><span class="p">,</span> <span class="n">dim_vert</span><span class="p">)</span>

    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># set bottom to nan --&gt; in moment the bottom fill value is zero would be </span>
    <span class="c1"># better to make here a different fill value in the netcdf files !!!</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">do_setbottomnan</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">do_nan</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># select depth levels also for vertical interpolation </span>
    <span class="c1"># found 3d data based mid-depth levels (temp, salt, pressure, ....)</span>
    <span class="c1"># if ( (&#39;nz1&#39; in data[vname].dims) or (&#39;nz&#39;  in data[vname].dims) ) and (depth is not None):</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;nz1&#39;</span><span class="p">,</span><span class="s1">&#39;nz&#39;</span><span class="p">,</span> <span class="s1">&#39;ncat&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">))</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#print(&#39;~~ &gt;-))))o&gt; o0O ~~~ A&#39;)</span>
        <span class="c1">#_______________________________________________________________________</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">str_ldep</span> <span class="o">=</span> <span class="n">do_select_levidx</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depidx</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">if</span> <span class="n">do_pdens</span><span class="p">:</span> 
            <span class="n">data</span><span class="p">,</span> <span class="n">vname</span> <span class="o">=</span> <span class="n">do_potential_density</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_pdens</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">vname2</span><span class="p">,</span> <span class="n">vname_tmp</span><span class="p">)</span>
            
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># do vertical interpolation and summation over interpolated levels </span>
        <span class="k">if</span> <span class="n">depidx</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">str_adep</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">do_zarithm</span><span class="p">)</span>
            
            <span class="n">auxdepth</span> <span class="o">=</span> <span class="n">depth</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">auxdepth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
            <span class="k">if</span>   <span class="p">(</span><span class="s1">&#39;nz1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">nz1</span><span class="o">=</span><span class="n">auxdepth</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nz1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
                    <span class="n">data</span> <span class="o">=</span> <span class="n">do_depth_arithmetic</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_zarithm</span><span class="p">,</span> <span class="s2">&quot;nz1&quot;</span><span class="p">)</span>
                    
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;nz&#39;</span>  <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>    
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">nz</span><span class="o">=</span><span class="n">auxdepth</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>   
                    <span class="n">data</span> <span class="o">=</span> <span class="n">do_depth_arithmetic</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_zarithm</span><span class="p">,</span> <span class="s2">&quot;nz&quot;</span><span class="p">)</span> 
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># select all depth levels but do vertical summation over it --&gt; done for </span>
    <span class="c1"># merid heatflux</span>
    <span class="k">elif</span> <span class="p">(</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;nz1&#39;</span><span class="p">,</span> <span class="s1">&#39;nz&#39;</span><span class="p">,</span> <span class="s1">&#39;ncat&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">))</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">do_zarithm</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;wmean&#39;</span><span class="p">,</span><span class="s1">&#39;wint&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">]):</span> 
        <span class="c1">#print(&#39;~~ &gt;-))))o&gt; o0O ~~~ B&#39;)</span>
        <span class="k">if</span>   <span class="p">(</span><span class="s1">&#39;nz1&#39;</span>  <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">do_depth_arithmetic</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_zarithm</span><span class="p">,</span> <span class="s2">&quot;nz1&quot;</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;nz&#39;</span>   <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">do_depth_arithmetic</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_zarithm</span><span class="p">,</span> <span class="s2">&quot;nz&quot;</span>  <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;ncat&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">do_depth_arithmetic</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_zarithm</span><span class="p">,</span> <span class="s2">&quot;ncat&quot;</span><span class="p">)</span>     
    <span class="c1"># only 2D data found            </span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#print(&#39;~~ &gt;-))))o&gt; o0O ~~~ C&#39;)</span>
        <span class="n">depth</span><span class="o">=</span><span class="kc">None</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># rotate the vectors if do_vecrot=True and do_vec=True</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">do_vector_rotation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">do_vec</span><span class="p">,</span> <span class="n">do_vecrot</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># compute norm of the vectors if do_norm=True    </span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">do_vector_norm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_norm</span><span class="p">)</span>
    
    <span class="c1">##___________________________________________________________________________</span>
    <span class="c1">## compute norm of the vectors if do_norm=True    </span>
    <span class="c1">#data = do_rescaling(data, do_rescale)</span>

    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># compute potential density if do_pdens=True    </span>
    <span class="k">if</span> <span class="n">do_pdens</span> <span class="ow">and</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">data</span><span class="p">,</span> <span class="n">vname</span> <span class="o">=</span> <span class="n">do_potential_density</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_pdens</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">vname2</span><span class="p">,</span> <span class="n">vname_tmp</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># interpolate from elements to node</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">))</span> <span class="ow">and</span> <span class="n">do_ie2n</span><span class="p">:</span> <span class="n">is_ie2n</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">do_interp_e2n</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">do_ie2n</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># write additional attribute info</span>
    <span class="n">str_lsave</span> <span class="o">=</span> <span class="n">str_ltim</span><span class="o">+</span><span class="n">str_ldep</span>
    <span class="n">str_lsave</span> <span class="o">=</span> <span class="n">str_lsave</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">attr_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">({</span><span class="s1">&#39;datapath&#39;</span><span class="p">:</span><span class="n">datapath</span><span class="p">,</span> <span class="s1">&#39;runid&#39;</span><span class="p">:</span><span class="n">runid</span><span class="p">,</span> <span class="s1">&#39;do_file&#39;</span><span class="p">:</span><span class="n">do_file</span><span class="p">,</span> <span class="s1">&#39;do_filename&#39;</span><span class="p">:</span><span class="n">do_filename</span><span class="p">,</span> 
                        <span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="n">year</span><span class="p">,</span> <span class="s1">&#39;mon&#39;</span><span class="p">:</span><span class="n">mon</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">:</span><span class="n">day</span><span class="p">,</span> <span class="s1">&#39;record&#39;</span><span class="p">:</span><span class="n">record</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span><span class="n">depth</span><span class="p">,</span> 
                        <span class="s1">&#39;depidx&#39;</span><span class="p">:</span><span class="n">depidx</span><span class="p">,</span> <span class="s1">&#39;do_tarithm&#39;</span><span class="p">:</span><span class="n">str_atim</span><span class="p">,</span>
                        <span class="s1">&#39;do_zarithm&#39;</span><span class="p">:</span><span class="n">str_adep</span><span class="p">,</span> <span class="s1">&#39;str_ltim&#39;</span><span class="p">:</span><span class="n">str_ltim</span><span class="p">,</span><span class="s1">&#39;str_ldep&#39;</span><span class="p">:</span><span class="n">str_ldep</span><span class="p">,</span><span class="s1">&#39;str_lsave&#39;</span><span class="p">:</span><span class="n">str_lsave</span><span class="p">,</span>
                        <span class="s1">&#39;is_data&#39;</span><span class="p">:</span><span class="n">is_data</span><span class="p">,</span> <span class="s1">&#39;is_ie2n&#39;</span><span class="p">:</span><span class="n">is_ie2n</span><span class="p">,</span> <span class="s1">&#39;do_compute&#39;</span><span class="p">:</span><span class="n">do_compute</span><span class="p">,</span> 
                        <span class="s1">&#39;descript&#39;</span><span class="p">:</span><span class="n">descript</span><span class="p">})</span>
        
        <span class="c1"># in case of icepack data write thickness class as attribute</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ncat&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span> <span class="n">attr_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;ncat&#39;</span><span class="p">:</span><span class="n">depth</span><span class="p">})</span>
            
        <span class="n">data</span> <span class="o">=</span> <span class="n">do_additional_attrs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">attr_dict</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sending large graph of size&quot;</span><span class="p">)</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Large object of size </span><span class="se">\\</span><span class="s2">d+</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">d+ detected in task graph&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">do_compute</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">do_load</span>   <span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">do_persist</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">resetwarnings</span><span class="p">()</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">if</span> <span class="n">do_info</span><span class="p">:</span> 
        <span class="n">info_txt</span> <span class="o">=</span><span class="s2">&quot;&quot;&quot;___FESOM2 DATA INFO________________________</span>
<span class="s2"> &gt; Dimensions : </span><span class="si">{}</span>
<span class="s2"> &gt; </span><span class="si">{}</span>
<span class="s2"> &gt; </span><span class="si">{}</span>
<span class="s2"> ___________________________________________&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data_vars</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">info_txt</span><span class="p">)</span>    
        <span class="c1">#print(list(data.dims))</span>
        <span class="c1">#print(data.coords)</span>
        <span class="c1">#print(data.data_vars)</span>

    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>


    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1">#  /\   /\   /\   /\   /\   /\   /\   /\   /\   /\   /\   /\   /\   /\   /\ </span>
    <span class="c1"># /  \ /  \ /  \ /  \ /  \ /  \ /  \ /  \ /  \ /  \ /  \ /  \ /  \ /  \ /  \</span>
    <span class="c1"># -||- -||- -||- -||- -||- -||- -||- -||- -||- -||- -||- -||- -||- -||- -||-</span>
    <span class="c1">#  ||   ||   ||   ||   ||   ||   ||   ||   ||   ||   ||   ||   ||   ||   ||</span>
    <span class="c1">#___________________________________________________________________________</span>



<span class="c1">#</span>
<span class="c1">#    </span>
<span class="c1"># ___CREATE FILENAME MASK FOR: RUN, RESTART AND BLOWUP FILES___________________</span>
<div class="viewcode-block" id="do_fnamemask">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_fnamemask">[docs]</a>
<span class="k">def</span> <span class="nf">do_fnamemask</span><span class="p">(</span><span class="n">do_file</span><span class="p">,</span><span class="n">vname</span><span class="p">,</span><span class="n">runid</span><span class="p">,</span><span class="n">year</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; contains filename mask to distinguish between run, restart and blowup file</span>
<span class="sd">    that can be loaded    </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :do_file:   str, which kind of file should be loaded, &#39;run&#39;,&#39;restart_oce&#39;, &#39;restart_ice&#39;, &#39;blowup&#39;</span>
<span class="sd">        </span>
<span class="sd">        :vname:     str, name of variable </span>
<span class="sd">        </span>
<span class="sd">        :runid:     str, runid of simulation usually &#39;fesom&#39;</span>
<span class="sd">        </span>
<span class="sd">        :year:      int, year number that should be loaded</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :fname:   str, filename</span>
<span class="sd">    </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span>   <span class="n">do_file</span><span class="o">==</span><span class="s1">&#39;run&#39;</span>            <span class="p">:</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>   <span class="n">vname</span><span class="p">,</span><span class="n">runid</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">do_file</span><span class="o">==</span><span class="s1">&#39;restart_oce&#39;</span>    <span class="p">:</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.oce.restart/</span><span class="si">{}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runid</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">vname</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">do_file</span><span class="o">==</span><span class="s1">&#39;restart_ice&#39;</span>    <span class="p">:</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.ice.restart/</span><span class="si">{}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runid</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">vname</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">do_file</span><span class="o">==</span><span class="s1">&#39;restart_icepack&#39;</span><span class="p">:</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.icepack.restart/</span><span class="si">{}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runid</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">vname</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">do_file</span><span class="o">==</span><span class="s1">&#39;blowup&#39;</span>         <span class="p">:</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.oce.blowup.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">runid</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>
    <span class="c1">#elif do_file==&#39;restart_oce&#39;: fname = &#39;{}.{}.oce.restart.nc&#39;.format(runid,year)</span>
    <span class="c1">#elif do_file==&#39;restart_ice&#39;: fname = &#39;{}.{}.ice.restart.nc&#39;.format(runid,year)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span></div>




<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___CREATE PATHLIST TO DATAFILES______________________________________________</span>
<div class="viewcode-block" id="do_pathlist">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_pathlist">[docs]</a>
<span class="k">def</span> <span class="nf">do_pathlist</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">do_filename</span><span class="p">,</span> <span class="n">do_file</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">runid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; create path/file list of data that should be loaded </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :year:          int, list, np.array, range of years that should be loaded</span>
<span class="sd">        </span>
<span class="sd">        :datapath:      str, path that leads to the FESOM2 data</span>
<span class="sd">        </span>
<span class="sd">        :do_filename:   bool, (default=None) load this specific filname string instead</span>
<span class="sd">        </span>
<span class="sd">        :fo_file:       str, which kind of file should be loaded, &#39;run&#39;, </span>
<span class="sd">                        &#39;restart_oce&#39;, &#39;restart_ice&#39;, &#39;blowup&#39;   </span>
<span class="sd">        </span>
<span class="sd">        :vname:         str, name of variable </span>
<span class="sd">        </span>
<span class="sd">        :runid:         str, runid of simulation usually &#39;fesom&#39; </span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :pathlist:      str, list</span>
<span class="sd">    </span>
<span class="sd">    ____________________________________________________________________________ </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pathlist</span><span class="o">=</span><span class="p">[]</span>
    <span class="c1"># specific filename and path is given to load </span>
    <span class="k">if</span>  <span class="n">do_filename</span><span class="p">:</span> 
        <span class="n">pathlist</span> <span class="o">=</span> <span class="n">datapath</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">str_mtim</span> <span class="o">=</span> <span class="s1">&#39;y:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">str_mtim</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">datapath</span><span class="p">)</span>
        
    <span class="c1"># list, np.array or range of years is given to load files</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">range</span><span class="p">)):</span>
        <span class="c1"># year = [yr_start, yr_end]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> 
            <span class="n">year_in</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">year</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">str_mtim</span> <span class="o">=</span> <span class="s1">&#39;y:</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1"># year = [year1,year2,year3....]            </span>
        <span class="k">else</span><span class="p">:</span>           
            <span class="n">year_in</span> <span class="o">=</span> <span class="n">year</span>
            <span class="n">str_mtim</span> <span class="o">=</span> <span class="s1">&#39;y:</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1"># loop over year to create filename list </span>
        <span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="n">year_in</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">do_fnamemask</span><span class="p">(</span><span class="n">do_file</span><span class="p">,</span><span class="n">vname</span><span class="p">,</span><span class="n">runid</span><span class="p">,</span><span class="n">yr</span><span class="p">)</span>
            <span class="n">path</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">pathlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--&gt; No file: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># a single year is given to load</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">do_fnamemask</span><span class="p">(</span><span class="n">do_file</span><span class="p">,</span><span class="n">vname</span><span class="p">,</span><span class="n">runid</span><span class="p">,</span><span class="n">year</span><span class="p">)</span>
        <span class="n">path</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">pathlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--&gt; No file: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">str_mtim</span> <span class="o">=</span> <span class="s1">&#39;y:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot; year can be integer, list, np.array or range(start,end)&quot;</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">pathlist</span><span class="p">,</span><span class="n">str_mtim</span><span class="p">)</span></div>




<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___CREATE GRIDINFO AND AREA &amp;N DEPTH WEIGHTS__________________________________</span>
<div class="viewcode-block" id="do_gridinfo_and_weights">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_gridinfo_and_weights">[docs]</a>
<span class="k">def</span> <span class="nf">do_gridinfo_and_weights</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">do_hweight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_zweight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; apply all coordinate information to the dataset. Apply vertice/ element centroids</span>
<span class="sd">    lon/lat positions, horizontal area weights for the scalar and vector cell and </span>
<span class="sd">    vertical depth weight</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :mesh:          fesom2 tripyview mesh object,  with all mesh information </span>
<span class="sd">        </span>
<span class="sd">        :data:          xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">        :do_hweight:    bool, (default=True) store weightsd for weighted horizontal</span>
<span class="sd">                        averages</span>
<span class="sd">        </span>
<span class="sd">        :do_zweight:    bool, (default=False) store weights for vertical weigthed </span>
<span class="sd">                        averages within the dataset</span>
<span class="sd">                        </span>
<span class="sd">    Returns:</span>
<span class="sd">        </span>
<span class="sd">        :data:          xarray dataset object, with coordinate + weight information</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Suppress the specific warning about sending large graphs</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sending large graph of size&quot;</span><span class="p">)</span>

    <span class="n">dimv</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span>   <span class="p">(</span><span class="s1">&#39;nz1&#39;</span>  <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> 
        <span class="n">dimv</span> <span class="o">=</span> <span class="s1">&#39;nz1&#39;</span>
        <span class="k">if</span>   <span class="p">(</span><span class="s1">&#39;nz1&#39;</span>  <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;nz1&#39;</span> <span class="p">)</span> 
        <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;nz_1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;nz_1&#39;</span><span class="p">)</span> 
        <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimv</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimv</span><span class="p">]})</span> 
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;nz1&#39;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="p">,</span>                  <span class="n">dims</span><span class="o">=</span><span class="n">dimv</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span> <span class="p">})</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;nzi&#39;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimv</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span>  <span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span> <span class="p">})</span>
        
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;nz&#39;</span>   <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> 
        <span class="n">dimv</span> <span class="o">=</span> <span class="s1">&#39;nz&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;nz&#39;</span>  <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;nz&#39;</span> <span class="p">)</span> 
        <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimv</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimv</span><span class="p">]})</span> 
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">nz</span>   <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">,</span>                  <span class="n">dims</span><span class="o">=</span><span class="n">dimv</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">nzi</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimv</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span> <span class="p">)</span>
        
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;ndens&#39;</span>   <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> 
        <span class="n">dimv</span> <span class="o">=</span> <span class="s1">&#39;ndens&#39;</span>
    
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;ncat&#39;</span>   <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> 
        <span class="n">dimv</span> <span class="o">=</span> <span class="s1">&#39;ncat&#39;</span>
        
    <span class="n">dimh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span>   <span class="p">(</span><span class="s1">&#39;nod2&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
        <span class="n">dimh</span> <span class="o">=</span> <span class="s1">&#39;nod2&#39;</span>
        <span class="k">if</span> <span class="n">dimh</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">:</span> <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimh</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimh</span><span class="p">]})</span>
        <span class="k">else</span>                      <span class="p">:</span> <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({})</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># set coordinates</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lon</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span>              <span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimh</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lat</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span>              <span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimh</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">nodi</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n2dn</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">))</span>
        <span class="k">if</span>   <span class="n">dimv</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nz1&#39;</span><span class="p">]:</span> 
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">nodiz</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="o">-</span><span class="mi">1</span>      <span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">dimv</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nz&#39;</span><span class="p">]:</span> 
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">nodiz</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span>        <span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">))</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># do horiz weighting for weighted mean computation on nodes</span>
        <span class="k">if</span> <span class="n">do_hweight</span><span class="p">:</span>
            <span class="k">if</span>   <span class="s1">&#39;nz1&#39;</span>  <span class="o">==</span> <span class="n">dimv</span><span class="p">:</span>
                <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimh</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimh</span><span class="p">],</span> <span class="n">dimv</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimv</span><span class="p">]})</span> 
                <span class="n">w_A</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_area</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">dimv</span><span class="p">,</span> <span class="n">dimh</span><span class="p">])</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;nz&#39;</span>   <span class="o">==</span> <span class="n">dimv</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_area</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># in case fesom14cmip6 n_area is not depth dependent, therefor ndims=1</span>
                    <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimh</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimh</span><span class="p">]})</span> 
                    <span class="n">w_A</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_area</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span>        <span class="n">dimh</span><span class="p">])</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>    
                    <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimh</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimh</span><span class="p">],</span> <span class="n">dimv</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimv</span><span class="p">]})</span> 
                    <span class="n">w_A</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_area</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">dimv</span><span class="p">,</span> <span class="n">dimh</span><span class="p">])</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>   
                <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimh</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimh</span><span class="p">]})</span> 
                <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_area</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># in case fesom14cmip6 n_area is not depth dependent, therefor ndims=1</span>
                    <span class="n">w_A</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_area</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span>        <span class="n">dimh</span><span class="p">])</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>    
                    <span class="n">w_A</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_area</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span>        <span class="n">dimh</span><span class="p">])</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">w_A</span><span class="o">=</span><span class="n">w_A</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">w_A</span><span class="p">)</span>
        
        <span class="c1"># do vertical weighting/volumen weight</span>
        <span class="k">if</span> <span class="n">do_zweight</span> <span class="ow">and</span> <span class="n">dimv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  
            <span class="k">if</span>   <span class="s1">&#39;nz1&#39;</span> <span class="o">==</span> <span class="n">dimv</span><span class="p">:</span>
                <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimv</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimv</span><span class="p">]})</span> 
                <span class="c1">#w_An = xr.DataArray(mesh.n_area[:-1,:].astype(&#39;float32&#39;), dims=[&#39;nz1&#39;, &#39;nod2&#39;]).chunk(data.chunksizes[&#39;nod2&#39;])</span>
                <span class="n">w_z</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimv</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span>
                <span class="c1">#data = data.assign_coords(w_z=w_z*w_An)</span>
            <span class="k">elif</span> <span class="s1">&#39;nz&#39;</span> <span class="o">==</span> <span class="n">dimv</span><span class="p">:</span>
                <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimv</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimv</span><span class="p">]})</span> 
                <span class="c1">#w_An = xr.DataArray(mesh.n_area.astype(&#39;float32&#39;), dims=[&#39;nz&#39;, &#39;nod2&#39;]).chunk(data.chunksizes[&#39;nod2&#39;])</span>
                <span class="n">w_z</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(((</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)),</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimv</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span>
            <span class="c1">#data = data.drop(&#39;w_A&#39;)    </span>
            <span class="c1">#data = data.assign_coords(w_z=w_An*w_z)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">w_z</span><span class="o">=</span><span class="n">w_z</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">w_z</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>                          
        <span class="n">dimh</span> <span class="o">=</span> <span class="s1">&#39;elem&#39;</span>
        <span class="k">if</span> <span class="n">dimh</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">:</span> <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimh</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimh</span><span class="p">]})</span>
        <span class="k">else</span>                      <span class="p">:</span> <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({})</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># set coordinates</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lon</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimh</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lat</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimh</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">elemi</span><span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n2de</span><span class="p">)</span>            <span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">))</span>
        <span class="k">if</span>   <span class="n">dimv</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nz1&#39;</span><span class="p">]:</span> 
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">elemiz</span><span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span><span class="o">-</span><span class="mi">1</span>                  <span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">dimv</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nz&#39;</span><span class="p">]:</span> 
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">elemiz</span><span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span>                    <span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">))</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># do weighting for weighted mean computation on elements</span>
        <span class="k">if</span> <span class="n">do_hweight</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">w_A</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_area</span>                   <span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimh</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">do_zweight</span> <span class="ow">and</span> <span class="n">dimv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
            <span class="k">if</span>   <span class="s1">&#39;nz1&#39;</span> <span class="o">==</span> <span class="n">dimv</span><span class="p">:</span>
                <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimh</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimh</span><span class="p">],</span> <span class="n">dimv</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimv</span><span class="p">]})</span>
                <span class="n">w_A</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">nlev</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n2de</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n2de</span><span class="p">):</span> <span class="n">w_A</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span><span class="n">ei</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">w_Ae</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">w_A</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">dimv</span><span class="p">,</span> <span class="n">dimh</span><span class="p">])</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span> 
                                               
                <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimv</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimv</span><span class="p">]})</span>
                <span class="n">w_z</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimv</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="s1">&#39;nz&#39;</span> <span class="o">==</span> <span class="n">dimv</span><span class="p">:</span>
                <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimh</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimh</span><span class="p">],</span> <span class="n">dimv</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimv</span><span class="p">]})</span>
                <span class="n">w_A</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">nlev</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n2de</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n2de</span><span class="p">):</span> <span class="n">w_A</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span><span class="n">ei</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">w_Ae</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">w_A</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">dimv</span><span class="p">,</span> <span class="n">dimh</span><span class="p">])</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span>
                
                <span class="n">set_chunk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">dimv</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="n">dimv</span><span class="p">]})</span>
                <span class="n">w_z</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dims</span><span class="o">=</span><span class="n">dimv</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">set_chunk</span><span class="p">)</span>
                
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">w_z</span><span class="o">=</span><span class="n">w_z</span><span class="o">*</span><span class="n">w_Ae</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">w_z</span><span class="p">,</span> <span class="n">w_Ae</span><span class="p">,</span> <span class="n">w_A</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">resetwarnings</span><span class="p">()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dimv</span><span class="p">,</span> <span class="n">dimh</span><span class="p">)</span></div>


    

<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___SET 3D BOTTOM VALUES TO NAN_______________________________________________</span>
<div class="viewcode-block" id="do_setbottomnan">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_setbottomnan">[docs]</a>
<span class="k">def</span> <span class="nf">do_setbottomnan</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">do_nan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; replace bottom fill values with nan (default value is zero)</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :mesh:      fesom2 tripyview mesh object,  with all mesh information</span>
<span class="sd">        </span>
<span class="sd">        :data:      xarray dataset object     </span>
<span class="sd">        </span>
<span class="sd">        :do_nan:    bool,  do replace bottom fill values with nan</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :data:      xarray dataset object     </span>
<span class="sd">        </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set bottom to nan --&gt; in moment the bottom fill value is zero would be </span>
    <span class="c1"># better to make here a different fill value in the netcdf files !!!</span>
    <span class="k">if</span> <span class="n">do_nan</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nz1&#39;</span><span class="p">,</span><span class="s1">&#39;nz&#39;</span><span class="p">]):</span> 
        <span class="k">if</span>   <span class="p">(</span><span class="s1">&#39;nod2&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
            <span class="c1">#if vname in [&#39;Kv&#39;, &#39;Av&#39;]: </span>
            <span class="k">if</span>   <span class="p">(</span><span class="s1">&#39;nz1&#39;</span>  <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">mat_nodiz</span><span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nodiz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;nz1&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nz1&#39;</span><span class="p">]})</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;nz&#39;</span>   <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">mat_nodiz</span><span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nodiz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;nz&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nz&#39;</span><span class="p">]})</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">mat_nzinod</span><span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nzi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;nod2&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nod2&#39;</span><span class="p">]})</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;nod2&#39;</span><span class="p">)</span>
            
            <span class="c1"># kickout all cooordinates from mat_nodiz and mat_nzinod</span>
            <span class="n">mat_nodiz</span> <span class="o">=</span> <span class="n">mat_nodiz</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mat_nodiz</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>
            <span class="n">mat_nzinod</span><span class="o">=</span> <span class="n">mat_nzinod</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mat_nzinod</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>
            
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mat_nzinod</span><span class="o">&lt;=</span><span class="n">mat_nodiz</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">mat_nodiz</span><span class="p">,</span> <span class="n">mat_nzinod</span>
                
        <span class="k">elif</span><span class="p">(</span><span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
            <span class="k">if</span>   <span class="p">(</span><span class="s1">&#39;nz1&#39;</span>  <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">mat_elemiz</span><span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;elemiz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;nz1&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nz1&#39;</span><span class="p">]})</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;nz&#39;</span>   <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">mat_elemiz</span><span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;elemiz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;nz&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nz&#39;</span><span class="p">]})</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">mat_nzielem</span><span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nzi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;elemi&#39;</span><span class="p">]})</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;elem&#39;</span><span class="p">)</span>
            
            <span class="c1"># kickout all cooordinates from mat_nzielem</span>
            <span class="n">mat_elemiz</span> <span class="o">=</span> <span class="n">mat_elemiz</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mat_elemiz</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>
            <span class="n">mat_nzielem</span><span class="o">=</span> <span class="n">mat_nzielem</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mat_nzielem</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>
            
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mat_nzielem</span><span class="o">&lt;=</span><span class="n">mat_elemiz</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">mat_elemiz</span><span class="p">,</span> <span class="n">mat_nzielem</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>




<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___DO TIME SELECTION_________________________________________________________</span>
<div class="viewcode-block" id="do_select_time">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_select_time">[docs]</a>
<span class="k">def</span> <span class="nf">do_select_time</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mon</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">str_mtim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; select specific month, dayy or record number                             </span>
<span class="sd">    </span>
<span class="sd">    Paramters:</span>
<span class="sd">    </span>
<span class="sd">        :data:      xarray dataset object                                   </span>
<span class="sd">        </span>
<span class="sd">        :mon:       list, (default=None), specific month that should be     </span>
<span class="sd">                    selected from dataset. If mon selection leads to no data</span>
<span class="sd">                    selection, because data maybe annual, selection is set to</span>
<span class="sd">                    mon=None                                                </span>
<span class="sd">        </span>
<span class="sd">        :day:       list, (default=None), same as mon but for day           </span>
<span class="sd">        </span>
<span class="sd">        :record:    int, list, (default=None), load specific record number from</span>
<span class="sd">                    dataset. Overwrites effect of mon and sel_day    </span>
<span class="sd">                    </span>
<span class="sd">        :str_mtim:  str, time label string input here contains already selection</span>
<span class="sd">                    from years &#39;y:1958-2019&#39;, now add info from selction of month or </span>
<span class="sd">                    days</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :data:      returns xarray dataset object      </span>
<span class="sd">        </span>
<span class="sd">        :mon:       list, with mon that got selected otherwise None</span>
<span class="sd">        </span>
<span class="sd">        :day:       list, with day  that got selected otherwise None</span>
<span class="sd">        </span>
<span class="sd">        :str_ltim:  str, with selected time information </span>
<span class="sd">    </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># select no time use entire yearly file</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">day</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mon</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">str_mtim</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># select time based on record index --&gt; overwrites mon and day selection        </span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">record</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">record</span><span class="p">)</span>
        <span class="c1"># do time information string </span>
        <span class="n">str_mtim</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, rec: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_mtim</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># select time based on mon and or day selection </span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">mon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">day</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mon</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="n">mon</span> <span class="o">=</span> <span class="p">[</span><span class="n">mon</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="n">day</span> <span class="o">=</span> <span class="p">[</span><span class="n">day</span><span class="p">]</span>
        
        <span class="c1"># by default select everything</span>
        <span class="n">sel_mon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">sel_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        
        <span class="c1"># than check if mon or day is defined and overwrite selction mon day</span>
        <span class="c1"># selction array</span>
        <span class="k">if</span>   <span class="p">(</span><span class="n">mon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span> <span class="n">sel_mon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;time.month&#39;</span><span class="p">],</span> <span class="n">mon</span><span class="p">)</span>
        <span class="k">if</span>   <span class="p">(</span><span class="n">day</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span> <span class="n">sel_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;time.day&#39;</span><span class="p">]</span>  <span class="p">,</span> <span class="n">day</span><span class="p">)</span>
        
        <span class="c1"># check if selection would discard all time slices </span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sel_mon</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span> 
            <span class="n">sel_mon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">mon</span>     <span class="o">=</span> <span class="kc">None</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &gt; your mon selection was discarded, no time slice would have been selected!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   The loaded data might be only annual mean&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sel_day</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span> 
            <span class="n">sel_mday</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">day</span>      <span class="o">=</span> <span class="kc">None</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &gt; your day selection was discarded, no time slice would have been selected!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   The loaded data might be only annual or monthly mean&quot;</span><span class="p">)</span>
            
        <span class="c1"># select matching time slices</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">sel_mon</span><span class="p">,</span><span class="n">sel_day</span><span class="p">))</span>
        
        <span class="c1"># do time information string for month</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">mon</span><span class="p">)</span><span class="o">!=</span><span class="mi">12</span><span class="p">:</span>
            <span class="n">mon_list_short</span><span class="o">=</span><span class="s1">&#39;JFMAMJJASOND&#39;</span>
            <span class="n">mon_list_lon</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span> 
                          <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mon</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> 
                <span class="n">str_mtim</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, m:</span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_mtim</span><span class="p">,</span> <span class="n">mon_list_lon</span><span class="p">[</span><span class="n">mon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux_mon</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">aux_mon</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aux_mon</span><span class="p">,</span><span class="n">mon_list_short</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mon</span><span class="p">]</span>
                <span class="n">aux_mon</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aux_mon</span><span class="p">)</span>
                <span class="n">str_mtim</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, m:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_mtim</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">aux_mon</span><span class="p">)</span> <span class="p">)</span>
        
        <span class="c1"># do time information string for day</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">day</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mon</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> 
                <span class="n">str_mtim</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, d:</span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_mtim</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">str_mtim</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, d:</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_mtim</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mon</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">str_mtim</span><span class="p">)</span>    </div>




<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___DO VERTICAL LEVEL SELECTION_______________________________________________</span>
<div class="viewcode-block" id="do_select_levidx">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_select_levidx">[docs]</a>
<span class="k">def</span> <span class="nf">do_select_levidx</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depidx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; select vertical levels based on depth list</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :data:      xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">        :mesh:      fesom2 mesh object</span>
<span class="sd">        </span>
<span class="sd">        :depth:     int, list, np.array, range (default=None). Select single</span>
<span class="sd">                    depth level that will be interpolated or select list of</span>
<span class="sd">                    depth levels that will be interpolated and vertically</span>
<span class="sd">                    averaged. If None all vertical layers in data are loaded</span>
<span class="sd">        </span>
<span class="sd">        :depidx:    bool, (default:False) if depth is int and depidx=True,</span>
<span class="sd">                    depth index is selected that is closest to depth. No</span>
<span class="sd">                    interpolation will be done</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :data:      xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># no depth selecetion at all</span>
    <span class="k">if</span>   <span class="p">(</span><span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> 
        <span class="n">str_ldep</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">str_ldep</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># found 3d data based on mid-depth levels (w, Kv,...) --&gt; compute </span>
    <span class="c1"># selection index</span>
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;nz1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># compute selection index either single layer of for interpolation </span>
        <span class="n">ndimax</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">sel_levidx</span> <span class="o">=</span> <span class="n">do_comp_sel_levidx</span><span class="p">(</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depidx</span><span class="p">,</span> <span class="n">ndimax</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________        </span>
        <span class="c1"># select vertical levels from data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nz1</span><span class="o">=</span><span class="n">sel_levidx</span><span class="p">)</span>        
        <span class="n">aux_strdep</span> <span class="o">=</span> <span class="s1">&#39;depidx&#39;</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># found 3d data based on full-depth levels (w, Kv,...) --&gt; compute </span>
    <span class="c1"># selection index</span>
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;nz&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>  
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># compute selection index either single layer of for interpolation </span>
        <span class="n">ndimax</span>  <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">sel_levidx</span> <span class="o">=</span> <span class="n">do_comp_sel_levidx</span><span class="p">(</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depidx</span><span class="p">,</span> <span class="n">ndimax</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________        </span>
        <span class="c1"># select vertical levels from data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nz</span><span class="o">=</span><span class="n">sel_levidx</span><span class="p">)</span>
        <span class="n">aux_strdep</span> <span class="o">=</span> <span class="s1">&#39;depidx&#39;</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># found 3d data based based on icepack thickness classes --&gt;</span>
    <span class="c1"># selection index</span>
    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;ncat&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>  
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># compute selection index either single layer of for interpolation </span>
        <span class="n">ndimax</span>  <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;ncat&#39;</span><span class="p">]</span>
        <span class="n">sel_levidx</span> <span class="o">=</span> <span class="n">do_comp_sel_levidx</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ndimax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depidx</span><span class="p">,</span> <span class="n">ndimax</span><span class="p">)</span>
        <span class="c1">#_______________________________________________________________________        </span>
        <span class="c1"># select vertical levels from data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ncat</span><span class="o">=</span><span class="n">sel_levidx</span><span class="p">)</span>    
        <span class="n">aux_strdep</span> <span class="o">=</span> <span class="s1">&#39;ncat&#39;</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># do depth information string</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">depidx</span><span class="p">:</span>
        <span class="k">if</span>   <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">str_ldep</span> <span class="o">=</span> <span class="s1">&#39;, dep:</span><span class="si">{}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">depth</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">range</span><span class="p">)):</span>   
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">str_ldep</span> <span class="o">=</span> <span class="s1">&#39;, dep:</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">depth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">str_ldep</span> <span class="o">=</span> <span class="s1">&#39;, dep:</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                
    <span class="k">elif</span> <span class="p">(</span><span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">depidx</span><span class="p">:</span>            
        <span class="n">str_ldep</span> <span class="o">=</span> <span class="s1">&#39;, </span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aux_strdep</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">depth</span><span class="p">))</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">str_ldep</span><span class="p">)</span></div>




<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___COMPUTE VERTICAL LEVEL SELECTION INDEX____________________________________</span>
<div class="viewcode-block" id="do_comp_sel_levidx">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_comp_sel_levidx">[docs]</a>
<span class="k">def</span> <span class="nf">do_comp_sel_levidx</span><span class="p">(</span><span class="n">zlev</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depidx</span><span class="p">,</span> <span class="n">ndimax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; compute level indices that are needed to interpolate the depth levels</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :zlev:          list, depth vector of the datas </span>
<span class="sd">        </span>
<span class="sd">        :depth:         list, with depth levels that should be interpolated</span>
<span class="sd">        </span>
<span class="sd">        :depidx:        bool, (default:False) if depth is int and depidx=True,</span>
<span class="sd">                        depth index is selected that is closest to depth. No  </span>
<span class="sd">                        interpolation will be done </span>
<span class="sd">        </span>
<span class="sd">        :ndimax:        int, maximum number of levels  mesh.n_iz.max()-1 for mid</span>
<span class="sd">                        depth datas, mesh.n_iz.max() for full level data</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :sel_levidx:    list, with level indices that should be extracted</span>
<span class="sd">        </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># select indices for vertical interpolation for single depth layer</span>
    <span class="k">if</span>   <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="c1"># select index closest to depth</span>
        <span class="k">if</span> <span class="n">depidx</span><span class="p">:</span>
            <span class="n">sel_levidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">zlev</span><span class="o">-</span><span class="n">depth</span><span class="p">))</span>
        <span class="c1"># select index for interpoaltion </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auxidx</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">zlev</span><span class="p">,</span><span class="n">depth</span><span class="p">)</span>
            <span class="k">if</span>   <span class="n">auxidx</span><span class="o">&gt;</span><span class="n">ndimax</span> <span class="p">:</span> <span class="n">sel_levidx</span> <span class="o">=</span> <span class="p">[</span><span class="n">ndimax</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ndimax</span><span class="p">]</span>       
            <span class="k">elif</span> <span class="n">auxidx</span><span class="o">&gt;=</span><span class="mi">1</span>     <span class="p">:</span> <span class="n">sel_levidx</span> <span class="o">=</span> <span class="p">[</span><span class="n">auxidx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">auxidx</span><span class="p">]</span>
            <span class="k">else</span>               <span class="p">:</span> <span class="n">sel_levidx</span> <span class="o">=</span> <span class="p">[</span><span class="n">auxidx</span><span class="p">,</span><span class="n">auxidx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>   
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># select indices for vertical interpolation for multiple defined </span>
    <span class="c1"># depth layer</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">range</span><span class="p">)):</span>   
        <span class="n">sel_levidx</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">depi</span> <span class="ow">in</span> <span class="n">depth</span><span class="p">:</span>
            <span class="n">auxidx</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">zlev</span><span class="p">,</span> <span class="n">depi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">auxidx</span><span class="o">&gt;</span><span class="n">ndimax</span> <span class="ow">and</span> <span class="n">ndimax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sel_levidx</span><span class="p">:</span> <span class="n">sel_levidx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndimax</span><span class="p">)</span>    
            <span class="k">if</span> <span class="n">auxidx</span><span class="o">&gt;=</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">auxidx</span><span class="o">-</span><span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sel_levidx</span><span class="p">:</span> <span class="n">sel_levidx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxidx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">auxidx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sel_levidx</span><span class="p">):</span> <span class="n">sel_levidx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxidx</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">auxidx</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sel_levidx</span><span class="p">):</span> <span class="n">sel_levidx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxidx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sel_levidx</span><span class="p">)</span></div>

    
    

<span class="c1">#</span>
<span class="c1">#    </span>
<span class="c1"># ___COMPUTE TIME ARITHMETICS ON DATA__________________________________________</span>
<div class="viewcode-block" id="do_time_arithmetic">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_time_arithmetic">[docs]</a>
<span class="k">def</span> <span class="nf">do_time_arithmetic</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_tarithm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; do arithmetic over time dimension</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :data:          xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">        :do_tarithm:    str (default=&#39;mean&#39;) do time arithmetic on time selection</span>
<span class="sd">                        option are</span>
<span class="sd">                        </span>
<span class="sd">                        - None, &#39;None&#39;</span>
<span class="sd">                        - &#39;mean&#39; mean over entire time dimension</span>
<span class="sd">                        - &#39;median&#39; </span>
<span class="sd">                        - &#39;std&#39;</span>
<span class="sd">                        - &#39;var&#39;</span>
<span class="sd">                        - &#39;max&#39;, </span>
<span class="sd">                        - &#39;min&#39;, </span>
<span class="sd">                        - &#39;sum&#39;</span>
<span class="sd">                        - &#39;ymean&#39;,&#39;annual&#39; mean over year dimension</span>
<span class="sd">                        - &#39;mmean&#39;,&#39;monthly&#39; mean over month dimension</span>
<span class="sd">                        - &#39;dmean&#39;,&#39;daily&#39; mean over day dimension</span>

<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :data:          xarray dataset object</span>
<span class="sd">    </span>
<span class="sd">        :str_atim:      str, which time arithmetic was applied </span>
<span class="sd">        </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">str_atim</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">do_tarithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        
        <span class="n">str_atim</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">do_tarithm</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">if</span>   <span class="n">do_tarithm</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>  <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">do_tarithm</span><span class="o">==</span><span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">do_tarithm</span><span class="o">==</span><span class="s1">&#39;std&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        
        <span class="k">elif</span> <span class="n">do_tarithm</span><span class="o">==</span><span class="s1">&#39;var&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">var</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>       
        
        <span class="k">elif</span> <span class="n">do_tarithm</span><span class="o">==</span><span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">do_tarithm</span><span class="o">==</span><span class="s1">&#39;min&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
        
        <span class="k">elif</span> <span class="n">do_tarithm</span><span class="o">==</span><span class="s1">&#39;sum&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># yearly means </span>
        <span class="k">elif</span> <span class="n">do_tarithm</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ymean&#39;</span><span class="p">,</span><span class="s1">&#39;annual&#39;</span><span class="p">]:</span>
            <span class="kn">import</span> <span class="nn">datetime</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
            <span class="c1"># recreate time axes based on year</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename_dims</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="s1">&#39;time&#39;</span><span class="p">})</span>
            
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sending large graph of size&quot;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Large object of size </span><span class="se">\\</span><span class="s2">d+</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">d+ detected in task graph&quot;</span><span class="p">)</span>
            
            <span class="n">aux_time</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">cftime_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">-01-01&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;YS&#39;</span><span class="p">)</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">aux_time</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">aux_time</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">resetwarnings</span><span class="p">()</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># monthly means --&gt; seasonal cycle </span>
        <span class="k">elif</span> <span class="n">do_tarithm</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mmean&#39;</span><span class="p">,</span><span class="s1">&#39;monthly&#39;</span><span class="p">]:</span>
            <span class="kn">import</span> <span class="nn">datetime</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
            <span class="c1"># recreate time axes based on year</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename_dims</span><span class="p">({</span><span class="s1">&#39;month&#39;</span><span class="p">:</span><span class="s1">&#39;time&#39;</span><span class="p">})</span>
            
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sending large graph of size&quot;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Large object of size </span><span class="se">\\</span><span class="s2">d+</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">d+ detected in task graph&quot;</span><span class="p">)</span>
            
            <span class="n">aux_time</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">cftime_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;0001-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">)</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">aux_time</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">aux_time</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">resetwarnings</span><span class="p">()</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># daily means --&gt; 1...365</span>
        <span class="k">elif</span> <span class="n">do_tarithm</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dmean&#39;</span><span class="p">,</span><span class="s1">&#39;daily&#39;</span><span class="p">]:</span>
            <span class="kn">import</span> <span class="nn">datetime</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.day&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
            <span class="c1"># recreate time axes based on year</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename_dims</span><span class="p">({</span><span class="s1">&#39;day&#39;</span><span class="p">:</span><span class="s1">&#39;time&#39;</span><span class="p">})</span>
            
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sending large graph of size&quot;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Large object of size </span><span class="se">\\</span><span class="s2">d+</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">d+ detected in task graph&quot;</span><span class="p">)</span>
            
            <span class="n">aux_time</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">cftime_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;0001-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;DS&#39;</span><span class="p">)</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">)</span>
            <span class="n">data</span>     <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">aux_time</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">aux_time</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">resetwarnings</span><span class="p">()</span>
        
        <span class="k">elif</span> <span class="n">do_tarithm</span><span class="o">==</span><span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="o">...</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39; the time arithmetic of do_tarithm=</span><span class="si">{}</span><span class="s1"> is not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">do_tarithm</span><span class="p">)))</span> 
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">str_atim</span><span class="p">)</span></div>




<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___COMPUTE HORIZONTAL ARITHMETICS ON DATA____________________________________</span>
<div class="viewcode-block" id="do_horiz_arithmetic">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_horiz_arithmetic">[docs]</a>
<span class="k">def</span> <span class="nf">do_horiz_arithmetic</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_harithm</span><span class="p">,</span> <span class="n">dim_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; do arithmetic on depth dimension</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>

<span class="sd">        :data:          xarray dataset object</span>

<span class="sd">        :do_harithm:    str (default=&#39;mean&#39;) do arithmetic on selected vertical</span>
<span class="sd">                        layers options are</span>
<span class="sd">                        </span>
<span class="sd">                        - None, &#39;None&#39;</span>
<span class="sd">                        - &#39;mean&#39;  ... arithmetic mean </span>
<span class="sd">                        - &#39;median&#39;</span>
<span class="sd">                        - &#39;std&#39;</span>
<span class="sd">                        - &#39;var&#39;</span>
<span class="sd">                        - &#39;max&#39; </span>
<span class="sd">                        - &#39;min&#39;</span>
<span class="sd">                        - &#39;sum&#39;   ... arithmetic sum </span>
<span class="sd">                        - &#39;wint&#39;  ... weighted horizontal integral int( DATA*dxdy)</span>
<span class="sd">                        - &#39;wmean&#39; ... weighted horizontal mean</span>

<span class="sd">        :dim_name:      str, name of depth dimension, is different for full-level</span>
<span class="sd">                        and mid-level data</span>

<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :data:          xarray dataset object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">do_harithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        
        <span class="k">if</span>   <span class="n">do_harithm</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>  <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">do_harithm</span><span class="o">==</span><span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">do_harithm</span><span class="o">==</span><span class="s1">&#39;std&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        
        <span class="k">elif</span> <span class="n">do_harithm</span><span class="o">==</span><span class="s1">&#39;var&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">var</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>       
        
        <span class="k">elif</span> <span class="n">do_harithm</span><span class="o">==</span><span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">do_harithm</span><span class="o">==</span><span class="s1">&#39;min&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
        
        <span class="k">elif</span> <span class="n">do_harithm</span><span class="o">==</span><span class="s1">&#39;sum&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>            
        
        <span class="k">elif</span> <span class="n">do_harithm</span><span class="o">==</span><span class="s1">&#39;wint&#39;</span><span class="p">:</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>      
        
        <span class="k">elif</span> <span class="n">do_harithm</span><span class="o">==</span><span class="s1">&#39;wmean&#39;</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;w_A&#39;</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">/</span><span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">*</span><span class="n">weights</span>
            <span class="k">del</span> <span class="n">weights</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">do_harithm</span><span class="o">==</span><span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">do_zarithm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="o">...</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39; the time arithmetic of do_tarithm=</span><span class="si">{}</span><span class="s1"> is not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">do_tarithm</span><span class="p">)))</span> 
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>



<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___COMPUTE DEPTH ARITHMETICS ON DATA_________________________________________</span>
<div class="viewcode-block" id="do_depth_arithmetic">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_depth_arithmetic">[docs]</a>
<span class="k">def</span> <span class="nf">do_depth_arithmetic</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_zarithm</span><span class="p">,</span> <span class="n">dim_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; do arithmetic on depth dimension</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :data:          xarray dataset object </span>

<span class="sd">        :do_zarithm:    str (default=&#39;mean&#39;) do arithmetic on selected vertical</span>
<span class="sd">                        layers options are</span>
<span class="sd">                        </span>
<span class="sd">                        - None, &#39;None&#39;</span>
<span class="sd">                        - &#39;mean&#39; </span>
<span class="sd">                        - &#39;max&#39; </span>
<span class="sd">                        - &#39;min&#39;</span>
<span class="sd">                        - &#39;sum&#39;</span>
<span class="sd">                        - &#39;wint&#39;</span>
<span class="sd">                        - &#39;wmean&#39;</span>
<span class="sd"> </span>
<span class="sd">        :dim_name:      str, name of depth dimension, is different for full-level</span>
<span class="sd">                        and mid-level data</span>
<span class="sd"> </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :data:   xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">do_zarithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        
        <span class="k">if</span>   <span class="n">do_zarithm</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">do_zarithm</span><span class="o">==</span><span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">do_zarithm</span><span class="o">==</span><span class="s1">&#39;min&#39;</span><span class="p">:</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
        
        <span class="k">elif</span> <span class="n">do_zarithm</span><span class="o">==</span><span class="s1">&#39;sum&#39;</span><span class="p">:</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">do_zarithm</span><span class="o">==</span><span class="s1">&#39;wint&#39;</span><span class="p">:</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;w_z&#39;</span><span class="p">]</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>   <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>          
        
        <span class="k">elif</span> <span class="n">do_zarithm</span><span class="o">==</span><span class="s1">&#39;wmean&#39;</span><span class="p">:</span>
            <span class="k">if</span>   <span class="p">(</span><span class="s1">&#39;nod2&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;w_z&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">weights</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;w_z&#39;</span><span class="p">]</span>
                
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">/</span><span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">*</span><span class="n">weights</span>
            <span class="n">data</span>    <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim_name</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
            <span class="k">del</span> <span class="n">weights</span>
        
        <span class="k">elif</span> <span class="n">do_zarithm</span><span class="o">==</span><span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">do_zarithm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="o">...</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39; the depth arithmetic of do_zarithm=</span><span class="si">{}</span><span class="s1"> is not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">do_zarithm</span><span class="p">)))</span> 
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>




<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___COMPUTE GRID ROTATION OF VECTOR DATA______________________________________</span>
<div class="viewcode-block" id="do_vector_rotation">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_vector_rotation">[docs]</a>
<span class="k">def</span> <span class="nf">do_vector_rotation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">do_vec</span><span class="p">,</span> <span class="n">do_vecrot</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; compute roration of vector: vname=&#39;vec+u+v&#39;</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :data:          xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">        :mesh:          fesom2 mesh object</span>
<span class="sd">        </span>
<span class="sd">        :do_vec:        bool, should data be considered as vectors</span>
<span class="sd">        </span>
<span class="sd">        :do_vecrot:     bool, should rotation be applied</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :data:          xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">do_vec</span> <span class="ow">and</span> <span class="n">do_vecrot</span><span class="p">:</span>
        <span class="c1"># which varaibles are in data, must be two to compute vector rotation</span>
        <span class="n">vname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="c1"># vector data are on vertices </span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;nod2&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;node&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &gt; do nod2 vector rotation&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>\
            <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">vec_r2g</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">abg</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">,</span> 
                                        <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
                                        <span class="n">gridis</span><span class="o">=</span><span class="s1">&#39;geo&#39;</span> <span class="p">)</span>
        
        <span class="c1"># vector data are on elements</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &gt; do elem vector rotation&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>\
            <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">vec_r2g</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">abg</span><span class="p">,</span> 
                                        <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> 
                                        <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> 
                                        <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
                                        <span class="n">gridis</span><span class="o">=</span><span class="s1">&#39;geo&#39;</span> <span class="p">)</span>  
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>




<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___COMPUTE NORM OF VECTOR DATA_______________________________________________</span>
<div class="viewcode-block" id="do_vector_norm">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_vector_norm">[docs]</a>
<span class="k">def</span> <span class="nf">do_vector_norm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_norm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; compute vector norm: vname=&#39;vec+u+v&#39;</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :data:      xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">        :do_norm:   bool, should vector norm be computed</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :data:      xarray dataset object</span>
<span class="sd">    </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">do_norm</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &gt; do compute norm&#39;</span><span class="p">)</span>
        <span class="c1"># which varaibles are in data, must be two to compute norm</span>
        <span class="n">vname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="c1"># rename variable vname</span>
        <span class="n">new_vname</span> <span class="o">=</span> <span class="s1">&#39;norm+</span><span class="si">{}</span><span class="s1">+</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vname</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vname</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1">## estimate chunksize</span>
        <span class="c1">#if   &#39;nod2&#39; in data.dims: dim_horz   = &#39;nod2&#39;            </span>
        <span class="c1">#elif &#39;elem&#39; in data.dims: dim_horz   = &#39;elem&#39;</span>
        <span class="c1">#chunkssize = data.chunksizes[dim_horz]</span>
        
        <span class="c1"># compute norm in variable  vname</span>
        <span class="c1">#data[vname[0] ].data = np.sqrt(data[vname[0]].data**2 + data[vname[1]].data**2)</span>
        <span class="c1">#data[vname[0] ] = np.sqrt(np.square(data[vname[0]]) + np.square(data[vname[1]]))</span>
        <span class="c1">#data[new_vname] = np.sqrt(data[vname[0]].data**2 + data[vname[1]].data**2)</span>
        <span class="c1">#data[new_vname] = xr.DataArray(np.sqrt(np.square(data[vname[0]].data) + np.square(data[vname[1]].data)), dims=[dim_horz]).chunk(chunkssize)</span>
        
        <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="p">)</span>
        
        <span class="c1"># rename variable vname[0]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">vname</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">new_vname</span><span class="p">})</span>
        
        <span class="c1"># delet variable vname2 from Dataset</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="n">vname</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
 
    <span class="c1">#___________________________________________________________________________    </span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  </div>



<span class="c1">##</span>
<span class="c1">##</span>
<span class="c1">##</span>
<span class="c1">## ___COMPUTE LOGARYTHMIC RESCALING_____________________________________________</span>
<span class="c1">#def do_rescaling(data, do_rescale):</span>
    <span class="c1">#&quot;&quot;&quot;</span>
    <span class="c1">#compute vector norm: vname=&#39;vec+u+v&#39;</span>
    
    <span class="c1">#Parameters: </span>
    
        <span class="c1">#:data:          xarray dataset object</span>
        
        <span class="c1">#:do_rescale:    string &#39;log10&#39;</span>
        
    <span class="c1">#Returns:</span>

        <span class="c1">#:data:          xarray dataset object</span>
    <span class="c1">#____________________________________________________________________________</span>
    <span class="c1">#&quot;&quot;&quot;</span>
    <span class="c1">#if do_rescale==&#39;log10&#39;:</span>
        <span class="c1">#print(&#39; &gt; do compute log10 rescaling&#39;)</span>
        <span class="c1">## which varaibles are in data, must be two to compute norm</span>
        <span class="c1">#vname = list(data.keys())[0]</span>
        
        <span class="c1">## compute log10</span>
        <span class="c1">##data[vname] = xr.ufuncs.log10(data[vname])</span>
        <span class="c1">#attr_glob = data.attrs        # rescue global attributes --&gt; get lost with xr.where</span>
        <span class="c1">#attr_loc  = data[vname].attrs # rescue local  attributes --&gt; get lost with xr.where </span>
        <span class="c1">#data = xr.where(data!=0, xr.ufuncs.log10(data), 0.0)</span>
        <span class="c1">#data.attrs        = attr_glob # put back global attributes</span>
        <span class="c1">#data[vname].attrs = attr_loc  # put back local  attributes</span>
        
        <span class="c1">## set attribute for rescaling</span>
        <span class="c1">#data[vname].attrs[&#39;do_rescale&#39;] = &#39;log10()&#39;</span>
        
    <span class="c1">##___________________________________________________________________________    </span>
    <span class="c1">#return(data)  </span>



<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___COMPUTE NORM OF VECTOR DATA_______________________________________________</span>
<div class="viewcode-block" id="do_potential_density">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_potential_density">[docs]</a>
<span class="k">def</span> <span class="nf">do_potential_density</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">do_pdens</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">vname2</span><span class="p">,</span> <span class="n">vname_tmp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; compute potential density based on temp and salt</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :data:      xarray dataset object, containing temperature and salinity data</span>
<span class="sd">        </span>
<span class="sd">        :do_pdens:  bool, should potential densitz be compute_boundary_edges</span>
<span class="sd">        </span>
<span class="sd">        :vname:     str, name of temperature variable in dataset</span>
<span class="sd">        </span>
<span class="sd">        :vname2:    str, name of salinity variable in dataset</span>
<span class="sd">        </span>
<span class="sd">        :vname_tmp: str, which potential density should be computed</span>
<span class="sd">                    - &#39;sigma0&#39;  ... pref=0</span>
<span class="sd">                    - &#39;sigma1&#39;  ... pref=1000</span>
<span class="sd">                    - &#39;sigma2&#39;  ... pref=2000</span>
<span class="sd">                    - &#39;sigma3&#39;  ... pref=3000</span>
<span class="sd">                    - &#39;sigma4&#39;  ... pref=4000</span>
<span class="sd">                    - &#39;sigma5&#39;  ... pref=5000</span>
<span class="sd">                    </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :data:      xarray dataset object, containing potential density</span>
<span class="sd">        </span>
<span class="sd">        :vname:     str, string with variable name of potential density</span>
<span class="sd">        </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">do_pdens</span><span class="p">:</span>
        <span class="n">pref</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span>   <span class="n">vname_tmp</span> <span class="o">==</span> <span class="s1">&#39;sigma&#39;</span> <span class="ow">or</span> <span class="n">vname_tmp</span> <span class="o">==</span> <span class="s1">&#39;sigma0&#39;</span>  <span class="p">:</span> <span class="n">pref</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">elif</span> <span class="n">vname_tmp</span> <span class="o">==</span> <span class="s1">&#39;sigma1&#39;</span> <span class="p">:</span> <span class="n">pref</span><span class="o">=</span><span class="mi">1000</span>
        <span class="k">elif</span> <span class="n">vname_tmp</span> <span class="o">==</span> <span class="s1">&#39;sigma2&#39;</span> <span class="p">:</span> <span class="n">pref</span><span class="o">=</span><span class="mi">2000</span>
        <span class="k">elif</span> <span class="n">vname_tmp</span> <span class="o">==</span> <span class="s1">&#39;sigma3&#39;</span> <span class="p">:</span> <span class="n">pref</span><span class="o">=</span><span class="mi">3000</span>
        <span class="k">elif</span> <span class="n">vname_tmp</span> <span class="o">==</span> <span class="s1">&#39;sigma4&#39;</span> <span class="p">:</span> <span class="n">pref</span><span class="o">=</span><span class="mi">4000</span>
        <span class="k">elif</span> <span class="n">vname_tmp</span> <span class="o">==</span> <span class="s1">&#39;sigma5&#39;</span> <span class="p">:</span> <span class="n">pref</span><span class="o">=</span><span class="mi">5000</span>
        
        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">data_depth</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nz1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="nb">dict</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="s1">&#39;nod2&#39;</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;nod2&#39;</span><span class="p">]}))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_depth</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nz1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="nb">dict</span><span class="p">({</span><span class="s1">&#39;nod2&#39;</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;nod2&#39;</span><span class="p">]}))</span>
            
        <span class="c1"># data = data.assign({vname_tmp: (list(data[vname].dims), sw.pden(data[vname2].data, data[vname].data, data_depth, pref)-1000.00)})</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">({</span><span class="n">vname_tmp</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">),</span> <span class="n">sw</span><span class="o">.</span><span class="n">dens</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pref</span><span class="p">)</span><span class="o">-</span><span class="mf">1000.00</span><span class="p">)})</span>
        
        <span class="k">del</span><span class="p">(</span><span class="n">data_depth</span><span class="p">)</span>
        
        <span class="n">data</span><span class="p">[</span><span class="n">vname_tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">vname_tmp</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        
        <span class="c1">#data = data.drop(labels=[vname, vname2])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="n">vname</span><span class="p">,</span> <span class="n">vname2</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="n">vname_tmp</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;kg/m^3&#39;</span>
        <span class="n">vname</span> <span class="o">=</span> <span class="n">vname_tmp</span>
        
    <span class="c1">#___________________________________________________________________________    </span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vname</span><span class="p">)</span>  </div>




<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___INTERPOLATE ELEMENTAL DATA TO VERTICES____________________________________</span>
<div class="viewcode-block" id="do_interp_e2n">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_interp_e2n">[docs]</a>
<span class="k">def</span> <span class="nf">do_interp_e2n</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">do_ie2n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; interpolate data on elements to vertices</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :data:      xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">        :mesh:      fesom2 mesh object   </span>
<span class="sd">        </span>
<span class="sd">        :do_ie2n:   bool, True/False if interpolation should be applied</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        </span>
<span class="sd">        :data:      xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># which variables are stored in dataset</span>
    <span class="n">vname_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">vname_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="ow">and</span> <span class="n">do_ie2n</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &gt; do interpolation e2n&#39;</span><span class="p">)</span>
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="n">vname_list</span><span class="p">:</span>
            <span class="c1"># interpolate elem to vertices</span>
            <span class="c1">#aux = grid_interp_e2n(mesh,data[vname].data)</span>
            <span class="c1">#with np.errstate(divide=&#39;ignore&#39;,invalid=&#39;ignore&#39;):</span>
            <span class="n">aux</span> <span class="o">=</span> <span class="n">grid_interp_e2n</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            
            <span class="c1"># new variable name </span>
            <span class="n">vname_new</span> <span class="o">=</span> <span class="s1">&#39;n_&#39;</span><span class="o">+</span><span class="n">vname</span>
            
            <span class="c1"># add vertice interpolated variable to dataset</span>
            <span class="c1">#print(data)</span>
            <span class="k">if</span>   <span class="s1">&#39;nz&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span> <span class="n">data</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="n">vname_new</span><span class="p">:</span> <span class="p">(</span> <span class="p">[</span><span class="s1">&#39;nod2&#39;</span><span class="p">,</span><span class="s1">&#39;nz&#39;</span><span class="p">],</span><span class="n">aux</span><span class="p">)})],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;nz1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span> <span class="n">data</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="n">vname_new</span><span class="p">:</span> <span class="p">(</span> <span class="p">[</span><span class="s1">&#39;nod2&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">],</span><span class="n">aux</span><span class="p">)})],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span> <span class="n">data</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="n">vname_new</span><span class="p">:</span> <span class="p">(</span> <span class="s1">&#39;nod2&#39;</span><span class="p">,</span><span class="n">aux</span><span class="p">)})],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>
            <span class="c1"># copy attributes from elem to vertice variable </span>
            <span class="n">data</span><span class="p">[</span><span class="n">vname_new</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
            
            <span class="c1"># delete elem variable from dataset</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>

            <span class="k">del</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span>
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># kick out element related coordinates </span>
        <span class="k">for</span> <span class="n">coordi</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">coordi</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="n">coordi</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># enter area weights for nodes</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">do_gridinfo_and_weights</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">do_hweight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_zweight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>




<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___PUT ADDITIONAL VARIABLE INFORMATION INTO ATTRIBUTES_______________________</span>
<div class="viewcode-block" id="do_additional_attrs">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_additional_attrs">[docs]</a>
<span class="k">def</span> <span class="nf">do_additional_attrs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">attr_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; write additional information to variable attributes</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :data:      xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">        :vname:     str, (default: None), variable name that should be loaded</span>
<span class="sd">        </span>
<span class="sd">        :attr_dict: dict with different infos that are written to dataset </span>
<span class="sd">                    variable attributes</span>
<span class="sd">        </span>
<span class="sd">    Returns:    </span>

<span class="sd">        :data:      xarray dataset object</span>

<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attr_dict</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        
    <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;long_name&#39;</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>




<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ___DO ANOMALY________________________________________________________________</span>
<div class="viewcode-block" id="do_anomaly">
<a class="viewcode-back" href="../../index.html#tripyview.sub_data.do_anomaly">[docs]</a>
<span class="k">def</span> <span class="nf">do_anomaly</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span><span class="n">data2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; compute anomaly between two xarray Datasets</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :data1:   xarray dataset object</span>

<span class="sd">        :data2:   xarray dataset object</span>

<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :anom:   xarray dataset object, data1-data2</span>

<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># copy datasets object </span>
    <span class="n">anom</span> <span class="o">=</span> <span class="n">data1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">data1_vname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">data2_vname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data2</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="c1">#for vname in list(anom.keys()):</span>
    <span class="k">for</span> <span class="n">vname</span><span class="p">,</span> <span class="n">vname2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data1_vname</span><span class="p">,</span> <span class="n">data2_vname</span><span class="p">):</span>
        <span class="c1"># do anomalous data </span>
        <span class="k">if</span> <span class="n">vname</span><span class="o">==</span><span class="s1">&#39;dmoc_zpos&#39;</span><span class="p">:</span>
            <span class="n">anom</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">anom</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">data2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            
        <span class="c1"># do anomalous attributes </span>
        <span class="n">attrs_data1</span> <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">attrs_data2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attrs_data1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">attrs_data1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">attrs_data2</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]:</span>
                   <span class="c1"># anom[vname].attrs[key] = &#39;anomalous &#39;+anom[vname].attrs[key]</span>
                   <span class="n">anom</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;anom. &#39;</span><span class="o">+</span><span class="n">anom</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
                   
                <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;short_name&#39;</span><span class="p">]:</span>
                   <span class="c1"># anom[vname].attrs[key] = &#39;anomalous &#39;+anom[vname].attrs[key]</span>
                   <span class="n">anom</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;anom. &#39;</span><span class="o">+</span><span class="n">anom</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>    
                   
                <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]:</span> 
                    <span class="k">continue</span>
                
                <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;descript&#39;</span><span class="p">]:</span> 
                    <span class="c1"># print(len(data1[vname].attrs[key])+len(data2[vname2].attrs[key]))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">75</span><span class="p">:</span>
                        <span class="n">anom</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> - &#39;</span><span class="o">+</span><span class="n">data2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>     
                        <span class="n">anom</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="n">data2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        
                <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;do_rescale&#39;</span><span class="p">]:</span> 
                    <span class="n">anom</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>    
                    
                <span class="k">elif</span> <span class="n">data1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">anom</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="n">data2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">anom</span><span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          
          <h3>Table of Contents</h3>
          
          <search role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
            </form>
          </search>

        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="Related">
            <a href="../../py-modindex.html" title="Python Module Index"
              >modules</a> |
            <a href="../../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Patrick Scholz.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>