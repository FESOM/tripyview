<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tripyview.sub_transect &#8212; tripyview 0.3.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/agogo.css?v=8513425a" />
    <script src="../../_static/documentation_options.js?v=e259d695"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../../index.html">tripyview 0.3.0 documentation</a></div>
        <div class="rel" role="navigation" aria-label="Related">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for tripyview.sub_transect</h1><div class="highlight"><pre>
<span></span><span class="c1"># Patrick Scholz, 23.01.2018</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w">                    </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w">                     </span><span class="k">as</span><span class="w"> </span><span class="nn">clock</span>
<span class="kn">from</span><span class="w">   </span><span class="nn">scipy.signal</span><span class="w">             </span><span class="kn">import</span> <span class="n">convolve2d</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pylab</span><span class="w">         </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w">   </span><span class="nn">matplotlib.ticker</span><span class="w">        </span><span class="kn">import</span> <span class="n">MultipleLocator</span><span class="p">,</span> <span class="n">AutoMinorLocator</span><span class="p">,</span> <span class="n">ScalarFormatter</span>
<span class="kn">from</span><span class="w">   </span><span class="nn">matplotlib.colors</span><span class="w">        </span><span class="kn">import</span> <span class="n">ListedColormap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patheffects</span><span class="w">   </span><span class="k">as</span><span class="w"> </span><span class="nn">path_effects</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fnmatch</span>
<span class="kn">from</span><span class="w">   </span><span class="nn">.sub_mesh</span><span class="w">                </span><span class="kn">import</span> <span class="o">*</span> 
<span class="kn">from</span><span class="w">   </span><span class="nn">.sub_data</span><span class="w">                </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w">   </span><span class="nn">.sub_plot</span><span class="w">                </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w">   </span><span class="nn">.sub_utility</span><span class="w">             </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w">   </span><span class="nn">.sub_colormap</span><span class="w">            </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="c1">#xr.set_options(enable_cftimeindex=True)</span>

<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________</span>
<span class="c1"># --&gt; pre-analyse defined tranects</span>
<div class="viewcode-block" id="do_analyse_transects">
<a class="viewcode-back" href="../../index.html#tripyview.sub_transect.do_analyse_transects">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">do_analyse_transects</span><span class="p">(</span><span class="n">input_transect</span>     <span class="p">,</span> 
                        <span class="n">mesh</span>                <span class="p">,</span> 
                        <span class="n">edge</span>                <span class="p">,</span> 
                        <span class="n">edge_tri</span>            <span class="p">,</span> 
                        <span class="n">edge_dxdy_l</span>         <span class="p">,</span> 
                        <span class="n">edge_dxdy_r</span>         <span class="p">,</span> 
                        <span class="n">do_rot</span>      <span class="o">=</span> <span class="kc">False</span> <span class="p">,</span> 
                        <span class="n">do_info</span>     <span class="o">=</span> <span class="kc">False</span> <span class="p">,</span> 
                        <span class="n">Pdxy</span>        <span class="o">=</span> <span class="mf">10.0</span>  
                        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; pre-analyse defined transects, with respect to which triangles and edges </span>
<span class="sd">        are crossed by the transect line. Create transport path edge to compute </span>
<span class="sd">        modell accurate volume transports.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:   </span>
<span class="sd">    </span>
<span class="sd">        :input_transect:    list, to define transects, transects= [[[lon pts], </span>
<span class="sd">                            [lat pts], name, inverse_flowdir], [...]]. With inverse_flowdir</span>
<span class="sd">                            = True you can inverse the flowdirection if it doesnt </span>
<span class="sd">                            agree with your in/out flow direction</span>
<span class="sd">        </span>
<span class="sd">        :mesh:              fesom2 mesh object, with all mesh information</span>
<span class="sd">        </span>
<span class="sd">        :edge:              np.array([2, nedges]), edge array with indices of participating vertice </span>
<span class="sd">                            points. Best load info from fesom.mesh.diag.nc</span>
<span class="sd">        </span>
<span class="sd">        :edge_tri:          np.array([2, nedges]), edge triangle array of indices of triangles that </span>
<span class="sd">                            participate in the edge  [2 x nedges]. If edge is boundary</span>
<span class="sd">                            edge edge_tri[1, idx] = -1. Best load info from fesom.mesh.diag.nc</span>
<span class="sd">                            </span>
<span class="sd">        :edge_dxdy_l:       np.array([2, nedges]), array with dx, dy cartesian length of distance from </span>
<span class="sd">                            edge mid points to centroid of left side triangle from </span>
<span class="sd">                            edge. Best load info from fesom.mesh.diag.nc</span>
<span class="sd">                            </span>
<span class="sd">        :edge_dxdy_r:       np.array([2, nedges]), array with dx, dy cartesian length of distance from </span>
<span class="sd">                            edge mid points to centroid of right side triangle from </span>
<span class="sd">                            edge. Best load info from fesom.mesh.diag.nc  </span>
<span class="sd">                            </span>
<span class="sd">        :do_rot:            bool, (default=True) assume that the the edge_dxdy_l, </span>
<span class="sd">                            edge_dxdy_r arrays are in the rotated coordinate frame</span>
<span class="sd">                            and needed to be rotated into geo coordinates</span>
<span class="sd">                            </span>
<span class="sd">        :do_info:           bool, (default=False) print info of transect dictionary</span>
<span class="sd">        </span>
<span class="sd">        :Pdxy:              float, (default=15) buffer lon/lat width of lon/lat box around transect</span>
<span class="sd">                            for preselection of cutted edges within this box. On </span>
<span class="sd">                            very coarse meshes if it looks like that certain edges </span>
<span class="sd">                            are not cutted increase this number </span>

<span class="sd">    Return:</span>
<span class="sd">    </span>
<span class="sd">        :transect_list:     list of transect dictionary </span>
<span class="sd">        </span>
<span class="sd">    transect dictionary keys:    </span>
<span class="sd">    </span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        #_______________________________________________________________________</span>
<span class="sd">        # arrays that define cross-section </span>
<span class="sd">        transect[&#39;Name&#39;         ] = [] # Name of transect</span>
<span class="sd">        transect[&#39;lon&#39;          ] = [] # transect defining longitude list</span>
<span class="sd">        transect[&#39;lat&#39;          ] = [] # transect defining latitude list</span>
<span class="sd">        transect[&#39;ncsi&#39;         ] = [] # running index of number of defined transects</span>
<span class="sd">        transect[&#39;ncs&#39;          ] = [] # number transect defining points</span>
<span class="sd">        transect[&#39;Px&#39;           ] = [] # lon points  that define the transect edges </span>
<span class="sd">        transect[&#39;Py&#39;           ] = [] # lat points  that define the transect edges </span>
<span class="sd">        transect[&#39;e_vec&#39;        ] = [] # unit vector of transect edges</span>
<span class="sd">        transect[&#39;e_norm&#39;       ] = [] # length of unit vector (length of edge)</span>
<span class="sd">        transect[&#39;n_vec&#39;        ] = [] # normal vector of transect edges</span>
<span class="sd">        transect[&#39;alpha&#39;        ] = [] # bearing of transect edge</span>
<span class="sd">        </span>
<span class="sd">        #_______________________________________________________________________</span>
<span class="sd">        # arrays that define the intersection between cross-section and edges</span>
<span class="sd">        transect[&#39;edge_cut_i&#39;   ] = [] # indice of edges that are cutted by transect</span>
<span class="sd">        transect[&#39;edge_cut_evec&#39;] = [] # unit vector of those cutted edges</span>
<span class="sd">        transect[&#39;edge_cut_P&#39;   ] = [] # lon, lat point where transect cutted with edge</span>
<span class="sd">        transect[&#39;edge_cut_midP&#39;] = [] # mid points of cutted edge</span>
<span class="sd">        transect[&#39;edge_cut_lint&#39;] = [] # interpolator for cutting points on edge</span>
<span class="sd">        transect[&#39;edge_cut_ni&#39;  ] = [] # node indices of intersectted edges</span>
<span class="sd">        transect[&#39;edge_cut_dist&#39;] = [] # distance of cutted edge midpoint from start point of transect</span>
<span class="sd">        </span>
<span class="sd">        #_______________________________________________________________________</span>
<span class="sd">        # arrays to define transport path</span>
<span class="sd">        transect[&#39;path_xy&#39;      ] = [] # lon/lat coordinates, edge midpoints --&gt; elem centroid --&gt; edge mid points ...</span>
<span class="sd">        transect[&#39;path_ei&#39;      ] = [] # elem indices</span>
<span class="sd">        transect[&#39;path_ni&#39;      ] = [] # node indices of elems</span>
<span class="sd">        transect[&#39;path_cut_ni&#39;  ] = [] # node indices of edges  </span>
<span class="sd">        transect[&#39;path_dx&#39;      ] = [] # dx of path sections</span>
<span class="sd">        transect[&#39;path_dy&#39;      ] = [] # dy of path sections</span>
<span class="sd">        transect[&#39;path_dist&#39;    ] = [] # dy of path sections</span>
<span class="sd">        transect[&#39;path_nvec_cs&#39; ] = [] # normal vector of transection segment</span>
<span class="sd">    </span>
<span class="sd">    ____________________________________________________________________________</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transect_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># loop over transects in list</span>
    <span class="k">for</span> <span class="n">transec_ii</span> <span class="ow">in</span> <span class="n">input_transect</span><span class="p">:</span>
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transec_ii</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> 
            <span class="n">transec_lon</span><span class="p">,</span> <span class="n">transec_lat</span><span class="p">,</span> <span class="n">transec_name</span> <span class="o">=</span> <span class="n">transec_ii</span>
            <span class="n">transec_flowdir</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">transec_ii</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> 
            <span class="n">transec_lon</span><span class="p">,</span> <span class="n">transec_lat</span><span class="p">,</span> <span class="n">transec_name</span><span class="p">,</span> <span class="n">transec_flowdir</span> <span class="o">=</span> <span class="n">transec_ii</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;--&gt; trasect definition must be: [ [lon], [lat], transect-name, inverse_flowdir(optional) ] &#39;</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># allocate dictionary for total cross-section </span>
        <span class="n">sub_transect</span> <span class="o">=</span> <span class="n">_do_init_transect</span><span class="p">()</span>
        <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transec_name</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># fix orientation of section </span>
        <span class="n">auxx</span><span class="p">,</span> <span class="n">auxy</span> <span class="o">=</span> <span class="n">transec_lon</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">transec_lon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transec_lat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">transec_lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">auxn</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">auxx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">auxy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">auxx</span><span class="p">,</span> <span class="n">auxy</span> <span class="o">=</span> <span class="n">auxx</span><span class="o">/</span><span class="n">auxn</span><span class="p">,</span> <span class="n">auxy</span><span class="o">/</span><span class="n">auxn</span>
        <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;e_vec_tot&#39;</span>    <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">auxx</span><span class="p">,</span> <span class="n">auxy</span><span class="p">]</span>
        <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;n_vec_tot&#39;</span>    <span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">auxy</span><span class="p">,</span> <span class="n">auxx</span><span class="p">]</span>
        
        <span class="n">alpha</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">auxy</span><span class="p">,</span><span class="n">auxx</span><span class="p">)</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;alpha_tot&#39;</span>    <span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="k">if</span> <span class="n">alpha</span><span class="o">&gt;=-</span><span class="mi">180</span> <span class="ow">and</span> <span class="n">alpha</span><span class="o">&lt;=-</span><span class="mi">90</span><span class="p">:</span>
            <span class="n">transec_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">transec_lon</span><span class="p">)</span>
            <span class="n">transec_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">transec_lat</span><span class="p">)</span>
            <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;e_vec_tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;e_vec_tot&#39;</span><span class="p">]</span>
            <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;n_vec_tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;n_vec_tot&#39;</span><span class="p">]</span>
        <span class="k">del</span><span class="p">(</span><span class="n">auxx</span><span class="p">,</span> <span class="n">auxy</span><span class="p">,</span> <span class="n">auxn</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">transec_lon</span>
        <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">transec_lat</span>
        <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;ncs&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">transec_lon</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># loop over transect points</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">transec_lon</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1">#print(&#39; --&gt; subtransect_ii&#39;, ii)</span>
            <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;ncsi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># points defining cross-section line</span>
            <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;Px&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">transec_lon</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">transec_lon</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;Py&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">transec_lat</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">transec_lat</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># compute unit and normal vector of cross-section line</span>
            <span class="n">sub_transect</span> <span class="o">=</span> <span class="n">_do_calc_csect_vec</span><span class="p">(</span><span class="n">sub_transect</span><span class="p">)</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># pre-limit edges based on min/max lon and lat points that form </span>
            <span class="c1"># cruise-line</span>
            <span class="c1">#Pdxy = 10.0</span>
            <span class="n">Pxmin</span><span class="p">,</span> <span class="n">Pxmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;Px&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;Px&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">Pymin</span><span class="p">,</span> <span class="n">Pymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;Py&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;Py&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="n">Pdx</span> <span class="p">,</span><span class="n">Pdy</span> <span class="o">=</span> <span class="n">Pdxy</span><span class="p">,</span> <span class="n">Pdxy</span>
            <span class="c1"># if section reaches into polar areas than increase the longitudinal width </span>
            <span class="c1"># of the buffer box around the transect</span>
            <span class="k">if</span> <span class="n">Pymin</span><span class="o">&lt;-</span><span class="mf">70.0</span> <span class="ow">or</span> <span class="n">Pymax</span><span class="o">&gt;</span><span class="mf">80.0</span><span class="p">:</span> <span class="n">Pdx</span><span class="o">=</span><span class="mf">180.0</span> 
            
            <span class="n">Pxmin</span><span class="p">,</span> <span class="n">Pxmax</span> <span class="o">=</span> <span class="n">Pxmin</span><span class="o">-</span><span class="n">Pdx</span><span class="p">,</span> <span class="n">Pxmax</span><span class="o">+</span><span class="n">Pdx</span>
            <span class="n">Pymin</span><span class="p">,</span> <span class="n">Pymax</span> <span class="o">=</span> <span class="n">Pymin</span><span class="o">-</span><span class="n">Pdy</span><span class="p">,</span> <span class="n">Pymax</span><span class="o">+</span><span class="n">Pdy</span>
            <span class="n">idx_edlimit</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">Pxmin</span> <span class="p">)</span> <span class="o">&amp;</span>  
                                     <span class="p">(</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">Pxmax</span> <span class="p">)</span> <span class="o">&amp;</span> 
                                     <span class="p">(</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">Pymin</span> <span class="p">)</span> <span class="o">&amp;</span>  
                                     <span class="p">(</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">Pymax</span> <span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">del</span><span class="p">(</span><span class="n">Pxmin</span><span class="p">,</span> <span class="n">Pxmax</span><span class="p">,</span> <span class="n">Pymin</span><span class="p">,</span> <span class="n">Pymax</span><span class="p">,</span> <span class="n">Pdx</span><span class="p">,</span> <span class="n">Pdy</span><span class="p">)</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># compute which edges are intersected by cross-section line </span>
            <span class="c1">#sub_transect = _do_find_intersected_edges(mesh, sub_transect, edge, idx_edlimit)</span>
            <span class="n">sub_transect</span> <span class="o">=</span> <span class="n">_do_find_intersected_edges_fast</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">sub_transect</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">idx_edlimit</span><span class="p">)</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># sort intersected edges after distance from cross-section start point</span>
            <span class="n">sub_transect</span> <span class="o">=</span> <span class="n">_do_sort_intersected_edges</span><span class="p">(</span><span class="n">sub_transect</span><span class="p">)</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># build transport path</span>
            <span class="n">sub_transect</span> <span class="o">=</span> <span class="n">_do_build_path</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">sub_transect</span><span class="p">,</span> <span class="n">edge_tri</span><span class="p">,</span> <span class="n">edge_dxdy_l</span><span class="p">,</span> <span class="n">edge_dxdy_r</span><span class="p">)</span>
            
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># combine all cross-section sub segments into a single cross-section line</span>
        <span class="n">transect</span> <span class="o">=</span> <span class="n">_do_concat_subtransects</span><span class="p">(</span><span class="n">sub_transect</span><span class="p">)</span>
        <span class="k">del</span><span class="p">(</span><span class="n">sub_transect</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________    </span>
        <span class="c1"># insert land pts (nan) when there are 2 onsecutive cutted boundary </span>
        <span class="n">transect</span> <span class="o">=</span> <span class="n">_do_insert_landpts</span><span class="p">(</span><span class="n">transect</span><span class="p">,</span> <span class="n">edge_tri</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________    </span>
        <span class="c1"># rotate path_dx and path_dy from rot --&gt; geo coordinates</span>
        <span class="k">if</span> <span class="n">do_rot</span><span class="p">:</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec_r2g</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">abg</span><span class="p">,</span> 
                                                        <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> 
                                                        <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span>
                                                        <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span><span class="p">])</span>
        
        <span class="c1">#_______________________________________________________________________    </span>
        <span class="c1"># rotate path_dx and path_dy from rot --&gt; geo coordinates</span>
        <span class="k">if</span> <span class="n">transec_flowdir</span><span class="p">:</span>
             <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span><span class="p">],</span> <span class="o">-</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span><span class="p">]</span>
             
        <span class="c1">#_______________________________________________________________________ </span>
        <span class="c1"># buld distance from start point array [km]</span>
        <span class="n">transect</span> <span class="o">=</span> <span class="n">_do_compute_distance_from_startpoint</span><span class="p">(</span><span class="n">transect</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">if</span> <span class="n">do_info</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; --&gt; Name:&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;edge_cut_i    =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;edge_cut_evec =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;edge_cut_P    =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;edge_cut_midP =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;edge_cut_lint =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;edge_cut_ni   =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;path_ei       =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span>      <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;path_ni       =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span>      <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;path_cut_ni   =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span>  <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;path_dx       =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span>      <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;path_dy       =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span>      <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;path_nvec_cs  =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_nvec_cs&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;path_xy       =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span>      <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;path_dist     =&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dist&#39;</span>    <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1">#_______________________________________________________________________  </span>
        <span class="c1">#if len(input_transect)&gt;1:</span>
        <span class="n">transect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transect</span><span class="p">)</span>
        <span class="c1">#else:</span>
            <span class="c1">#transect_list = transect</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">transect_list</span><span class="p">)</span></div>




<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_do_init_transect</span><span class="p">():</span>
    <span class="n">transect</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># arrays that define cross-section </span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span>         <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span>          <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span>          <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;ncsi&#39;</span>         <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;ncs&#39;</span>          <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Px&#39;</span>           <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Py&#39;</span>           <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;e_vec&#39;</span>        <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;e_norm&#39;</span>       <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;n_vec&#39;</span>        <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span>        <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;e_vec_tot&#39;</span>    <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;n_vec_tot&#39;</span>    <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;alpha_tot&#39;</span>    <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># arrays that define the intersection between cross-section and edges</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># arrays to define transport path</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># lon/lat coordinates, edge midpoints --&gt; elem centroid --&gt; edge mid points ...</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># elem indices</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># node indices of elems</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># node indices of elems </span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># dx of path sections</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># dy of path sections</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dist&#39;</span>    <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># dy of path sections</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_nvec_cs&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># normal vector of transection segment</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">transect</span><span class="p">)</span>



<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_do_concat_subtransects</span><span class="p">(</span><span class="n">sub_transect</span><span class="p">):</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># combine all cross-ection sub segments into a single cross-section</span>
    <span class="n">transect</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span>      <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span>      <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span>      <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span>  <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span>      <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span>      <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_nvec_cs&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_nvec_cs&#39;</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">if</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;ncs&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>    
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;ncs&#39;</span><span class="p">]):</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">][</span><span class="n">ii</span><span class="p">]))</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]))</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][</span><span class="n">ii</span><span class="p">]))</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]))</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]))</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">][</span><span class="n">ii</span><span class="p">]))</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span>      <span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span>      <span class="p">][</span><span class="n">ii</span><span class="p">]))</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span>      <span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span>      <span class="p">][</span><span class="n">ii</span><span class="p">]))</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span>  <span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span>  <span class="p">][</span><span class="n">ii</span><span class="p">]))</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span>      <span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span>      <span class="p">][</span><span class="n">ii</span><span class="p">]))</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span>      <span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span>      <span class="p">][</span><span class="n">ii</span><span class="p">]))</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_nvec_cs&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_nvec_cs&#39;</span> <span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_nvec_cs&#39;</span> <span class="p">][</span><span class="n">ii</span><span class="p">]))</span>
            
            <span class="c1"># if there are multiple subsection to one transect than the last point</span>
            <span class="c1"># of the previous subsection and the first point of the actual subsection </span>
            <span class="c1"># are identical so when they concatenated they are dublicated, therefor </span>
            <span class="c1"># the first point of a subsecuent subsection must be kicked out </span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span>      <span class="p">],</span> <span class="n">sub_transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span>      <span class="p">][</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="c1">#transect[&#39;path_xy&#39;      ] = np.vstack((transect[&#39;path_xy&#39;      ], sub_transect[&#39;path_xy&#39;      ][ii]))</span>
            
    <span class="k">del</span><span class="p">(</span><span class="n">sub_transect</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">transect</span><span class="p">)</span>



<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_do_calc_csect_vec</span><span class="p">(</span><span class="n">transect</span><span class="p">):</span>
    <span class="c1"># unit and norm vector of cross-section line</span>
    <span class="n">evec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Px&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Px&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> 
                      <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Py&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Py&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">enorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">evec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">evec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;e_vec&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evec</span><span class="o">/</span><span class="n">enorm</span><span class="p">)</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;e_norm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enorm</span><span class="p">)</span>
    
    <span class="c1"># normal vector --&gt; norm vector definition (-dy,dx) --&gt; shows to the </span>
    <span class="c1"># left of the e_vec</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;n_vec&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">evec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">evec</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">/</span><span class="n">enorm</span><span class="p">)</span>  
    <span class="k">del</span><span class="p">(</span><span class="n">evec</span><span class="p">,</span> <span class="n">enorm</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">transect</span><span class="p">)</span>



<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________</span>
<span class="c1">#                            3</span>
<span class="c1">#                            o</span>
<span class="c1">#                           /^</span>
<span class="c1">#                          /  \ vec_c</span>
<span class="c1">#             C1          /    \           C2</span>
<span class="c1">#              o---------/------\---------&gt;&gt;o  obj vec_C</span>
<span class="c1">#                  vec_b/        \</span>
<span class="c1">#                      v          \</span>
<span class="c1">#                     o-----------&gt;o</span>
<span class="c1">#                    1    vec_a    2</span>
<span class="c1">#</span>
<span class="c1">#          CALC: vec_C : (C1x,C1y) + rc (C2x-C1x,C2y-C1y)</span>
<span class="c1">#                vec_a : (P1x,P1y) + ra (P2x-P1x,P2y-P1y)</span>
<span class="c1">#                vec_b : ...</span>
<span class="c1">#                vec_c : ...</span>
<span class="c1">#               - cross-section of vec_C and vec_a --&gt; Vectoralgebra</span>
<span class="c1">#</span>
<span class="c1">#                (C1x) + rc (C2x-C1x) =  (P1x) + ra (P2x-P1x)</span>
<span class="c1">#                (C1y) + rc (C2y-C1y) =  (P1y) + ra (P2y-P1y)</span>
<span class="c1">#</span>
<span class="c1">#                / (P2x-P1x)  -(C2x-C1x) \   / ra \   / C1x-P1x \</span>
<span class="c1">#                \ (P2y-P1y)  -(C2y-C1y) / * \ rc / = \ C1y-P1y /</span>
<span class="c1">#</span>
<span class="c1">#                            A             *   X    =      P    </span>
<span class="c1">#</span>
<span class="c1">#               - same for cross-section of vec_C and vec_b &amp; vec_C</span>
<span class="c1">#                 and vec_c</span>
<span class="c1">#                 A[2x2] * X[2x1] = P[2x1] --&gt; solve for X = inv(A)*P</span>
<span class="c1">#                 X[0,0] --&gt; norm of vectors until the points where its </span>
<span class="c1">#                 intersected. If |X[0,0]| &gt; |vec_a| than edge is not intersected</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_do_find_intersected_edges</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">transect</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">idx_ed</span><span class="p">):</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">P</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;e_vec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;e_vec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># loop over indices of edges--&gt;use already lon,lat limited edge indices </span>
    <span class="c1">#plt.figure()</span>
        
    <span class="k">for</span> <span class="n">edi</span> <span class="ow">in</span> <span class="n">idx_ed</span><span class="p">:</span>
        
        <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">edi</span><span class="p">]]</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">edi</span><span class="p">]]</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">edi</span><span class="p">]]</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">edi</span><span class="p">]]</span>
        <span class="n">normA0</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">A</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">normA0</span>
        <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Px&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">edi</span><span class="p">]]</span>
        <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Py&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">edi</span><span class="p">]]</span>
        
        <span class="c1"># solve linear equation system: A * X = P --&gt; solve for X[0]</span>
        <span class="n">div</span>     <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">X0</span>      <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span> <span class="n">div</span>
        <span class="n">X1</span>      <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/-</span><span class="n">div</span>
        
        <span class="c1"># determine if edge is intersected by crossection line</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">X0</span><span class="o">&gt;=</span><span class="mf">0.0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X0</span><span class="o">&lt;=</span><span class="n">normA0</span>                <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">X1</span><span class="o">&gt;=</span><span class="mf">0.0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X1</span><span class="o">&lt;=</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;e_norm&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span> <span class="p">):</span>
            <span class="c1"># indice of cutted edge</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edi</span><span class="p">)</span>
            
            <span class="c1"># evec of cutted edge </span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
            
            <span class="c1"># cutting point on edge</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">edi</span><span class="p">]]</span><span class="o">+</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X0</span><span class="p">,</span> 
                                                  <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">edi</span><span class="p">]]</span><span class="o">+</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X0</span><span class="p">])</span>
            
            <span class="c1"># mid point on edge</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">edi</span><span class="p">]]</span><span class="o">+</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">normA0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> 
                                                  <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">edi</span><span class="p">]]</span><span class="o">+</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">normA0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">])</span>
            
            <span class="c1"># interpolator for cutting points on edge Vcut= V1+(V2-V1)*(rc-r1)/(r2-r1)=V1+(V2-V1)*lint</span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X0</span><span class="o">/</span><span class="n">normA0</span><span class="p">)</span>
            
            <span class="c1"># node indices of intersectted edges </span>
            <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">[:,</span><span class="n">edi</span><span class="p">])</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># transform from list --&gt; np.array</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">del</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">X0</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">normA0</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">transect</span><span class="p">)</span>    

<span class="k">def</span><span class="w"> </span><span class="nf">_do_find_intersected_edges_fast</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">transect</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">idx_ed</span><span class="p">):</span>
    <span class="c1"># Initialize lists</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_cut_P&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">]:</span>
        <span class="n">transect</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

    <span class="c1"># Precompute values</span>
    <span class="n">eps</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
    <span class="n">e_vec</span>   <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;e_vec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">e_norm</span>  <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;e_norm&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Compute edge vectors in one go</span>
    <span class="n">edge_x</span>  <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">idx_ed</span><span class="p">]]</span> <span class="o">-</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx_ed</span><span class="p">]]</span>
    <span class="n">edge_y</span>  <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">idx_ed</span><span class="p">]]</span> <span class="o">-</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx_ed</span><span class="p">]]</span>
    <span class="n">normA0</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">edge_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">edge_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">normA0_inv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">normA0</span>

    <span class="c1"># Normalize edge vectors</span>
    <span class="n">edge_x</span> <span class="o">*=</span> <span class="n">normA0_inv</span>
    <span class="n">edge_y</span> <span class="o">*=</span> <span class="n">normA0_inv</span>

    <span class="c1"># Compute P for all edges</span>
    <span class="n">P_x</span>     <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Px&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx_ed</span><span class="p">]]</span>
    <span class="n">P_y</span>     <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Py&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx_ed</span><span class="p">]]</span>

    <span class="c1"># Solve linear equation system</span>
    <span class="n">div</span>     <span class="o">=</span> <span class="n">edge_x</span> <span class="o">*</span> <span class="o">-</span><span class="n">e_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">edge_y</span> <span class="o">*</span> <span class="o">-</span><span class="n">e_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># avoid division by zero div</span>
    <span class="n">div</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">div</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    
    
    <span class="n">X0</span>      <span class="o">=</span> <span class="p">(</span><span class="n">P_x</span> <span class="o">*</span> <span class="o">-</span><span class="n">e_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">P_y</span> <span class="o">*</span> <span class="o">-</span><span class="n">e_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span>  <span class="n">div</span>
    <span class="n">X1</span>      <span class="o">=</span> <span class="p">(</span><span class="n">P_x</span> <span class="o">*</span>  <span class="n">edge_y</span>   <span class="o">-</span> <span class="n">P_y</span> <span class="o">*</span>  <span class="n">edge_x</span>  <span class="p">)</span> <span class="o">/</span> <span class="o">-</span><span class="n">div</span>
    <span class="k">del</span><span class="p">(</span><span class="n">e_vec</span><span class="p">)</span>

    <span class="c1"># Boolean mask for valid intersections</span>
    <span class="n">mask</span>    <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X0</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X0</span> <span class="o">&lt;=</span> <span class="n">normA0</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span>
                               <span class="p">(</span><span class="n">X1</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X1</span> <span class="o">&lt;=</span> <span class="n">e_norm</span> <span class="o">+</span> <span class="n">eps</span><span class="p">))</span>

    <span class="c1"># Select only valid intersections</span>
    <span class="n">valid_idx</span>    <span class="o">=</span> <span class="n">idx_ed</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">X0_valid</span>     <span class="o">=</span> <span class="n">X0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">normA0_valid</span> <span class="o">=</span> <span class="n">normA0</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">edge_x_valid</span> <span class="o">=</span> <span class="n">edge_x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">edge_y_valid</span> <span class="o">=</span> <span class="n">edge_y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">del</span><span class="p">(</span><span class="n">P_x</span><span class="p">,</span> <span class="n">P_y</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">X0</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">normA0</span><span class="p">,</span> <span class="n">e_norm</span><span class="p">)</span>

    <span class="c1"># Store results</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_idx</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">edge_x_valid</span><span class="p">,</span> <span class="n">edge_y_valid</span><span class="p">))</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">valid_idx</span><span class="p">]]</span> <span class="o">+</span> <span class="n">edge_x_valid</span> <span class="o">*</span> <span class="n">X0_valid</span><span class="p">,</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">valid_idx</span><span class="p">]]</span> <span class="o">+</span> <span class="n">edge_y_valid</span> <span class="o">*</span> <span class="n">X0_valid</span>
    <span class="p">))</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">valid_idx</span><span class="p">]]</span> <span class="o">+</span> <span class="n">edge_x_valid</span> <span class="o">*</span> <span class="n">normA0_valid</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">valid_idx</span><span class="p">]]</span> <span class="o">+</span> <span class="n">edge_y_valid</span> <span class="o">*</span> <span class="n">normA0_valid</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="p">))</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X0_valid</span> <span class="o">/</span> <span class="n">normA0_valid</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[:,</span> <span class="n">valid_idx</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span> <span class="n">transect</span>



<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________</span>
<span class="c1"># compute distance of cutting points from cross-section start point --&gt; than </span>
<span class="c1"># sort cutted edges after this distance</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_do_sort_intersected_edges</span><span class="p">(</span><span class="n">transect</span><span class="p">):</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Px&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                          <span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Py&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">idx_sort</span>  <span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">idx_sort</span><span class="p">,:]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">idx_sort</span><span class="p">,:]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">idx_sort</span><span class="p">,:]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">idx_sort</span>  <span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">idx_sort</span><span class="p">,:]</span>
    <span class="k">del</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">transect</span><span class="p">)</span>
    


<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_do_build_path</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">transect</span><span class="p">,</span> <span class="n">edge_tri</span><span class="p">,</span> <span class="n">edge_dxdy_l</span><span class="p">,</span> <span class="n">edge_dxdy_r</span><span class="p">):</span>

    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># allocate path arrays</span>
    <span class="n">path_xy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">path_ei</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">path_ni</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">path_dx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">path_dy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">path_cut_ni</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    
    <span class="c1">#_______________________________________________________________________</span>
    <span class="c1"># compute angle bearing of cross-section line: </span>
    <span class="c1">#                            N</span>
    <span class="c1">#                            ^  </span>
    <span class="c1">#          alpha=[90...180]  |   alpha=[0...90]  </span>
    <span class="c1">#                            |</span>
    <span class="c1">#                    W&lt;------|------&gt; E</span>
    <span class="c1">#                            |</span>
    <span class="c1">#        alpha=[-90...-180]  |   alpha=[0...-90]  </span>
    <span class="c1">#                            v</span>
    <span class="c1">#                            S</span>
    <span class="c1">#alpha = -np.arctan2(transect[&#39;e_vec&#39;][-1][1], transect[&#39;e_vec&#39;][-1][0])</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;e_vec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;e_vec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="c1">#print(&#39;&gt; alpha:&#39;, alpha*180/np.pi)</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># loop over intersected edges </span>
    <span class="n">nced</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    <span class="k">for</span> <span class="n">edi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nced</span><span class="p">):</span>
        <span class="c1">#print(&#39; --&gt; edgecut_ii&#39;, edi)</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># --&gt; rotate edge with bearing angle -alpha</span>
        <span class="c1"># determine if edge shows to the left or to the right with </span>
        <span class="c1"># respect to cross-section line, if theta&lt;0, edge shows to the right</span>
        <span class="c1"># in this case use [L]eft triangle, if theta&gt;0 edge shows to the left</span>
        <span class="c1"># in this case use right triangle (its that the &quot;downstream&quot; triangle</span>
        <span class="c1"># with respect to cross-section direction)</span>
        <span class="c1"># --&gt; rotate edge by minus alpha angle</span>
        <span class="c1"># use Rotationmatrixs R_alpha = | cos(-alpha) -sin(-alpha) |</span>
        <span class="c1">#                               | sin(-alpha)  cos(-alpha) |</span>
        <span class="c1">#   </span>
        <span class="c1"># R_alpha * |ed_x | = | ed_x*cos(-alpha)-ed_y*sin(-alpha) | </span>
        <span class="c1">#           |ed_y |   | ed_x*sin(-alpha)+ed_y*cos(-alpha) | </span>
        <span class="n">auxx</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">-</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">auxy</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">+</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">theta</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">auxy</span><span class="p">,</span><span class="n">auxx</span><span class="p">)</span>
        <span class="c1">#print(&#39;--&gt; theta:&#39;, theta*180/np.pi)</span>
        <span class="k">del</span><span class="p">(</span><span class="n">auxx</span><span class="p">,</span> <span class="n">auxy</span><span class="p">)</span>
                
        <span class="c1"># indices of [L]eft and [R]ight triangle with respect to the edge</span>
        <span class="n">edge_elem</span>  <span class="o">=</span> <span class="n">edge_tri</span><span class="p">[:,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">]]</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># add upsection element to path if it exist --&gt; path_xy coodinate points </span>
        <span class="c1"># for the element always come from downsection triangle </span>
        <span class="n">path_xy</span><span class="p">,</span> <span class="n">path_ei</span><span class="p">,</span> <span class="n">path_ni</span><span class="p">,</span> <span class="n">path_dx</span><span class="p">,</span> <span class="n">path_dy</span><span class="p">,</span> <span class="n">path_cut_ni</span> <span class="o">=</span> <span class="n">__add_upsection_elem2path</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">transect</span><span class="p">,</span> <span class="n">edi</span><span class="p">,</span> <span class="n">nced</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> 
                                                  <span class="n">edge_elem</span><span class="p">,</span> <span class="n">edge_dxdy_l</span><span class="p">,</span> <span class="n">edge_dxdy_r</span><span class="p">,</span>
                                                  <span class="n">path_xy</span><span class="p">,</span> <span class="n">path_ei</span><span class="p">,</span> <span class="n">path_ni</span><span class="p">,</span> <span class="n">path_dx</span><span class="p">,</span> <span class="n">path_dy</span><span class="p">,</span> <span class="n">path_cut_ni</span><span class="p">)</span>
        
        <span class="c1"># add edge mid point of cutted edge</span>
        <span class="n">path_xy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">])</span>
        
        <span class="c1"># add downsection element to path if it exist</span>
        <span class="n">path_xy</span><span class="p">,</span> <span class="n">path_ei</span><span class="p">,</span> <span class="n">path_ni</span><span class="p">,</span> <span class="n">path_dx</span><span class="p">,</span> <span class="n">path_dy</span><span class="p">,</span> <span class="n">path_cut_ni</span> <span class="o">=</span> <span class="n">__add_downsection_elem2path</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">transect</span><span class="p">,</span> <span class="n">edi</span><span class="p">,</span> <span class="n">nced</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> 
                                                  <span class="n">edge_elem</span><span class="p">,</span> <span class="n">edge_dxdy_l</span><span class="p">,</span> <span class="n">edge_dxdy_r</span><span class="p">,</span>
                                                  <span class="n">path_xy</span><span class="p">,</span> <span class="n">path_ei</span><span class="p">,</span> <span class="n">path_ni</span><span class="p">,</span> <span class="n">path_dx</span><span class="p">,</span> <span class="n">path_dy</span><span class="p">,</span> <span class="n">path_cut_ni</span><span class="p">)</span>
        
    <span class="c1">#___________________________________________________________________________    </span>
    <span class="c1"># reformulate from list --&gt; np.array</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">path_xy</span><span class="p">))</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">path_ei</span><span class="p">))</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">path_ni</span><span class="p">))</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">path_dx</span><span class="p">))</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">path_dy</span><span class="p">))</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">path_cut_ni</span><span class="p">))</span>
    
    <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">aux</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">aux</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;n_vec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;n_vec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_nvec_cs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span>
    <span class="k">del</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span>
    
    <span class="c1"># !!! Make sure positive Transport is defined S--&gt;N and W--&gt;E</span>
    <span class="c1"># --&gt; Preliminary --&gt; not 100% sure its universal</span>
    <span class="c1">#rad = np.pi/180</span>
    <span class="c1">#if (-alpha/rad&gt;=-180 and -alpha/rad&lt;=-90 ) or (-alpha/rad&gt;90 and -alpha/rad&lt;=180 ):</span>
    
    <span class="c1"># make sure the normal direction of section is fixed from:</span>
    <span class="c1"># NW --&gt; SE</span>
    <span class="c1">#  W --&gt; E</span>
    <span class="c1"># SW --&gt; NE</span>
    <span class="c1">#  S --&gt; N </span>
    <span class="c1">#if transect[&#39;n_vec&#39;][-1][0]&lt;0 or transect[&#39;n_vec&#39;][-1][1]&lt;0:</span>
    <span class="k">if</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;n_vec_tot&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;n_vec_tot&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
    <span class="k">del</span><span class="p">(</span><span class="n">path_xy</span><span class="p">,</span> <span class="n">path_ei</span><span class="p">,</span> <span class="n">path_ni</span><span class="p">,</span> <span class="n">path_dx</span><span class="p">,</span> <span class="n">path_dy</span><span class="p">,</span> <span class="n">edge_elem</span><span class="p">)</span>

    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">transect</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__add_downsection_elem2path</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">transect</span><span class="p">,</span> <span class="n">edi</span><span class="p">,</span> <span class="n">nced</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">edge_elem</span><span class="p">,</span> <span class="n">edge_dxdy_l</span><span class="p">,</span> <span class="n">edge_dxdy_r</span><span class="p">,</span>
                                <span class="n">path_xy</span><span class="p">,</span> <span class="n">path_ei</span><span class="p">,</span> <span class="n">path_ni</span><span class="p">,</span> <span class="n">path_dx</span><span class="p">,</span> <span class="n">path_dy</span><span class="p">,</span> <span class="n">path_cut_ni</span><span class="p">):</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># if theta&gt;0 edge shows to the left</span>
    <span class="c1">#                          ^ Section</span>
    <span class="c1">#                  [R]ight | Triangle downsection triangle</span>
    <span class="c1">#                          |</span>
    <span class="c1">#           2o&lt;------------+--------------o1   edge</span>
    <span class="c1">#                          | </span>
    <span class="c1">#                   [L]eft | Triangle </span>
    <span class="k">if</span> <span class="p">(</span><span class="n">theta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># right triangle</span>
        <span class="k">if</span> <span class="n">edge_elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1"># take care if there are periodic boundaries</span>
            <span class="n">e_xR</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],:]]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">e_xR</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">e_xR</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_xR</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_xR</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span> <span class="n">e_xR</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_xR</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">360.0</span>
                <span class="k">else</span>                              <span class="p">:</span> <span class="n">e_xR</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_xR</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">360.0</span>
            <span class="n">e_xR</span><span class="p">,</span> <span class="n">e_yR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_xR</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],:]])</span><span class="o">/</span><span class="mf">3.0</span>
            <span class="n">path_xy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">e_xR</span><span class="p">,</span> <span class="n">e_yR</span><span class="p">]))</span>
            <span class="k">del</span><span class="p">(</span><span class="n">e_xR</span><span class="p">,</span> <span class="n">e_yR</span><span class="p">)</span>
            
            <span class="n">path_ei</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">path_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:])</span>
            <span class="n">path_dx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_dxdy_r</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">]])</span>
            <span class="n">path_dy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_dxdy_r</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">]])</span>
            
            <span class="c1"># needed to interpolate temperature to edge mid point for heat flux </span>
            <span class="c1"># computation</span>
            <span class="n">path_cut_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">,:])</span>
        
        <span class="c1"># edge is boundary edge right triangle does not exist--&gt; put dummy values</span>
        <span class="c1"># instead of centroid position (transect[&#39;edge_cut_midP&#39;][-1][edi])  </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#print(&#39; &gt;-)))&gt; .oO: downsection&#39;, edi)</span>
            <span class="n">path_xy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">])</span>  <span class="c1">#(***)</span>
            <span class="n">path_ei</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>                     <span class="c1">#--&gt; -1 is here dummy index</span>
            <span class="n">path_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="c1">#--&gt; -1 is here dummy index</span>
            <span class="n">path_dx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">path_dy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            
            <span class="c1"># needed to interpolate temperature to edge mid point for heat flux </span>
            <span class="c1"># computation</span>
            <span class="n">path_cut_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># if theta&lt;0 edge shows to the right</span>
    <span class="c1">#                          ^ Section</span>
    <span class="c1">#                   [L]eft | Triangle downsection triangle </span>
    <span class="c1">#                          |</span>
    <span class="c1">#           1o-------------+-------------&gt;o2   edge</span>
    <span class="c1">#                          | </span>
    <span class="c1">#                 [R]right | Triangle </span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># left triangle</span>
        <span class="n">e_xL</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">e_xL</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">e_xL</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_xL</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_xL</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span> <span class="n">e_xL</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_xL</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">360.0</span>
            <span class="k">else</span>                              <span class="p">:</span> <span class="n">e_xL</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_xL</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">360.0</span>
        <span class="n">e_xL</span><span class="p">,</span> <span class="n">e_yL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_xL</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]])</span><span class="o">/</span><span class="mf">3.0</span>
        <span class="n">path_xy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">e_xL</span><span class="p">,</span> <span class="n">e_yL</span><span class="p">]))</span>
        <span class="k">del</span><span class="p">(</span><span class="n">e_xL</span><span class="p">,</span> <span class="n">e_yL</span><span class="p">)</span>
        
        <span class="n">path_ei</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">path_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:])</span>
        <span class="n">path_dx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_dxdy_l</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">]])</span>
        <span class="n">path_dy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_dxdy_l</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">]])</span>
        
        <span class="c1"># needed to interpolate temperature to edge mid point for heat flux </span>
        <span class="c1"># computation</span>
        <span class="n">path_cut_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">,:])</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">path_xy</span><span class="p">,</span> <span class="n">path_ei</span><span class="p">,</span> <span class="n">path_ni</span><span class="p">,</span> <span class="n">path_dx</span><span class="p">,</span> <span class="n">path_dy</span><span class="p">,</span> <span class="n">path_cut_ni</span><span class="p">)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__add_upsection_elem2path</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">transect</span><span class="p">,</span> <span class="n">edi</span><span class="p">,</span> <span class="n">nced</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">edge_elem</span><span class="p">,</span> <span class="n">edge_dxdy_l</span><span class="p">,</span> <span class="n">edge_dxdy_r</span><span class="p">,</span>
                            <span class="n">path_xy</span><span class="p">,</span> <span class="n">path_ei</span><span class="p">,</span> <span class="n">path_ni</span><span class="p">,</span> <span class="n">path_dx</span><span class="p">,</span> <span class="n">path_dy</span><span class="p">,</span> <span class="n">path_cut_ni</span><span class="p">):</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># if theta&gt;0 edge shows to the left</span>
    <span class="c1">#                          ^ Section</span>
    <span class="c1">#                  [R]ight | Triangle </span>
    <span class="c1">#                          |</span>
    <span class="c1">#           2o&lt;------------+--------------o1   edge</span>
    <span class="c1">#                          | </span>
    <span class="c1">#                   [L]eft | Triangle upsection triangle</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">theta</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">edi</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1"># take care if there are periodic boundaries</span>
            <span class="n">e_xL</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">e_xL</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">e_xL</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_xL</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_xL</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span> <span class="n">e_xL</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_xL</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">360.0</span>
                <span class="k">else</span>                              <span class="p">:</span> <span class="n">e_xL</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_xL</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">360.0</span>
            <span class="n">e_xL</span><span class="p">,</span> <span class="n">e_yL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_xL</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]])</span><span class="o">/</span><span class="mf">3.0</span>
            <span class="n">path_xy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">e_xL</span><span class="p">,</span> <span class="n">e_yL</span><span class="p">]))</span>
            <span class="k">del</span><span class="p">(</span><span class="n">e_xL</span><span class="p">,</span> <span class="n">e_yL</span><span class="p">)</span>
            
        <span class="c1"># left triangle </span>
        <span class="n">path_ei</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">path_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:])</span>
        
        <span class="c1"># need to flip edge_dxdy vector through minus sign since its opposite </span>
        <span class="c1"># directed to the transect direction --&gt; upsection</span>
        <span class="n">path_dx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">edge_dxdy_l</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">]])</span>
        <span class="n">path_dy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">edge_dxdy_l</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">]])</span>
        
        <span class="c1"># needed to interpolate temperature to edge mid point for heat flux </span>
        <span class="c1"># computation</span>
        <span class="n">path_cut_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">,:])</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># if theta&lt;0 edge shows to the right</span>
    <span class="c1">#                          ^ Section</span>
    <span class="c1">#                   [L]eft | Triangle</span>
    <span class="c1">#                          |</span>
    <span class="c1">#           1o-------------+-------------&gt;o2   edge</span>
    <span class="c1">#                          | </span>
    <span class="c1">#                 [R]right | Triangle upsection triangle</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># right triangle</span>
        <span class="k">if</span> <span class="n">edge_elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">edi</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="c1"># take care if there are periodic boundaries</span>
                <span class="n">e_xR</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],:]]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">e_xR</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">e_xR</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_xR</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_xR</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span> <span class="n">e_xR</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_xR</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">360.0</span>
                    <span class="k">else</span>                              <span class="p">:</span> <span class="n">e_xR</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_xR</span><span class="p">[</span><span class="n">e_xL</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">360.0</span>
                <span class="n">e_xR</span><span class="p">,</span> <span class="n">e_yR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">e_xR</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],:]])</span><span class="o">/</span><span class="mf">3.0</span>
                <span class="n">path_xy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">e_xR</span><span class="p">,</span> <span class="n">e_yR</span><span class="p">]))</span>
                <span class="k">del</span><span class="p">(</span><span class="n">e_xR</span><span class="p">,</span> <span class="n">e_yR</span><span class="p">)</span>
                
            <span class="n">path_ei</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">path_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">edge_elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:])</span>
            
            <span class="c1"># need to flip edge_dxdy vector through minus sign since its opposite </span>
            <span class="c1"># directed to the transect direction --&gt; upsection</span>
            <span class="n">path_dx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">edge_dxdy_r</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">]])</span>
            <span class="n">path_dy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">edge_dxdy_r</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">]])</span>
            
            <span class="c1"># needed to interpolate temperature to edge mid point for heat flux </span>
            <span class="c1"># computation</span>
            <span class="n">path_cut_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">,:])</span>
            
        <span class="c1"># edge is boundary edge right triangle does not exist--&gt; put dummy values</span>
        <span class="c1"># instead of centroid position (transect[&#39;edge_cut_midP&#39;][-1][edi])  </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># enter additional point close to the boundary with additional </span>
            <span class="c1"># ei, ni, dx and dy --&gt; ensures that transect is porperly plotted</span>
            <span class="c1"># when it cutts over land </span>
            <span class="c1">#print(&#39; &gt;-))))&gt; .oO: upsection&#39;, edi)</span>
            <span class="n">path_xy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">])</span>  <span class="c1">#(***)</span>
            <span class="n">path_ei</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>                                  <span class="c1">#(***) </span>
            <span class="n">path_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>              <span class="c1">#(***)</span>
            <span class="n">path_dx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">path_dy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            
            <span class="c1"># needed to interpolate temperature to edge mid point for heat flux </span>
            <span class="c1"># computation</span>
            <span class="n">path_cut_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            
            <span class="k">if</span> <span class="n">edi</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">edi</span><span class="o">!=</span><span class="n">nced</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># in case of a single transect</span>
                <span class="n">path_ei</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>                     
                <span class="n">path_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span> 
                <span class="n">path_dx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">path_dy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">path_cut_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;ncsi&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">edi</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>        
                <span class="c1"># in case of transect consist of subtransects</span>
                <span class="n">path_xy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">])</span>  <span class="c1">#(***)</span>
                <span class="n">path_ei</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>                     
                <span class="n">path_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span> 
                <span class="n">path_dx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">path_dy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">path_cut_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;ncsi&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;ncs&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">edi</span><span class="o">==</span><span class="n">nced</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>   
                <span class="c1"># in case of transect consist of subtransects</span>
                <span class="n">path_xy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">edi</span><span class="p">])</span>  <span class="c1">#(***)</span>
                <span class="n">path_ei</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>                     
                <span class="n">path_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span> 
                <span class="n">path_dx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">path_dy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">path_cut_ni</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">path_xy</span><span class="p">,</span> <span class="n">path_ei</span><span class="p">,</span> <span class="n">path_ni</span><span class="p">,</span> <span class="n">path_dx</span><span class="p">,</span> <span class="n">path_dy</span><span class="p">,</span> <span class="n">path_cut_ni</span><span class="p">)</span>



<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________   </span>
<span class="c1"># insert land pts (nan) when there are 2 consecutive cutted boundary </span>
<span class="k">def</span><span class="w"> </span><span class="nf">_do_insert_landpts</span><span class="p">(</span><span class="n">transect</span><span class="p">,</span> <span class="n">edge_tri</span><span class="p">):</span>
    <span class="c1"># edges edge_tri[1,:] = -1</span>
    <span class="n">edge_cut_ei</span> <span class="o">=</span> <span class="n">edge_tri</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">]]</span>
    
    <span class="c1"># search if there are two consecutive boundary edges </span>
    <span class="n">idx_bdedge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edge_cut_ei</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">())</span>
    <span class="n">idx_bdedge</span> <span class="o">=</span> <span class="n">idx_bdedge</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">idx_bdedge</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">idx_bdedge</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">transect_bnd</span> <span class="o">=</span> <span class="n">_do_init_transect</span><span class="p">()</span>
        <span class="n">list2update</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">transect</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">list2update</span><span class="p">,</span><span class="s1">&#39;edge_cut_*&#39;</span><span class="p">):</span> <span class="n">list2update</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="c1"># copy everything except edges_cut_* --&gt; here still must insert boundary cut</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">list2update</span><span class="p">:</span> <span class="n">transect_bnd</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
        
        <span class="n">found_bnd</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">ni_s</span><span class="p">,</span><span class="n">ni_e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edge_cut_ei</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># found transect that cuts over land </span>
            <span class="k">if</span> <span class="n">edge_cut_ei</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">edge_cut_ei</span><span class="p">[</span><span class="n">ni</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ni_e</span> <span class="o">=</span> <span class="n">ni</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found_bnd</span><span class="p">:</span>
                    <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">][</span><span class="n">ni_s</span><span class="p">:</span><span class="n">ni_e</span>  <span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span> <span class="p">))</span>
                    <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="n">ni_s</span><span class="p">:</span><span class="n">ni_e</span><span class="p">,:],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
                    <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][</span><span class="n">ni_s</span><span class="p">:</span><span class="n">ni_e</span><span class="p">,:],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][[</span><span class="n">ni</span><span class="p">,</span><span class="n">ni</span><span class="o">+</span><span class="mi">1</span><span class="p">],:]))</span>
                    <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="n">ni_s</span><span class="p">:</span><span class="n">ni_e</span><span class="p">,:],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][[</span><span class="n">ni</span><span class="p">,</span><span class="n">ni</span><span class="o">+</span><span class="mi">1</span><span class="p">],:]))</span>
                    <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">][</span><span class="n">ni_s</span><span class="p">:</span><span class="n">ni_e</span>  <span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="p">))</span>
                    <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">][</span><span class="n">ni_s</span><span class="p">:</span><span class="n">ni_e</span><span class="p">,:],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">][</span><span class="n">ni_s</span><span class="p">:</span><span class="n">ni_e</span>  <span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span> <span class="p">))</span>
                    <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="n">ni_s</span><span class="p">:</span><span class="n">ni_e</span><span class="p">,:],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
                    <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][</span><span class="n">ni_s</span><span class="p">:</span><span class="n">ni_e</span><span class="p">,:],</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][[</span><span class="n">ni</span><span class="p">,</span><span class="n">ni</span><span class="o">+</span><span class="mi">1</span><span class="p">],:]))</span>
                    <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="n">ni_s</span><span class="p">:</span><span class="n">ni_e</span><span class="p">,:],</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][[</span><span class="n">ni</span><span class="p">,</span><span class="n">ni</span><span class="o">+</span><span class="mi">1</span><span class="p">],:]))</span>
                    <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">][</span><span class="n">ni_s</span><span class="p">:</span><span class="n">ni_e</span>  <span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="p">))</span>
                    <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">][</span><span class="n">ni_s</span><span class="p">:</span><span class="n">ni_e</span><span class="p">,:],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">ni_s</span> <span class="o">=</span> <span class="n">ni</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">found_bnd</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span>   <span class="p">][</span><span class="n">ni_s</span><span class="p">:</span>  <span class="p">]))</span>
        <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_evec&#39;</span><span class="p">][</span><span class="n">ni_s</span><span class="p">:,:]))</span>
        <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span>   <span class="p">][</span><span class="n">ni_s</span><span class="p">:,:]))</span>
        <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][</span><span class="n">ni_s</span><span class="p">:,:]))</span>
        <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">][</span><span class="n">ni_s</span><span class="p">:</span>  <span class="p">]))</span>
        <span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">transect_bnd</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span>  <span class="p">][</span><span class="n">ni_s</span><span class="p">:,:]))</span>
        <span class="n">transect</span> <span class="o">=</span> <span class="n">transect_bnd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">transect</span><span class="p">)</span>



<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________    </span>
<span class="k">def</span><span class="w"> </span><span class="nf">_do_compute_distance_from_startpoint</span><span class="p">(</span><span class="n">transect</span><span class="p">):</span>
    <span class="c1"># build distance from start point for transport path [km]</span>
    <span class="n">Rearth</span> <span class="o">=</span> <span class="mf">6367.5</span>  <span class="c1"># [km]</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span>  <span class="o">=</span> <span class="n">grid_cart3d</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">is_deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dist</span>   <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">z</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="c1"># avoid nan&#39;s in arccos from numerics</span>
    <span class="n">dist</span><span class="p">[</span><span class="n">dist</span><span class="o">&gt;=</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">dist</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">*</span><span class="n">Rearth</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>   
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dist&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dist&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">del</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    
    <span class="c1"># build distance from start point for edge cut mid points [km]</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span>  <span class="o">=</span> <span class="n">grid_cart3d</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">is_deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dist</span>   <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">z</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="c1"># avoid nan&#39;s in arccos from numerics</span>
    <span class="n">dist</span><span class="p">[</span><span class="n">dist</span><span class="o">&gt;=</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">dist</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">*</span><span class="n">Rearth</span>
    <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">dist</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()])</span>
    <span class="k">del</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">transect</span><span class="p">)</span>
    

<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#___COMPUTE VOLUME TRANSPORT THROUGH TRANSECT___________________________________</span>
<div class="viewcode-block" id="calc_transect_Xtransp">
<a class="viewcode-back" href="../../index.html#tripyview.sub_transect.calc_transect_Xtransp">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_transect_Xtransp</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">transects</span><span class="p">,</span> <span class="n">dataX</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_Xref</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                          <span class="n">do_transectattr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_rot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; Compute fesom2 modell accurate transport through defined transect</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :mesh:          fesom2 tripyview mesh object,  with all mesh information </span>
<span class="sd">        </span>
<span class="sd">        :data:          object, with xarray dataset object with 3d element zonal and meridional</span>
<span class="sd">                        velocities</span>
<span class="sd">        </span>
<span class="sd">        :transects:     list with analysed transect dictionary information computed by </span>
<span class="sd">                        do_analyse _trasnsects</span>
<span class="sd">                        </span>
<span class="sd">        :dataX:         object (default=None), with xarray dataset object with 3d </span>
<span class="sd">                        vertice temperature or salinity data to compute heatflux/</span>
<span class="sd">                        saltflux through section   </span>
<span class="sd">                        </span>
<span class="sd">        :data_Xref:     float (default=0.0) reference temperature or salinity to </span>
<span class="sd">                        compute flux</span>
<span class="sd">        </span>
<span class="sd">        :do_transectattr: bool, (default=True) write full transect info into return</span>
<span class="sd">                        xarray dataset attribute</span>
<span class="sd">        </span>
<span class="sd">        :do_rot:        bool, (default=True), do rotation of velocities from rotated</span>
<span class="sd">                        to geo coordinates</span>
<span class="sd">        </span>
<span class="sd">        :do_info:       bool, (default=True), write info</span>
<span class="sd">    </span>
<span class="sd">    Return:</span>
<span class="sd">    </span>
<span class="sd">        :data:          list with returned xarray dataset object that contain volume </span>
<span class="sd">                        transport through every section of the transport path</span>
<span class="sd">    </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transects</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> 
        <span class="c1">#if len(transects)&gt;1:</span>
        <span class="n">is_list</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">transp</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">([])</span>
        <span class="c1">#else:</span>
        <span class="c1">#    is_list = False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">is_list</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">transects</span><span class="o">=</span><span class="nb">list</span><span class="p">([</span><span class="n">transects</span><span class="p">])</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># variable name of zonal meridional velocity component</span>
    <span class="n">vnameU</span><span class="p">,</span> <span class="n">vnameV</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    
    <span class="c1"># variable name of Xtransp component (temp or salt)</span>
    <span class="n">vnameX</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">dataX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">vnameX</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataX</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># loop over various transects</span>
    <span class="k">for</span> <span class="n">transect</span> <span class="ow">in</span> <span class="n">transects</span><span class="p">:</span>
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># select only necessary elements </span>
        <span class="k">if</span> <span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">data_uv</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">elem</span><span class="o">=</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            
        <span class="k">elif</span> <span class="s1">&#39;nod2&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>    
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>
                          <span class="s2">&quot;--&gt; It should be mentioned that a transport computed based on </span><span class="se">\n</span><span class="s2">&quot;</span>
                          <span class="s2">&quot;    vertice velocity data is less accurate since the model operates </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>
                          <span class="s2">&quot;    on element velocities. So there can be quite a big amplitude offset </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>
                          <span class="s2">&quot;    between the transport based on u+v or unod+vnod. Although the variability </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>
                          <span class="s2">&quot;    seems to be unaffected. So if you have the data try to compute the </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>
                          <span class="s2">&quot;    transport based on velocities on elements. </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">data_uv</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nod2</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nod2&#39;</span><span class="p">,</span> <span class="s1">&#39;n2&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--&gt; Could not find proper dimension in uv velocity data&quot;</span><span class="p">)</span>
        <span class="n">vel_u</span>   <span class="o">=</span> <span class="n">data_uv</span><span class="p">[</span><span class="n">vnameU</span> <span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">vel_v</span>   <span class="o">=</span> <span class="n">data_uv</span><span class="p">[</span><span class="n">vnameV</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">del</span><span class="p">(</span><span class="n">data_uv</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># select only necessary elements from temp data</span>
        <span class="n">var_X</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dataX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var_X</span> <span class="o">=</span> <span class="n">dataX</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nod2</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nod2&#39;</span><span class="p">,</span> <span class="s1">&#39;n2&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="n">var_X</span> <span class="o">=</span> <span class="n">var_X</span><span class="p">[</span><span class="n">vnameX</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># rotate vectors insert topography as nan</span>
        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
            <span class="c1">#___________________________________________________________________</span>
            <span class="k">if</span> <span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="c1"># Here i introduce the vertical topography, we replace the zeros that</span>
                <span class="c1"># describe the topography with nan</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span><span class="p">]):</span>
                    <span class="n">vel_u</span><span class="p">[:,</span><span class="n">ii</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span><span class="p">[</span><span class="n">ei</span><span class="p">]:],</span> <span class="n">vel_v</span><span class="p">[:,</span><span class="n">ii</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span><span class="p">[</span><span class="n">ei</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                
                <span class="c1"># here rotate the velocities from roted frame to geo frame </span>
                <span class="k">if</span> <span class="n">do_rot</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">nti</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]):</span>
                        <span class="n">vel_u</span><span class="p">[</span><span class="n">nti</span><span class="p">,:,:],</span> <span class="n">vel_v</span><span class="p">[</span><span class="n">nti</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">vec_r2g</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">abg</span><span class="p">,</span> 
                                            <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> 
                                            <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span>
                                            <span class="n">vel_u</span><span class="p">[</span><span class="n">nti</span><span class="p">,:,:],</span> <span class="n">vel_v</span><span class="p">[</span><span class="n">nti</span><span class="p">,:,:])</span>
            
            <span class="c1">#___________________________________________________________________        </span>
            <span class="k">elif</span> <span class="s1">&#39;nod2&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">ni0</span><span class="p">,</span> <span class="n">ni1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span><span class="p">]):</span>
                    <span class="n">vel_u</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni0</span><span class="p">]:],</span> <span class="n">vel_v</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni0</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">vel_u</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni1</span><span class="p">]:],</span> <span class="n">vel_v</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni1</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    
                <span class="c1"># average vertice velocities to the edge centers</span>
                <span class="n">vel_u</span><span class="p">,</span> <span class="n">vel_v</span> <span class="o">=</span> <span class="n">vel_u</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">vel_v</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
                
                <span class="c1"># here rotate the velocities from roted frame to geo frame </span>
                <span class="k">if</span> <span class="n">do_rot</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">nti</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]):</span>
                        <span class="n">vel_u</span><span class="p">[</span><span class="n">nti</span><span class="p">,:,:],</span> <span class="n">vel_v</span><span class="p">[</span><span class="n">nti</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">vec_r2g</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">abg</span><span class="p">,</span> 
                                            <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> 
                                            <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span>
                                            <span class="n">vel_u</span><span class="p">[</span><span class="n">nti</span><span class="p">,:,:],</span> <span class="n">vel_v</span><span class="p">[</span><span class="n">nti</span><span class="p">,:,:])</span>
            
            <span class="c1">#___________________________________________________________________        </span>
            <span class="k">if</span> <span class="n">dataX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Here i introduce the vertical topography, we replace the zeros that</span>
                <span class="c1"># describe the topography with nan&#39;s</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">ni0</span><span class="p">,</span> <span class="n">ni1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span><span class="p">]):</span>
                    <span class="n">var_X</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni0</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">var_X</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni1</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            
                <span class="c1"># average vertice temperature to the edge centers</span>
                <span class="n">var_X</span> <span class="o">=</span> <span class="n">var_X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
                
        <span class="k">else</span><span class="p">:</span> 
            <span class="c1">#___________________________________________________________________</span>
            <span class="k">if</span> <span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="c1"># Here i introduce the vertical topography, we replace the zeros that</span>
                <span class="c1"># describe the topography with nan&#39;s</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span><span class="p">]):</span>
                    <span class="n">vel_u</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span><span class="p">[</span><span class="n">ei</span><span class="p">]:],</span> <span class="n">vel_v</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span><span class="p">[</span><span class="n">ei</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                
                <span class="c1"># here rotate the velocities from roted frame to geo frame </span>
                <span class="k">if</span> <span class="n">do_rot</span><span class="p">:</span>
                    <span class="n">vel_u</span><span class="p">,</span> <span class="n">vel_v</span> <span class="o">=</span> <span class="n">vec_r2g</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">abg</span><span class="p">,</span> 
                                        <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> 
                                        <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ni&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span>
                                        <span class="n">vel_u</span><span class="p">,</span> <span class="n">vel_v</span><span class="p">)</span>
                
            <span class="c1">#___________________________________________________________________        </span>
            <span class="k">elif</span> <span class="s1">&#39;nod2&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">ni0</span><span class="p">,</span> <span class="n">ni1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span><span class="p">]):</span>
                    <span class="n">vel_u</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni0</span><span class="p">]:],</span> <span class="n">vel_v</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni0</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">vel_u</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni1</span><span class="p">]:],</span> <span class="n">vel_v</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni1</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    
                <span class="c1"># average vertice velocities to the edge centers</span>
                <span class="n">vel_u</span><span class="p">,</span> <span class="n">vel_v</span> <span class="o">=</span> <span class="n">vel_u</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">vel_v</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
                
                <span class="c1"># here rotate the velocities from roted frame to geo frame </span>
                <span class="k">if</span> <span class="n">do_rot</span><span class="p">:</span>
                    <span class="n">vel_u</span><span class="p">,</span> <span class="n">vel_v</span> <span class="o">=</span> <span class="n">vec_r2g</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">abg</span><span class="p">,</span> 
                                        <span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> 
                                        <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span>
                                        <span class="n">vel_u</span><span class="p">,</span> <span class="n">vel_v</span><span class="p">)</span>
            
            <span class="c1">#___________________________________________________________________        </span>
            <span class="k">if</span> <span class="n">dataX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Here i introduce the vertical topography, we replace the zeros that</span>
                <span class="c1"># describe the topography with nan&#39;s</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="p">(</span><span class="n">ni0</span><span class="p">,</span> <span class="n">ni1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_cut_ni&#39;</span><span class="p">]):</span>
                    <span class="n">var_X</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni0</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">var_X</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni1</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    
                <span class="c1"># average vertice temperature to the edge centers</span>
                <span class="n">var_X</span> <span class="o">=</span> <span class="n">var_X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># multiply with dz</span>
        <span class="k">if</span>   <span class="s1">&#39;nz1&#39;</span>  <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">dz</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;nz_1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">dz</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">)</span>    
        <span class="k">elif</span> <span class="s1">&#39;nz&#39;</span>   <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">dz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(((</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mesh_zmid</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span>
        <span class="n">vel_u</span><span class="p">,</span> <span class="n">vel_v</span> <span class="o">=</span> <span class="n">vel_u</span><span class="o">*</span><span class="n">dz</span><span class="p">,</span> <span class="n">vel_v</span><span class="o">*</span><span class="n">dz</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># multiple u*dy and v*(-dx) --&gt; vec_v * vec_n</span>
        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span>     <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span><span class="p">]</span>
            
        <span class="c1"># proper transport sign with respect to normal vector of section </span>
        <span class="c1"># normal vector definition --&gt; norm vector definition (-dy,dx) --&gt; shows </span>
        <span class="c1"># to the left of the e_vec</span>
        <span class="k">if</span> <span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="c1"># use velocities located at left and rights handside elements with </span>
            <span class="c1"># respect to the edge</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
                <span class="n">aux_transp</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel_u</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dy</span><span class="p">)</span> <span class="o">+</span> <span class="n">vel_v</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">dx</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux_transp</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel_u</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dy</span><span class="p">)</span> <span class="o">+</span> <span class="n">vel_v</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="p">(</span><span class="n">dx</span><span class="p">))</span>
                
        <span class="k">elif</span> <span class="s1">&#39;nod2&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="c1"># use edge centered averaged velocities, thats why this velocity needs </span>
            <span class="c1"># to be dublicated with np.repeat along the horizontal dimension</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
                <span class="c1">#vel_u, vel_v = np.repeat(vel_u, 2, axis=1), np.repeat(vel_v, 2, axis=1)</span>
                <span class="n">aux_transp</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel_u</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dy</span><span class="p">)</span> <span class="o">+</span> <span class="n">vel_v</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">dx</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="c1">#vel_u, vel_v = np.repeat(vel_u, 2, axis=0), np.repeat(vel_v, 2, axis=0)</span>
                <span class="n">aux_transp</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel_u</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dy</span><span class="p">)</span> <span class="o">+</span> <span class="n">vel_v</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="p">(</span><span class="n">dx</span><span class="p">))</span>
        
        <span class="c1">#aux_transp = vel_u.T*(-dy)</span>
        <span class="c1">#aux_transp = vel_v.T*( abs(dx))      </span>
        <span class="c1">#aux_transp = (vel_u.T*(-dy) + vel_v.T*(dx))</span>
        <span class="c1">#aux_transp = -(vel_u.T*abs(dy) + vel_v.T*abs(dx))</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># multiply transp_uv with temp </span>
        <span class="k">if</span> <span class="n">dataX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
                <span class="c1">#aux_transp = aux_transp * (np.repeat(var_X, 2, axis=1).transpose((0,2,1)) - data_Xref)</span>
                <span class="n">aux_transp</span> <span class="o">=</span> <span class="n">aux_transp</span> <span class="o">*</span> <span class="p">(</span><span class="n">var_X</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="n">data_Xref</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#aux_transp = aux_transp * (np.repeat(var_X, 2, axis=0).T - data_Xref)</span>
                <span class="n">aux_transp</span> <span class="o">=</span> <span class="n">aux_transp</span> <span class="o">*</span> <span class="p">(</span><span class="n">var_X</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">data_Xref</span><span class="p">)</span>
            
        <span class="c1">#_______________________________________________________________________</span>
        <span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">aux_attr</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">vnameU</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">vnameX</span><span class="o">==</span><span class="s1">&#39;temp&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">vnameU</span><span class="o">==</span><span class="s1">&#39;tu&#39;</span> <span class="ow">and</span> <span class="n">vnameV</span><span class="o">==</span><span class="s1">&#39;tv&#39;</span><span class="p">):</span>
            <span class="n">rho0</span> <span class="o">=</span> <span class="mi">1030</span> <span class="c1"># kg/m^3</span>
            <span class="n">cp</span>   <span class="o">=</span> <span class="mi">3850</span> <span class="c1"># J/kg/K</span>
            <span class="n">inPW</span> <span class="o">=</span> <span class="mf">1.0e-15</span>
            <span class="n">aux_transp</span> <span class="o">=</span> <span class="n">aux_transp</span> <span class="o">*</span> <span class="n">rho0</span> <span class="o">*</span> <span class="n">cp</span> <span class="o">*</span> <span class="n">inPW</span>
            <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">],</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Heat Transport&#39;</span><span class="p">,</span> <span class="s1">&#39;PW&#39;</span>
            <span class="n">vnameFLX</span> <span class="o">=</span> <span class="s1">&#39;Hflx&#39;</span>
        
        <span class="k">elif</span> <span class="p">(</span><span class="n">vnameX</span><span class="o">==</span><span class="s1">&#39;salt&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">vnameU</span><span class="o">==</span><span class="s1">&#39;su&#39;</span> <span class="ow">and</span> <span class="n">vnameV</span><span class="o">==</span><span class="s1">&#39;sv&#39;</span><span class="p">):</span>
            <span class="n">rho0</span> <span class="o">=</span> <span class="mi">1030</span> <span class="c1"># kg/m^3</span>
            <span class="c1"># 1psu = 1g(NaCl)/1kg(H2O)=1/1000--&gt; Umrechnung von psu*kg/s --&gt; kg/s --&gt;.../1000</span>
            <span class="n">aux_transp</span> <span class="o">=</span> <span class="n">aux_transp</span> <span class="o">*</span> <span class="n">rho0</span> <span class="o">/</span> <span class="mi">1000</span>
            <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">],</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Salinity Transport&#39;</span><span class="p">,</span> <span class="s1">&#39;kg/s&#39;</span>
            <span class="n">vnameFLX</span> <span class="o">=</span> <span class="s1">&#39;Sflx&#39;</span>    
            
        <span class="k">else</span><span class="p">:</span>    
            <span class="n">inSv</span> <span class="o">=</span> <span class="mf">1.0e-6</span>
            <span class="n">aux_transp</span> <span class="o">=</span> <span class="n">aux_transp</span> <span class="o">*</span> <span class="n">inSv</span>
            <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">],</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Volume Transport&#39;</span><span class="p">,</span> <span class="s1">&#39;Sv&#39;</span>
            <span class="n">vnameFLX</span> <span class="o">=</span> <span class="s1">&#39;Vflx&#39;</span>
            
        <span class="c1">#_______________________________________________________________________</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#lon = transect[&#39;path_xy&#39;][:-1,0] + (transect[&#39;path_xy&#39;][1:,0]-transect[&#39;path_xy&#39;][:-1,0])/2</span>
        <span class="c1">#lat = transect[&#39;path_xy&#39;][:-1,1] + (transect[&#39;path_xy&#39;][1:,1]-transect[&#39;path_xy&#39;][:-1,1])/2</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dist&#39;</span><span class="p">]</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># define dimensions</span>
        <span class="n">list_dimname</span><span class="p">,</span> <span class="n">list_dimsize</span><span class="p">,</span> <span class="n">list_dimval</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span>   <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> 
            <span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">list_dimsize</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">list_dimval</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span> <span class="c1">#pd.to_datetime(data.time)            </span>
        <span class="k">if</span>   <span class="s1">&#39;nz1&#39;</span>  <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> 
            <span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="n">list_dimsize</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="n">list_dimval</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nz1&#39;</span> <span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="o">.</span><span class="n">size</span>   <span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span>
        <span class="k">elif</span> <span class="s1">&#39;nz&#39;</span>   <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> 
            <span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="n">list_dimsize</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="n">list_dimval</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nz&#39;</span>  <span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="o">.</span><span class="n">size</span>   <span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span>
        <span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;horiz&#39;</span><span class="p">],</span> <span class="n">list_dimsize</span><span class="p">[</span><span class="s1">&#39;horiz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;npts&#39;</span><span class="p">,</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>    
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># define variable </span>
        <span class="n">gattrs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">gattrs</span><span class="p">[</span><span class="s1">&#39;proj&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="s1">&#39;index+depth+xy&#39;</span>
        <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;transect_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
        <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;transect_lon&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>
        <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;transect_lat&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">do_transectattr</span><span class="p">:</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;transect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span>
        <span class="n">data_vars</span><span class="p">[</span><span class="n">vnameFLX</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">list_dimname</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">aux_transp</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">)</span> 
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># define coordinates</span>
        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span>
                      <span class="s1">&#39;time&#39;</span>  <span class="p">:</span> <span class="p">(</span><span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;time&#39;</span> <span class="p">],</span> <span class="n">list_dimval</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]),</span>
                      <span class="s1">&#39;depth&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="n">list_dimval</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]),</span>
                      <span class="s1">&#39;lon&#39;</span>   <span class="p">:</span> <span class="p">(</span><span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;horiz&#39;</span><span class="p">],</span> <span class="n">lon</span><span class="p">),</span>
                      <span class="s1">&#39;lat&#39;</span>   <span class="p">:</span> <span class="p">(</span><span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;horiz&#39;</span><span class="p">],</span> <span class="n">lat</span><span class="p">),</span>
                      <span class="s1">&#39;dst&#39;</span>   <span class="p">:</span> <span class="p">(</span><span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;horiz&#39;</span><span class="p">],</span> <span class="n">dst</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;depth&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="n">list_dimval</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]),</span>
                      <span class="s1">&#39;lon&#39;</span>   <span class="p">:</span> <span class="p">(</span><span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;horiz&#39;</span><span class="p">],</span> <span class="n">lon</span><span class="p">),</span>
                      <span class="s1">&#39;lat&#39;</span>   <span class="p">:</span> <span class="p">(</span><span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;horiz&#39;</span><span class="p">],</span> <span class="n">lat</span><span class="p">),</span>
                      <span class="s1">&#39;dst&#39;</span>   <span class="p">:</span> <span class="p">(</span><span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;horiz&#39;</span><span class="p">],</span> <span class="n">dst</span><span class="p">)}</span>
        
        <span class="c1"># add more information about the transport path</span>
        <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(</span> <span class="p">[</span><span class="s1">&#39;npts1&#39;</span><span class="p">,</span><span class="s1">&#39;np2&#39;</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span><span class="p">])</span>
        <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(</span><span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;horiz&#39;</span> <span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dx&#39;</span><span class="p">])</span>
        <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(</span><span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;horiz&#39;</span> <span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_dy&#39;</span><span class="p">])</span>
        <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(</span><span class="n">list_dimname</span><span class="p">[</span><span class="s1">&#39;horiz&#39;</span> <span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span><span class="p">])</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># create dataset</span>
        <span class="k">if</span> <span class="n">is_list</span><span class="p">:</span>
            <span class="n">transp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data_vars</span><span class="o">=</span><span class="n">data_vars</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">gattrs</span><span class="p">))</span>
            <span class="c1"># we have to set the time here with assign_coords otherwise if its </span>
            <span class="c1"># setted in xr.Dataset(..., coords=dict(...),...)xarray does not </span>
            <span class="c1"># recognize the cfttime format and things like data[&#39;time.year&#39;]</span>
            <span class="c1"># are not possible</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>  
            <span class="k">if</span> <span class="n">do_info</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; --------&gt; Name:&#39;</span><span class="p">,</span> <span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;transect_name&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; mean neto transport:&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:6.4f}</span><span class="s1"> / </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; mean (+) transport :&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:6.4f}</span><span class="s1"> / </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; mean (-) transport :&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:6.4f}</span><span class="s1"> / </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; neto transport:&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:6.4f}</span><span class="s1"> / </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; (+) transport :&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:6.4f}</span><span class="s1"> / </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; (-) transport :&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:6.4f}</span><span class="s1"> / </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transp</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data_vars</span><span class="o">=</span><span class="n">data_vars</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">gattrs</span> <span class="p">)</span>
            <span class="c1"># we have to set the time here with assign_coords otherwise if its </span>
            <span class="c1"># setted in xr.Dataset(..., coords=dict(...),...)xarray does not </span>
            <span class="c1"># recognize the cfttime format and things like data[&#39;time.year&#39;]</span>
            <span class="c1"># are not possible</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">transp</span> <span class="o">=</span> <span class="n">transp</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>  
            <span class="k">if</span> <span class="n">do_info</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; --------&gt; Name:&#39;</span><span class="p">,</span> <span class="n">transp</span><span class="p">[</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;transect_name&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; mean neto transport:&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:6.4f}</span><span class="s1"> / </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; mean (+) transport :&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:6.4f}</span><span class="s1"> / </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; mean (-) transport :&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:6.4f}</span><span class="s1"> / </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; neto transport:&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:6.4f}</span><span class="s1"> / </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; (+) transport :&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:6.4f}</span><span class="s1"> / </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; (-) transport :&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:6.4f}</span><span class="s1"> / </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">transp</span><span class="p">[</span><span class="n">vnameFLX</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">,</span><span class="s1">&#39;nz1&#39;</span><span class="p">),</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aux_attr</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">transp</span><span class="p">)</span></div>



<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#___COMPUTE TRANSECT OF SCALAR VERTICE/ELEMENTAL VARIABLE_______________________</span>
<div class="viewcode-block" id="calc_transect_scalar">
<a class="viewcode-back" href="../../index.html#tripyview.sub_transect.calc_transect_scalar">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_transect_scalar</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">transects</span><span class="p">,</span> <span class="n">nodeinelem</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                         <span class="n">do_transectattr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; interpolate scalar vertice values onto cutting point position where</span>
<span class="sd">        cross-section intersects with edge</span>
<span class="sd">    </span>
<span class="sd">    Parameters: </span>
<span class="sd">        </span>
<span class="sd">        :mesh:          fesom2 tripyview mesh object,  with all mesh information </span>
<span class="sd">        </span>
<span class="sd">        :data:          object, with xarray dataset object containing 3d vertice values. </span>
<span class="sd">                        Can also be done with scalar datas on elements but than nodeinelem is needed</span>
<span class="sd">        </span>
<span class="sd">        transects:     list with analysed transect dictionary information computed by </span>
<span class="sd">                        do_analyse _trasnsects</span>
<span class="sd">                        </span>
<span class="sd">        nodeinelem:     np.array with elem indices that contribute to a vertice </span>
<span class="sd">                        point (default=None)              </span>
<span class="sd">                        </span>
<span class="sd">        :do_transectattr: bool, (default=True) write full transect info into return</span>
<span class="sd">                        xarray dataset attribute</span>
<span class="sd">                        </span>
<span class="sd">        :do_info:       bool, (default=True), write info     </span>
<span class="sd">        </span>
<span class="sd">    Return:</span>
<span class="sd">    </span>
<span class="sd">        :data:          list with returned xarray dataset object that contains to</span>
<span class="sd">                        the cutting point interpolated scalar values of transect</span>
<span class="sd">    </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t1</span><span class="o">=</span><span class="n">clock</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transects</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> 
        <span class="c1">#if len(transects)&gt;1:</span>
        <span class="n">is_list</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">csects</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">([])</span>
        <span class="c1">#else:</span>
        <span class="c1">#    is_list = False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">is_list</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">transects</span><span class="o">=</span><span class="nb">list</span><span class="p">([</span><span class="n">transects</span><span class="p">])</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">vname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">transect</span> <span class="ow">in</span> <span class="n">transects</span><span class="p">:</span>
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">if</span> <span class="s1">&#39;nod2&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
            <span class="c1"># select only necessary vertices</span>
            <span class="n">scalarP1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nod2</span><span class="o">=</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
            <span class="n">scalarP2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nod2</span><span class="o">=</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
            
            <span class="c1"># put back the nans </span>
            <span class="k">if</span> <span class="s1">&#39;nz1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span> <span class="ow">or</span> <span class="s1">&#39;nz_1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]):</span> <span class="n">scalarP1</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]):</span> <span class="n">scalarP2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">elif</span> <span class="s1">&#39;nz&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]):</span> <span class="n">scalarP1</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]):</span> <span class="n">scalarP2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                
            <span class="c1"># interpolate scalar vertice values onto cutting point position where</span>
            <span class="c1"># cross-section intersects with edge</span>
            <span class="n">scalarPcut</span> <span class="o">=</span> <span class="n">scalarP1</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="p">(</span><span class="n">scalarP2</span><span class="o">.</span><span class="n">T</span><span class="o">-</span><span class="n">scalarP1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">]</span>
            <span class="c1">#scalarPcut = scalarP1.T </span>
            <span class="c1">#scalarPcut = scalarP2.T </span>
            <span class="k">del</span><span class="p">(</span><span class="n">scalarP1</span><span class="p">,</span> <span class="n">scalarP2</span><span class="p">)</span>
            
            <span class="c1"># define lon, lat , distance arrays</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_dist&#39;</span><span class="p">]</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">elif</span> <span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nodeinelem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># select only necessary elements </span>
                <span class="n">scalarPcut</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">elem</span><span class="o">=</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span><span class="p">][::</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
                
                <span class="c1"># put back the nans </span>
                <span class="k">if</span> <span class="s1">&#39;nz1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span> <span class="ow">or</span> <span class="s1">&#39;nz_1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span><span class="p">][::</span><span class="mi">2</span><span class="p">]):</span> <span class="n">scalarPcut</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span><span class="p">[</span><span class="n">ei</span><span class="p">]:</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">elif</span> <span class="s1">&#39;nz&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_ei&#39;</span><span class="p">][::</span><span class="mi">2</span><span class="p">]):</span> <span class="n">scalarPcut</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                
                <span class="n">scalarPcut</span> <span class="o">=</span> <span class="n">scalarPcut</span><span class="o">.</span><span class="n">T</span>
                
                <span class="k">if</span> <span class="n">scalarPcut</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> 
                    <span class="c1"># define lon, lat , distance arrays</span>
                    <span class="n">lon</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">lat</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">dst</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_dist&#39;</span><span class="p">][:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># define lon, lat , distance arrays</span>
                    <span class="n">lon</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">lat</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">dst</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_dist&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># average over all elemental values that contribute to edge node 1</span>
                <span class="c1">#        o-----o</span>
                <span class="c1">#       / \   / \</span>
                <span class="c1">#      /   \ / x-\-----elem_i_p</span>
                <span class="c1">#     o-----O-----o </span>
                <span class="c1">#      \   /1\   /</span>
                <span class="c1">#       \ /   \ /  </span>
                <span class="c1">#        o-----o  </span>
                <span class="c1">#</span>
                <span class="n">elem_i_P</span> <span class="o">=</span> <span class="n">nodeinelem</span><span class="p">[:,</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">elem_A_P</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">e_area</span><span class="p">[</span><span class="n">elem_i_P</span><span class="p">]</span>
                <span class="n">elem_A_P</span><span class="p">[</span><span class="n">elem_i_P</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="n">scalarP1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">elem</span><span class="o">=</span><span class="n">elem_i_P</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span> <span class="c1">#.reshape(elem_i_P.shape)</span>
                
                <span class="c1"># set nan&#39;s from the land sea mask to zeros</span>
                <span class="n">scalarP1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">scalarP1</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
                
                <span class="n">dim1</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">scalarP1</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># --&gt; dim1 depth dimension </span>
                <span class="n">dim2</span><span class="p">,</span><span class="n">dim3</span><span class="o">=</span> <span class="n">elem_i_P</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># --&gt; dim2 total numbers of neighbouring elem, dim3 dimension edge nodes </span>
                <span class="k">del</span><span class="p">(</span><span class="n">elem_i_P</span><span class="p">)</span>
                
                <span class="c1"># weighted mean over elements that belong to node</span>
                <span class="n">scalarP1</span> <span class="o">=</span> <span class="n">scalarP1</span><span class="o">*</span><span class="n">elem_A_P</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">scalarP1</span> <span class="o">=</span> <span class="n">scalarP1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span><span class="p">,</span> <span class="n">dim3</span><span class="p">))</span>
                <span class="n">scalarP1</span> <span class="o">=</span> <span class="n">scalarP1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">elem_A_P</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">del</span><span class="p">(</span><span class="n">elem_A_P</span><span class="p">)</span>
                
                <span class="c1"># put back the nans </span>
                <span class="k">if</span> <span class="s1">&#39;nz1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span> <span class="ow">or</span> <span class="s1">&#39;nz_1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]):</span> <span class="n">scalarP1</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni</span><span class="p">]:</span>  <span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">elif</span> <span class="s1">&#39;nz&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]):</span> <span class="n">scalarP1</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    
                <span class="c1"># average elemental values to edge node 2</span>
                <span class="n">elem_i_P</span> <span class="o">=</span> <span class="n">nodeinelem</span><span class="p">[:,</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">elem_A_P</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">e_area</span><span class="p">[</span><span class="n">elem_i_P</span><span class="p">]</span>
                <span class="n">elem_A_P</span><span class="p">[</span><span class="n">elem_i_P</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="n">scalarP2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">elem</span><span class="o">=</span><span class="n">elem_i_P</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span> <span class="c1">#.reshape(elem_i_P.shape)</span>
                
                <span class="c1"># set nan&#39;s from the land sea mask to zeros</span>
                <span class="n">scalarP2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">scalarP2</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
                
                <span class="n">dim1</span><span class="p">,</span><span class="n">dum</span> <span class="o">=</span> <span class="n">scalarP2</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># --&gt; dim1 depth dimension </span>
                <span class="n">dim2</span><span class="p">,</span><span class="n">dim3</span><span class="o">=</span> <span class="n">elem_i_P</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># --&gt; dim2 total numbers of neighbouring elem, dim3 dimension edge nodes </span>
                <span class="k">del</span><span class="p">(</span><span class="n">elem_i_P</span><span class="p">)</span>
                
                <span class="c1"># weighted mean over elements that belong to node</span>
                <span class="n">scalarP2</span> <span class="o">=</span> <span class="n">scalarP2</span><span class="o">*</span><span class="n">elem_A_P</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">scalarP2</span> <span class="o">=</span> <span class="n">scalarP2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span><span class="p">,</span> <span class="n">dim3</span><span class="p">))</span>
                <span class="n">scalarP2</span> <span class="o">=</span> <span class="n">scalarP2</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">elem_A_P</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">del</span><span class="p">(</span><span class="n">elem_A_P</span><span class="p">)</span>
                
                <span class="c1"># put back the nans based on node depth</span>
                <span class="k">if</span> <span class="s1">&#39;nz1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span> <span class="ow">or</span> <span class="s1">&#39;nz_1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]):</span> <span class="n">scalarP2</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni</span><span class="p">]:</span>  <span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">elif</span> <span class="s1">&#39;nz&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_ni&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]):</span> <span class="n">scalarP2</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_iz</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                
                <span class="c1"># interpolate scalar vertice values onto cutting point position where</span>
                <span class="c1"># cross-section intersects with edge</span>
                <span class="n">scalarPcut</span> <span class="o">=</span> <span class="n">scalarP1</span> <span class="o">+</span> <span class="p">(</span><span class="n">scalarP2</span><span class="o">-</span><span class="n">scalarP1</span><span class="p">)</span><span class="o">*</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_lint&#39;</span><span class="p">]</span>
                <span class="k">del</span><span class="p">(</span><span class="n">scalarP1</span><span class="p">,</span> <span class="n">scalarP2</span><span class="p">)</span>
                
                <span class="c1"># define lon, lat , distance arrays</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_midP&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dst</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_dist&#39;</span><span class="p">]</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cant find nod2 or elem dimensions in data&#39;</span><span class="p">)</span>   
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># define dimensions</span>
        <span class="n">list_dimname</span><span class="p">,</span> <span class="n">list_dimsize</span><span class="p">,</span> <span class="n">list_dimval</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span>   <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">list_dimname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">list_dimsize</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]),</span> <span class="n">list_dimval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>             
        <span class="k">if</span>   <span class="s1">&#39;nz1&#39;</span>  <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">list_dimname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nz1&#39;</span> <span class="p">),</span> <span class="n">list_dimsize</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">list_dimval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="s1">&#39;nz_1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">list_dimname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nz_1&#39;</span><span class="p">),</span> <span class="n">list_dimsize</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">list_dimval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="p">)</span>  
        <span class="k">elif</span> <span class="s1">&#39;nz&#39;</span>   <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">list_dimname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nz&#39;</span>  <span class="p">),</span> <span class="n">list_dimsize</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">list_dimval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">)</span>  
        <span class="n">list_dimname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;npts&#39;</span><span class="p">),</span> <span class="n">list_dimsize</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dst</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        
        
        <span class="n">gattrs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">gattrs</span><span class="p">[</span><span class="s1">&#39;proj&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="s1">&#39;index+depth+xy&#39;</span>
        
        <span class="c1"># define variable </span>
        <span class="n">data_vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">lattr</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">lattr</span><span class="p">[</span><span class="s1">&#39;transect_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
        <span class="n">lattr</span><span class="p">[</span><span class="s1">&#39;transect_lon&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>
        <span class="n">lattr</span><span class="p">[</span><span class="s1">&#39;transect_lat&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">do_transectattr</span><span class="p">:</span> <span class="n">lattr</span><span class="p">[</span><span class="s1">&#39;transect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transect</span>
        
        <span class="c1">#data_vars[&#39;transp&#39;] = (list_dimname, scalarPcut, aux_attr) </span>
        <span class="n">data_vars</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">list_dimname</span><span class="p">,</span> <span class="n">scalarPcut</span><span class="p">,</span> <span class="n">lattr</span><span class="p">)</span> 
        <span class="k">del</span><span class="p">(</span><span class="n">lattr</span><span class="p">)</span>
        
        <span class="c1"># define coordinates</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_dimname</span><span class="p">):</span> 
            <span class="k">if</span> <span class="s1">&#39;npts&#39;</span> <span class="ow">in</span> <span class="n">dim</span><span class="p">:</span>
                <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
                <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
                <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;dst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;nz&#39;</span> <span class="ow">in</span> <span class="n">dim</span><span class="p">:</span>
                <span class="n">coords</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">list_dimval</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                                  
        <span class="c1">#coords    = {&#39;depth&#39; : (list_dimname[0], list_dimval[0]),</span>
                     <span class="c1">#&#39;lon&#39;   : (list_dimname[1], lon),</span>
                     <span class="c1">#&#39;lat&#39;   : (list_dimname[1], lat),</span>
                     <span class="c1">#&#39;dst&#39;   : (list_dimname[1], dst),</span>
                    <span class="c1">#}</span>

        <span class="c1"># create dataset</span>
        <span class="k">if</span> <span class="n">is_list</span><span class="p">:</span>
            <span class="n">csects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data_vars</span><span class="o">=</span><span class="n">data_vars</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">gattrs</span><span class="p">))</span>
            <span class="c1"># we have to set the time here with assign_coords otherwise if its </span>
            <span class="c1"># setted in xr.Dataset(..., coords=dict(...),...)xarray does not </span>
            <span class="c1"># recognize the cfttime format and things like data[&#39;time.year&#39;]</span>
            <span class="c1"># are not possible</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">csects</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">csects</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">csects</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data_vars</span><span class="o">=</span><span class="n">data_vars</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">gattrs</span><span class="p">)</span>
            <span class="c1"># we have to set the time here with assign_coords otherwise if its </span>
            <span class="c1"># setted in xr.Dataset(..., coords=dict(...),...)xarray does not </span>
            <span class="c1"># recognize the cfttime format and things like data[&#39;time.year&#39;]</span>
            <span class="c1"># are not possible</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">csects</span> <span class="o">=</span> <span class="n">csects</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>  
            
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">if</span> <span class="n">do_info</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        elapsed time: </span><span class="si">{:3.2f}</span><span class="s1">min.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">clock</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">csects</span><span class="p">)</span></div>



<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#___PLOT TRANSECT POSITION______________________________________________________</span>
<div class="viewcode-block" id="plot_transect_position">
<a class="viewcode-back" href="../../index.html#tripyview.sub_transect.plot_transect_position">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_transect_position</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">transect</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> 
                           <span class="n">proj</span><span class="o">=</span><span class="s1">&#39;nears&#39;</span><span class="p">,</span> <span class="n">box</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> 
                           <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="n">do_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_title</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">do_grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax_pos</span><span class="o">=</span><span class="p">[</span><span class="mf">0.90</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; plot transect positions</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :mesh:          fesom2 tripyview mesh object,  with all mesh information </span>
<span class="sd">        </span>
<span class="sd">        :transects:     list with analysed transect dictionary information computed by </span>
<span class="sd">                        do_analyse _trasnsects</span>
<span class="sd">        </span>
<span class="sd">        :edge:          provide np.array with node indices of edge (default=None)</span>
<span class="sd">        </span>
<span class="sd">        :zoom:          float, (default=None), zzom factor for nearside projection</span>
<span class="sd">        </span>
<span class="sd">        :fig:           matplotlib figure handle, (default=None)</span>
<span class="sd">        </span>
<span class="sd">        :figsize:       list, (default=[10,10]) width and height of figure</span>
<span class="sd">        </span>
<span class="sd">        :proj:          str, (default=&#39;nears&#39;), can be any other projections string</span>
<span class="sd">                        </span>
<span class="sd">                        - pc     ... PlateCarree         (box=[lonmin, lonmax, latmin, latmax])</span>
<span class="sd">                        - merc   ... Mercator            (box=[lonmin, lonmax, latmin, latmax])</span>
<span class="sd">                        - rob    ... Robinson            (box=[lonmin, lonmax, latmin, latmax])</span>
<span class="sd">                        - eqearth... EqualEarth          (box=[lonmin, lonmax, latmin, latmax])</span>
<span class="sd">                        - mol    ... Mollweide           (box=[lonmin, lonmax, latmin, latmax])</span>
<span class="sd">                        - nps    ... NorthPolarStereo    (box=[-180, 180, &gt;0, latmax])</span>
<span class="sd">                        - sps    ... SouthPolarStereo    (box=[-180, 180, latmin, &lt;0])</span>
<span class="sd">                        - ortho  ... Orthographic        (box=[loncenter, latcenter]) </span>
<span class="sd">                        - nears  ... NearsidePerspective (box=[loncenter, latcenter, zoom]) </span>
<span class="sd">                        - channel... PlateCaree</span>
<span class="sd">                        </span>
<span class="sd">        :box:           None, list (default:  [-180, 180,-90, 90]) </span>
<span class="sd">                        regional limitation of plot. For ortho...</span>
<span class="sd">                        box=[lonc, latc], nears...box=[lonc, latc, zoom], for all others box = </span>
<span class="sd">                        [lonmin, lonmax, latmin, latmax]. For nears box is computed based</span>
<span class="sd">                        on transect definition.</span>
<span class="sd">                        </span>
<span class="sd">        :do_path:       bool, (default=True) plot entire transport path       </span>
<span class="sd">        </span>
<span class="sd">        :do_labels:     bool, (default=True) draw lon, lat axes do_labels</span>
<span class="sd">        </span>
<span class="sd">        :do_title:      bool, (default=True) draw title with name of transect</span>
<span class="sd">        </span>
<span class="sd">        :do_grid:       bool, (default=False) plot fesom mesh in background</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :hfig: returns figure handle </span>

<span class="sd">        :hax: returns axes handle </span>
<span class="sd">    </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># compute zoom factor based on the length of the transect</span>
    <span class="k">if</span> <span class="n">zoom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">]))</span><span class="o">&lt;=</span><span class="mi">180</span><span class="p">:</span> 
            <span class="n">Rearth</span> <span class="o">=</span> <span class="mf">6367.5</span>  <span class="c1"># [km]</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span>  <span class="o">=</span> <span class="n">grid_cart3d</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span> <span class="n">is_deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">dist</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">Rearth</span>
            <span class="c1">#zoom = (np.pi*6367.5)/transect[&#39;edge_cut_dist&#39;].max()</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Rearth</span><span class="p">)</span><span class="o">/</span><span class="n">dist</span>
            <span class="k">del</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">proj</span> <span class="o">==</span> <span class="s1">&#39;nears&#39;</span><span class="p">:</span> <span class="n">proj</span> <span class="o">=</span> <span class="s1">&#39;rob&#39;</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">proj_from</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">proj</span> <span class="o">==</span> <span class="s1">&#39;nears&#39;</span><span class="p">:</span> <span class="n">box</span> <span class="o">=</span> <span class="p">[</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">zoom</span><span class="p">]</span>
    <span class="n">proj_to</span><span class="p">,</span> <span class="n">box</span> <span class="o">=</span> <span class="n">do_projection</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span>  <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">proj_to</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">ax_pos</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">proj_to</span><span class="p">)</span>
        
    <span class="n">pkg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">bckgrndir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">pkg_path</span><span class="o">+</span><span class="s1">&#39;/backgrounds/&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CARTOPY_USER_BACKGROUNDS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bckgrndir</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">background_img</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;bluemarble&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">if</span> <span class="n">do_grid</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">tri</span> <span class="o">=</span> <span class="n">Triangulation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_xa</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_ya</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_pbnd_0</span><span class="p">,:],</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_ia</span><span class="p">)))</span>
        
        <span class="n">tri</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">tri</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">proj_to</span><span class="o">.</span><span class="n">transform_points</span><span class="p">(</span><span class="n">proj_from</span><span class="p">,</span> <span class="n">tri</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">tri</span><span class="o">.</span><span class="n">y</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        
        <span class="n">xpts</span><span class="p">,</span> <span class="n">ypts</span> <span class="o">=</span> <span class="n">tri</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">tri</span><span class="o">.</span><span class="n">triangles</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">tri</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">tri</span><span class="o">.</span><span class="n">triangles</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span>
        
        <span class="n">crs_pts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xpts</span><span class="p">,</span><span class="n">ypts</span><span class="p">))</span>
        <span class="n">fig_pts</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">crs_pts</span><span class="p">)</span>
        <span class="n">ax_pts</span>  <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">fig_pts</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span>    <span class="o">=</span>  <span class="n">ax_pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax_pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">e_idxbox</span><span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">&gt;=-</span><span class="mf">0.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">&lt;=</span><span class="mf">1.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span><span class="o">&gt;=-</span><span class="mf">0.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span><span class="o">&lt;=</span><span class="mf">1.05</span><span class="p">)</span>
        <span class="c1">#ax.triplot(tri.x, tri.y, tri.triangles[e_idxbox,:], color=&#39;w&#39;, linewidth=0.25, alpha=0.35, transform=proj_from)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">triplot</span><span class="p">(</span><span class="n">tri</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">tri</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">tri</span><span class="o">.</span><span class="n">triangles</span><span class="p">[</span><span class="n">e_idxbox</span><span class="p">,:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1">#intersected edges </span>
    <span class="k">if</span> <span class="n">edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">edge</span><span class="p">[:,</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">]]],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">edge</span><span class="p">[:,</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_i&#39;</span><span class="p">]]],</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mf">0.75</span><span class="p">,</span><span class="mf">0.75</span><span class="p">,</span><span class="mf">0.75</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj_from</span><span class="p">)</span>

    <span class="c1"># intersection points</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span><span class="s1">&#39;limegreen&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj_from</span><span class="p">)</span>

    <span class="c1">#transport path</span>
    <span class="k">if</span> <span class="n">do_path</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span>   <span class="p">][</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;path_xy&#39;</span>   <span class="p">][</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj_from</span><span class="p">)</span>

    <span class="c1"># end start point [green] and end point [red]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj_from</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">transect</span><span class="p">[</span><span class="s1">&#39;edge_cut_P&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj_from</span><span class="p">)</span>
    
    <span class="c1">## plot cross-section </span>
    <span class="c1">#for ii, (Px, Py) in enumerate(zip(transect[&#39;Px&#39;],transect[&#39;Py&#39;])):</span>
        <span class="c1">## plot evec</span>
        <span class="c1">#ax.plot(Px, Py,&#39;k&#39;, marker=&#39;o&#39;, linestyle=&#39;None&#39;, markersize=3, markerfacecolor=&#39;w&#39;, transform=orig)</span>
        <span class="c1">##ax.quiver(Px[0]+np.diff(Px)/2.0, Py[0]+np.diff(Py)/2.0,transect[&#39;n_vec&#39;][ii][0], transect[&#39;n_vec&#39;][ii][1],</span>
                <span class="c1">##units=&#39;xy&#39;, scale_units=&#39;xy&#39;, scale=1/3, color=&#39;teal&#39;, width=1/3, edgecolor=&#39;k&#39;, linestyle=&#39;-&#39;, linewidth=0.5)</span>

    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># ax.coastlines()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_geometries</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">lsmask_p</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">draw_labels</span><span class="o">=</span><span class="n">do_labels</span><span class="p">,</span> 
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">if</span> <span class="n">do_title</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">transect</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    
    <span class="c1">#ax.set_extent([transect[&#39;edge_cut_P&#39;][:,0].min(),</span>
                   <span class="c1">#transect[&#39;edge_cut_P&#39;][:,0].max(),</span>
                   <span class="c1">#transect[&#39;edge_cut_P&#39;][:,1].min(),</span>
                   <span class="c1">#transect[&#39;edge_cut_P&#39;][:,1].max()])</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span></div>



<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#___COMPUTE ZONAL MEAN SECTION BASED ON BINNING_________________________________</span>
<div class="viewcode-block" id="load_zmeantransect_fesom2">
<a class="viewcode-back" href="../../index.html#tripyview.sub_transect.load_zmeantransect_fesom2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_zmeantransect_fesom2</span><span class="p">(</span><span class="n">mesh</span>                  <span class="p">,</span> 
                              <span class="n">data</span>                  <span class="p">,</span> 
                              <span class="n">box_list</span>              <span class="p">,</span> 
                              <span class="n">dlat</span>          <span class="o">=</span><span class="mf">0.5</span>    <span class="p">,</span> 
                              <span class="n">boxname</span>       <span class="o">=</span><span class="kc">None</span>   <span class="p">,</span>
                              <span class="n">diagpath</span>      <span class="o">=</span><span class="kc">None</span>   <span class="p">,</span> 
                              <span class="n">do_checkbasin</span> <span class="o">=</span><span class="kc">False</span>  <span class="p">,</span> 
                              <span class="n">do_compute</span>    <span class="o">=</span><span class="kc">False</span>  <span class="p">,</span> 
                              <span class="n">do_load</span>       <span class="o">=</span><span class="kc">True</span>   <span class="p">,</span> 
                              <span class="n">do_persist</span>    <span class="o">=</span><span class="kc">False</span>  <span class="p">,</span> 
                              <span class="n">do_info</span>       <span class="o">=</span><span class="kc">False</span>  <span class="p">,</span> 
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; compute zonal means transect, defined by regional box_list</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        </span>
<span class="sd">        :mesh:      fesom2 mesh object, with all mesh information</span>

<span class="sd">        :data:      xarray dataset object, or list of xarray dataset object with 3d vertice</span>
<span class="sd">                    data</span>

<span class="sd">        :box_list:  None, list (default: None)  list with regional box limitation for index computation box can be: </span>

<span class="sd">                    - [&#39;global&#39;]   ... compute global index </span>
<span class="sd">                    - [shp.Reader] ... index region defined by shapefile </span>
<span class="sd">                    - [ [lonmin,lonmax,latmin, latmax], boxname] index region defined by rect box </span>
<span class="sd">                    - [ [ [px1,px2...], [py1,py2,...]], boxname] index region defined by polygon</span>
<span class="sd">                    - [ np.array(2 x npts), boxname] index region defined by polygon</span>

<span class="sd">        :dlat:      float, (default=0.5) resolution of latitudinal bins</span>
<span class="sd">        </span>
<span class="sd">        :diagpath:  str, (default=None), path to diagnostic file only needed when </span>
<span class="sd">                    w_A weights for area average are not given in the dataset, than </span>
<span class="sd">                    he will search for the diagnostic file_loader</span>
<span class="sd">                    </span>
<span class="sd">        :do_checkbasin: bool, (default=False) additional plot with selected region/</span>
<span class="sd">                        basin information</span>
<span class="sd">                        </span>
<span class="sd">        :do_compute:    bool (default=False), do xarray dataset compute() at the end</span>
<span class="sd">                        data = data.compute(), creates a new dataobject the original</span>
<span class="sd">                        data object seems to persist</span>
<span class="sd">        </span>
<span class="sd">        :do_load:       bool (default=True), do xarray dataset load() at the end</span>
<span class="sd">                        data = data.load(), applies all operations to the original</span>
<span class="sd">                        dataset</span>
<span class="sd">                        </span>
<span class="sd">        :do_persist:    bool (default=False), do xarray dataset persist() at the end</span>
<span class="sd">                        data = data.persist(), keeps the dataset as dask array, keeps</span>
<span class="sd">                        the chunking    </span>
<span class="sd">                      </span>
<span class="sd">        :do_info:       bool (defalt=False), print variable info at the end </span>
<span class="sd">                      </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :index_list:    list with xarray dataset of zonal mean array</span>
<span class="sd">    </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># str_anod    = &#39;&#39;</span>
    <span class="n">index_list</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cnt</span>         <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># loop over box_list</span>
    <span class="n">vname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">which_ddim</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span>   <span class="s1">&#39;nz&#39;</span>  <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">which_ddim</span><span class="p">,</span> <span class="n">ndi</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="s1">&#39;nz&#39;</span> <span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nlev</span>  <span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span>     
    <span class="k">elif</span> <span class="s1">&#39;nz1&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;nz_1&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> 
        <span class="n">which_ddim</span><span class="p">,</span> <span class="n">ndi</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="s1">&#39;nz1&#39;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nlev</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span>
    
    
    <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">box_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">shp</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">box</span> <span class="o">==</span><span class="s1">&#39;global&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">box</span><span class="o">==</span><span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">box</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">boxname</span><span class="p">,</span> <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># compute box mask index for nodes</span>
        <span class="k">if</span>   <span class="s1">&#39;nod2&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">idxin</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">do_boxmask</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">do_elem</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;nod2&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>     
            <span class="n">idxin</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">do_boxmask</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">do_elem</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;elem&#39;</span><span class="p">)</span>
            
        <span class="c1">#___________________________________________________________________________</span>
        <span class="k">if</span> <span class="n">do_checkbasin</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.tri</span><span class="w"> </span><span class="kn">import</span> <span class="n">Triangulation</span>
            <span class="n">tri</span> <span class="o">=</span> <span class="n">Triangulation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_xa</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_ya</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_pbnd_0</span><span class="p">,:],</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_ia</span><span class="p">)))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">triplot</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">triplot</span><span class="p">(</span><span class="n">tri</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">tri</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">tri</span><span class="o">.</span><span class="n">triangles</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">idxin</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_pbnd_0</span><span class="p">],</span> <span class="n">idxin</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_pbnd_a</span><span class="p">]))</span> <span class="p">,:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">idxin</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">idxin</span><span class="p">],</span> <span class="s1">&#39;or&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Basin selection&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="c1">#___________________________________________________________________________</span>
        <span class="c1"># do zonal mean calculation either on nodes or on elements        </span>
        <span class="c1"># keep in mind that node area info is changing over depth--&gt; therefor load from file </span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;runid&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.mesh.diag.nc&#39;</span>            
        <span class="k">if</span> <span class="n">diagpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span>   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">],</span> <span class="n">fname</span><span class="p">)</span> <span class="p">):</span> 
                <span class="n">dname</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">])),</span><span class="s1">&#39;1/&#39;</span><span class="p">),</span> <span class="n">fname</span><span class="p">)</span> <span class="p">):</span> 
                <span class="n">dname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">])),</span><span class="s1">&#39;1/&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span> <span class="p">):</span> 
                <span class="n">dname</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;could not find directory with...mesh.diag.nc file&#39;</span><span class="p">)</span>
            
            <span class="n">diagpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dname</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">do_info</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; --&gt; found diag in directory:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">diagpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diagpath</span><span class="p">,</span><span class="n">fname</span><span class="p">)):</span>
                <span class="n">diagpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diagpath</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">diagpath</span><span class="p">)),</span><span class="s1">&#39;1/&#39;</span><span class="p">),</span><span class="n">fname</span><span class="p">))</span> <span class="p">:</span>
                <span class="n">diagpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">diagpath</span><span class="p">)),</span><span class="s1">&#39;1/&#39;</span><span class="p">),</span><span class="n">fname</span><span class="p">)</span>
                
        <span class="c1">#___________________________________________________________________________</span>
        <span class="c1"># compute area weighted vertical velocities on elements</span>
        <span class="k">if</span> <span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>        
            <span class="c1">#_______________________________________________________________________</span>
            <span class="c1"># load elem area from diag file</span>
            <span class="k">if</span> <span class="s1">&#39;w_A&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">diagpath</span><span class="p">)):</span>
                    <span class="n">nz_w_A</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">diagpath</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="s1">&#39;elem_area&#39;</span><span class="p">]</span><span class="c1">#.chunk({&#39;elem&#39;:1e4})</span>
                    <span class="k">if</span> <span class="s1">&#39;elem_n&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nz_w_A</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">nz_w_A</span> <span class="o">=</span> <span class="n">nz_w_A</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;elem_n&#39;</span><span class="p">:</span><span class="s1">&#39;elem&#39;</span><span class="p">})</span>
                    <span class="k">if</span> <span class="s1">&#39;nl&#39;</span>     <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nz_w_A</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">nz_w_A</span> <span class="o">=</span> <span class="n">nz_w_A</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;nl&#39;</span>    <span class="p">:</span><span class="s1">&#39;nz&#39;</span>  <span class="p">})</span>
                    <span class="k">if</span> <span class="s1">&#39;nl1&#39;</span>    <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nz_w_A</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">nz_w_A</span> <span class="o">=</span> <span class="n">nz_w_A</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;nl1&#39;</span>   <span class="p">:</span><span class="s1">&#39;nz1&#39;</span> <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;could not find ...mesh.diag.nc file&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">w_A</span><span class="o">=</span><span class="n">nz_w_A</span><span class="p">)</span>
                
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">new_w_A</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="n">which_ddim</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">which_ddim</span><span class="p">]})</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;w_A&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;new_w_A&#39;</span><span class="p">:</span><span class="s1">&#39;w_A&#39;</span><span class="p">})</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># select MOC basin</span>
            <span class="n">data_zm</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">elem</span><span class="o">=</span><span class="n">idxin</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># replace bottom topo with zeros</span>
            <span class="c1"># The notnull() function, often used in the context of pandas and xarray, </span>
            <span class="c1"># is used to check for non-null (non-NaN) values within a Series or DataFrame. </span>
            <span class="c1"># It returns a Boolean mask with the same shape as the input data, where </span>
            <span class="c1"># each element is True if the original element is not null, and False if </span>
            <span class="c1"># the original element is null (NaN).</span>
            <span class="c1">#mat_area = mat_area.where(mat_mean.notnull(), other=0)</span>
            <span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span> <span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># calculate area weighted mean</span>
            <span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">*</span><span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># create meridional bins --&gt; this trick is from Nils Brckemann (ICON)</span>
            <span class="n">lat_bin</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">data_zm</span><span class="o">.</span><span class="n">lat</span><span class="o">/</span><span class="n">dlat</span><span class="p">)</span><span class="o">*</span><span class="n">dlat</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;elem&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span>
        
        <span class="c1"># compute area weighted vertical velocities on vertices</span>
        <span class="k">else</span><span class="p">:</span>     
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># load vertice cluster area from diag file</span>
            <span class="k">if</span> <span class="s1">&#39;w_A&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">diagpath</span><span class="p">)):</span>
                    <span class="n">nz_w_A</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">diagpath</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="s1">&#39;nod_area&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;nod_n&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nz_w_A</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">nz_w_A</span> <span class="o">=</span> <span class="n">nz_w_A</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>  <span class="p">{</span><span class="s1">&#39;nod_n&#39;</span><span class="p">:</span><span class="s1">&#39;nod2&#39;</span><span class="p">})</span>
                    <span class="k">if</span> <span class="s1">&#39;nl&#39;</span>    <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nz_w_A</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">nz_w_A</span> <span class="o">=</span> <span class="n">nz_w_A</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>  <span class="p">{</span><span class="s1">&#39;nl&#39;</span>   <span class="p">:</span><span class="s1">&#39;nz&#39;</span>  <span class="p">})</span>
                    <span class="k">if</span> <span class="s1">&#39;nl1&#39;</span>   <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nz_w_A</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">nz_w_A</span> <span class="o">=</span> <span class="n">nz_w_A</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>  <span class="p">{</span><span class="s1">&#39;nl1&#39;</span>  <span class="p">:</span><span class="s1">&#39;nz1&#39;</span> <span class="p">})</span>    
                    <span class="n">nz_w_A</span> <span class="o">=</span> <span class="n">nz_w_A</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;nz&#39;</span><span class="p">])</span>
                    <span class="c1">#nz_w_A = nz_w_A.isel(nod2=n_idxin).load()     </span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;could not find ...mesh.diag.nc file&#39;</span><span class="p">)</span>
                
                <span class="c1"># data are on mid depth levels</span>
                <span class="k">if</span> <span class="n">which_ddim</span><span class="o">==</span><span class="s1">&#39;nz1&#39;</span><span class="p">:</span> 
                    <span class="n">nz_w_A</span> <span class="o">=</span> <span class="n">nz_w_A</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nz</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;nz&#39;</span><span class="p">:</span><span class="s1">&#39;nz1&#39;</span><span class="p">})</span>
                
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">w_A</span><span class="o">=</span><span class="n">nz_w_A</span><span class="p">)</span>
                
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># select MOC basin</span>
            <span class="n">data_zm</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">nod2</span><span class="o">=</span><span class="n">idxin</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># replace bottom topo with zeros</span>
            <span class="c1"># The notnull() function, often used in the context of pandas and xarray, </span>
            <span class="c1"># is used to check for non-null (non-NaN) values within a Series or DataFrame. </span>
            <span class="c1"># It returns a Boolean mask with the same shape as the input data, where </span>
            <span class="c1"># each element is True if the original element is not null, and False if </span>
            <span class="c1"># the original element is null (NaN).</span>
            <span class="c1">#mat_area = mat_area.where(mat_mean.notnull(), other=0)</span>
            <span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span> <span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># calculate area weighted mean</span>
            <span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">*</span><span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span>
            
            <span class="c1">#___________________________________________________________________</span>
            <span class="c1"># create meridional bins</span>
            <span class="n">lat_bin</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">data_zm</span><span class="o">.</span><span class="n">lat</span><span class="o">/</span><span class="n">dlat</span><span class="p">)</span><span class="o">*</span><span class="n">dlat</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;nod2&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span>

        <span class="c1">#___________________________________________________________________________</span>
        <span class="c1"># change area weight from coordinates to variable, create new variable for topography</span>
        <span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;var_w_A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span>
        <span class="n">data_zm</span> <span class="o">=</span> <span class="n">data_zm</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;w_A&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;var_w_A&#39;</span><span class="p">:</span><span class="s1">&#39;w_A&#39;</span><span class="p">})</span>
        
        <span class="k">if</span> <span class="n">which_ddim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="p">[</span><span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;elemiz&#39;</span><span class="p">]]</span><span class="o">*</span><span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">({</span><span class="n">which_ddim</span><span class="p">:</span><span class="mi">0</span><span class="p">}),</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;elem&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="p">[</span><span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;nodiz&#39;</span><span class="p">]]</span><span class="o">*</span><span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">({</span><span class="n">which_ddim</span><span class="p">:</span><span class="mi">0</span><span class="p">}),</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;nod2&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s1">&#39;depth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                <span class="n">data_zm</span>    <span class="o">=</span> <span class="n">data_zm</span><span class="o">.</span><span class="n">rename_vars</span><span class="p">({</span><span class="n">which_ddim</span><span class="p">:</span><span class="s1">&#39;depth&#39;</span><span class="p">})</span>
        
        <span class="c1">#___________________________________________________________________________</span>
        <span class="c1"># group data by bins</span>
        <span class="k">if</span> <span class="n">do_info</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; --&gt; do binning of latitudes&#39;</span><span class="p">)</span>
        <span class="c1">#data_zm    = data_zm.persist()</span>
        <span class="n">data_zm</span>    <span class="o">=</span> <span class="n">data_zm</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">lat_bin</span><span class="p">)</span>
        
        <span class="c1"># zonal sumation of var*weight and weight over bins</span>
        <span class="k">if</span> <span class="n">do_info</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; --&gt; do sumation/integration over bins&#39;</span><span class="p">)</span>
        <span class="n">data_zm</span>    <span class="o">=</span> <span class="n">data_zm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># compute weighted mean </span>
        <span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">/</span><span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">which_ddim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;elem&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">({</span><span class="n">which_ddim</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data_zm</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">({</span><span class="n">which_ddim</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
            <span class="n">data_zm</span> <span class="o">=</span> <span class="n">data_zm</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
        <span class="n">data_zm</span> <span class="o">=</span> <span class="n">data_zm</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;w_A&#39;</span><span class="p">)</span>
        
        <span class="c1"># transpose data from [lat x nz] --&gt; [nz x lat]</span>
        <span class="n">dtime</span><span class="p">,</span> <span class="n">dhz</span><span class="p">,</span> <span class="n">dnz</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">which_ddim</span>
        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_zm</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">dtime</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
        <span class="n">data_zm</span> <span class="o">=</span> <span class="n">data_zm</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dnz</span><span class="p">,</span> <span class="n">dhz</span><span class="p">,</span> <span class="n">missing_dims</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># change attributes</span>
        <span class="n">local_attr</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="k">if</span> <span class="s1">&#39;long_name&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; zonal mean </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">])</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; zonal mean </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span> 
        
        <span class="k">if</span> <span class="s1">&#39;short_name&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;short_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; zonal mean </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;short_name&#39;</span><span class="p">])</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;short_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; zonal mean </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span> 
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">box</span> <span class="o">==</span> <span class="s1">&#39;global&#39;</span><span class="p">:</span> 
            <span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;transect_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;global zonal mean&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">shp</span><span class="o">.</span><span class="n">Reader</span><span class="p">):</span>
            <span class="n">str_name</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">shapeName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">data_zm</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;transect_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> zonal mean&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        
        <span class="c1"># for the choice of vertical plotting mode</span>
        <span class="n">data_zm</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;proj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;index+depth+xy&#39;</span>
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">if</span> <span class="n">do_compute</span> <span class="p">:</span> <span class="n">data_zm</span> <span class="o">=</span> <span class="n">data_zm</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> 
        <span class="k">if</span> <span class="n">do_load</span>    <span class="p">:</span> <span class="n">data_zm</span> <span class="o">=</span> <span class="n">data_zm</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_persist</span> <span class="p">:</span> <span class="n">data_zm</span> <span class="o">=</span> <span class="n">data_zm</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>    
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># append index to list</span>
        <span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_zm</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">index_list</span><span class="p">)</span></div>



<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#____DO ANOMALY_________________________________________________________________</span>
<div class="viewcode-block" id="do_transect_anomaly">
<a class="viewcode-back" href="../../index.html#tripyview.sub_transect.do_transect_anomaly">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">do_transect_anomaly</span><span class="p">(</span><span class="n">index1</span><span class="p">,</span><span class="n">index2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; compute anomaly between two transect list xarray Datasets</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :index1:   list with transect xarray dataset object</span>

<span class="sd">        :index2:   list with transect xarray dataset object</span>

<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :anom:   list with  transect xarray dataset object, data1-data2</span>

<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">anom_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">for</span> <span class="n">idx1</span><span class="p">,</span><span class="n">idx2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">):</span>
    
        <span class="c1"># copy datasets object </span>
        <span class="n">anom_idx</span> <span class="o">=</span> <span class="n">idx1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">idx1_vname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">idx1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">idx2_vname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">idx2</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1">#for vname in list(anom.keys()):</span>
        <span class="k">for</span> <span class="n">vname</span><span class="p">,</span> <span class="n">vname2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">idx1_vname</span><span class="p">,</span> <span class="n">idx2_vname</span><span class="p">):</span>
            <span class="c1"># do anomalous data </span>
            <span class="n">anom_idx</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">idx1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">idx2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            
            <span class="c1"># do anomalous attributes </span>
            <span class="n">attrs_data1</span> <span class="o">=</span> <span class="n">idx1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
            <span class="n">attrs_data2</span> <span class="o">=</span> <span class="n">idx2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
            
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attrs_data1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">attrs_data1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">attrs_data2</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]:</span>
                        <span class="n">anom_idx</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;anom. &#39;</span><span class="o">+</span><span class="n">anom_idx</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> 
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;short_name&#39;</span><span class="p">]:</span>
                        <span class="n">anom_idx</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;anom. &#39;</span><span class="o">+</span><span class="n">anom_idx</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>        
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">,]:</span> 
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;descript&#39;</span><span class="p">]:</span> 
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">30</span><span class="p">:</span>
                            <span class="n">anom_idx</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="o">=</span> <span class="n">idx1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> - &#39;</span><span class="o">+</span><span class="n">idx2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>     
                            <span class="n">anom_idx</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="o">=</span> <span class="n">idx1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="n">idx2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;do_rescale&#39;</span><span class="p">]:</span> 
                        <span class="n">anom_idx</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="o">=</span> <span class="n">idx1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>    
                
                    <span class="k">elif</span> <span class="n">idx1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">idx2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                        <span class="n">anom_idx</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="o">=</span> <span class="n">idx1</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="n">idx2</span><span class="p">[</span><span class="n">vname2</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    
        <span class="c1">#___________________________________________________________________________</span>
        <span class="n">anom_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anom_idx</span><span class="p">)</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">anom_index</span><span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          
          <h3>Table of Contents</h3>
          
          <search role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
            </form>
          </search>

        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="Related">
            <a href="../../py-modindex.html" title="Python Module Index"
              >modules</a> |
            <a href="../../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Patrick Scholz.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>