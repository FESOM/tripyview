<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tripyview.sub_dmoc &#8212; tripyview 0.3.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/agogo.css?v=8513425a" />
    <script src="../../_static/documentation_options.js?v=e259d695"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../../index.html">tripyview 0.3.0 documentation</a></div>
        <div class="rel" role="navigation" aria-label="Related">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for tripyview.sub_dmoc</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">clock</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;contour.negative_linestyle&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;solid&#39;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="c1">#import matplotlib.patches as Polygon</span>
<span class="c1">#import matplotlib.path as mpltPath</span>
<span class="c1">#from matplotlib.tri import Triangulation</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shapefile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">shp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">FormatStrFormatter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.matlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">repmat</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.ma</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ma</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.sub_colormap</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.sub_utility</span><span class="w">  </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.sub_plot</span><span class="w">     </span><span class="kn">import</span> <span class="o">*</span>


<span class="c1"># ___CALCULATE MERIDIONAL OVERTURNING IN DENSITY COORDINATES___________________</span>
<span class="c1">#| Global MOC, Atlantik MOC, Indo-Pacific MOC, Indo MOC                        |</span>
<span class="c1">#|                                                                             |</span>
<span class="c1">#|                                                                             |</span>
<span class="c1">#|_____________________________________________________________________________|</span>
<div class="viewcode-block" id="load_dmoc_data">
<a class="viewcode-back" href="../../index.html#tripyview.sub_dmoc.load_dmoc_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_dmoc_data</span><span class="p">(</span><span class="n">mesh</span>                         <span class="p">,</span> 
                   <span class="n">datapath</span>                     <span class="p">,</span> 
                   <span class="n">std_dens</span>                     <span class="p">,</span>
                   <span class="n">year</span>         <span class="o">=</span> <span class="kc">None</span>          <span class="p">,</span> 
                   <span class="n">which_transf</span> <span class="o">=</span> <span class="s1">&#39;dmoc&#39;</span>        <span class="p">,</span> 
                   <span class="n">do_tarithm</span>   <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>        <span class="p">,</span> 
                   <span class="n">do_bolus</span>     <span class="o">=</span> <span class="kc">True</span>          <span class="p">,</span> 
                   <span class="n">add_bolus</span>    <span class="o">=</span> <span class="kc">False</span>         <span class="p">,</span> 
                   <span class="n">add_trend</span>    <span class="o">=</span> <span class="kc">False</span>         <span class="p">,</span> 
                   <span class="n">do_wdiap</span>     <span class="o">=</span> <span class="kc">False</span>         <span class="p">,</span> 
                   <span class="n">do_dflx</span>      <span class="o">=</span> <span class="kc">False</span>         <span class="p">,</span> 
                   <span class="n">do_zcoord</span>    <span class="o">=</span> <span class="kc">True</span>          <span class="p">,</span> 
                   <span class="n">do_useZinfo</span>  <span class="o">=</span> <span class="s1">&#39;std_dens_H&#39;</span>  <span class="p">,</span>
                   <span class="n">do_ndensz</span>    <span class="o">=</span> <span class="kc">False</span>         <span class="p">,</span> 
                   <span class="n">descript</span>     <span class="o">=</span> <span class="s1">&#39;&#39;</span>            <span class="p">,</span> 
                   <span class="n">do_compute</span>   <span class="o">=</span> <span class="kc">False</span>         <span class="p">,</span> 
                   <span class="n">do_load</span>      <span class="o">=</span> <span class="kc">True</span>          <span class="p">,</span>  
                   <span class="n">do_persist</span>   <span class="o">=</span> <span class="kc">False</span>         <span class="p">,</span> 
                   <span class="n">do_parallel</span>  <span class="o">=</span> <span class="kc">False</span>         <span class="p">,</span> 
                   <span class="n">do_info</span>      <span class="o">=</span> <span class="kc">True</span>          <span class="p">,</span> 
                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; load data that are neccessary for density moc computation</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :mesh:          fesom2 tripyview mesh object,  with all mesh information </span>
<span class="sd">        </span>
<span class="sd">        :datapath:      str, path that leads to the FESOM2 data</span>
<span class="sd">        </span>
<span class="sd">        :std_dens:      np.array with sigma2 density bins that were used in FESOM2</span>
<span class="sd">                        for the DMOC diagnostic</span>
<span class="sd">        </span>
<span class="sd">        :year:          int, list, np.array, range, default: None, single year or </span>
<span class="sd">                        list/array of years whos file should be opened</span>
<span class="sd">        </span>
<span class="sd">        :which_transf:  str (default=&#39;dmoc&#39;) which transformation should be computed</span>
<span class="sd">                        options area</span>
<span class="sd">                        </span>
<span class="sd">                        - &#39;dmoc&#39;    compute dmoc density transformation</span>
<span class="sd">                        - &#39;srf&#39;     compute density transform. from surface forcing </span>
<span class="sd">                        - &#39;inner&#39;   compute density transform. from interior mixing (dmoc-srf)</span>
<span class="sd">        </span>
<span class="sd">        :do_tarithm:    str (default=&#39;mean&#39;) do time arithmetic on time selection</span>
<span class="sd">                        option are: None, &#39;None&#39;, &#39;mean&#39;, &#39;median&#39;, &#39;std&#39;, &#39;var&#39;, &#39;max&#39;</span>
<span class="sd">                        &#39;min&#39;, &#39;sum&#39;</span>
<span class="sd">            </span>
<span class="sd">        :do_bolus:      bool (default=False) load density class divergence from bolus velolcity</span>
<span class="sd">                        and add them to the total density class divergence</span>
<span class="sd">        </span>
<span class="sd">        :add_bolus:     bool (default=False) include density class divergence from bolus velolcity</span>
<span class="sd">                        as separate varaible in xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">        :add_trend:     bool (default=False) include density class volume trend  </span>
<span class="sd">                        as separate varaible in xarray dataset object</span>
<span class="sd">        </span>
<span class="sd">        :do_wdiap:      bool (default=False) load data to be used to only look at</span>
<span class="sd">                        diapycnal vertical velocity</span>
<span class="sd">        </span>
<span class="sd">        :do_dflx:       bool (default=False) load data to be used for the computation </span>
<span class="sd">                        surface buoyancy forced transformations vertical velocities</span>
<span class="sd">        </span>
<span class="sd">        :do_zcoord:     bool (default=True)  do density MOC remapping back into zcoord</span>
<span class="sd">                        space</span>
<span class="sd">        </span>
<span class="sd">        :do_useZinfo:   str (default=&#39;std_dens_H&#39;) which data should be used for the </span>
<span class="sd">                        zcoord remapping. Options are:</span>
<span class="sd">                        </span>
<span class="sd">                        - &#39;std_dens_H&#39;   use mean layerthickness of density classes (best option)</span>
<span class="sd">                        - &#39;hydrography&#39;  use mean sigma2 hydrography to estime z position of density classes (OK), </span>
<span class="sd">                        - &#39;density_dMOC&#39; use density_dMOC variable to estime z position of density classes (Bad), </span>
<span class="sd">                        - &#39;std_dens_Z&#39;   use mean depth of density classes (very bad)</span>
<span class="sd">        </span>
<span class="sd">        :do_ndensz:     bool (default=False) alreadz compute here the density class z position</span>
<span class="sd">                        from the density class layer thickness by cumulatic sumation</span>
<span class="sd">        </span>
<span class="sd">        :descript:      str (default=&#39;&#39;), string to describe dataset is written into </span>
<span class="sd">                        variable attributes                </span>
<span class="sd">        </span>
<span class="sd">        :do_compute:    bool (default=False), do xarray dataset compute() at the end</span>
<span class="sd">                        data = data.compute(), creates a new dataobject the original</span>
<span class="sd">                        data object seems to persist</span>
<span class="sd">        </span>
<span class="sd">        :do_load:       bool (default=True), do xarray dataset load() at the end</span>
<span class="sd">                        data = data.load(), applies all operations to the original</span>
<span class="sd">                        dataset</span>
<span class="sd">        </span>
<span class="sd">        :do_persist:    bool (default=False), do xarray dataset persist() at the end</span>
<span class="sd">                        data = data.persist(), keeps the dataset as dask array, keeps</span>
<span class="sd">                        the chunking   </span>
<span class="sd">        </span>
<span class="sd">        :chunks:        dict(), (default=dict({&#39;time&#39;:&#39;auto&#39;, ...})) dictionary </span>
<span class="sd">                        with chunksize of specific dimensions. By default setted </span>
<span class="sd">                        to auto but can also be setted to specific value. In my </span>
<span class="sd">                        observation it revealed that the loading of data was a factor 2-3</span>
<span class="sd">                        faster with auto-chunking but this might has its limitation</span>
<span class="sd">                        for very large meshes </span>
<span class="sd">        </span>
<span class="sd">        :do_info:       bool (defalt=True), print variable info at the end </span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :data:          object, returns xarray dataset object with density class informations</span>
<span class="sd">        </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># ensure that attributes are preserved  during operations with yarray </span>
    <span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># number of sigma2 density levels </span>
    <span class="n">dens</span>         <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">std_dens</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ndens&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">wd</span><span class="p">,</span> <span class="n">w</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">std_dens</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dens</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">w</span><span class="p">[</span><span class="mi">0</span> <span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wd</span><span class="p">[</span><span class="mi">0</span>   <span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">wd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span>  <span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
    <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>      <span class="o">=</span> <span class="p">(</span><span class="n">wd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">wd</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span> <span class="c1"># drho @  std_dens level boundary</span>
    <span class="n">weight_dens</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ndens&quot;</span><span class="p">])</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># Load netcdf data</span>
    <span class="k">if</span> <span class="n">do_info</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; --&gt; create xarray dataset and load std_* data&#39;</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># create xarray dataset to combine data for dmoc computation</span>
    <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># add surface transformations </span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;srf&#39;</span> <span class="ow">in</span> <span class="n">which_transf</span> <span class="ow">or</span> <span class="s1">&#39;inner&#39;</span> <span class="ow">in</span> <span class="n">which_transf</span><span class="p">)</span> <span class="ow">or</span> <span class="n">do_dflx</span><span class="p">:</span> <span class="c1"># add surface fluxes</span>
        <span class="c1"># compute combined density flux: heat_flux+freshwater_flux+restoring_flux</span>
        <span class="k">if</span> <span class="n">do_dflx</span><span class="p">:</span> 
            <span class="n">data</span> <span class="o">=</span> <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;std_heat_flux&#39;</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> 
                <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> <span class="n">do_load</span><span class="o">=</span><span class="n">do_load</span><span class="p">,</span> <span class="n">do_persist</span><span class="o">=</span><span class="n">do_persist</span><span class="p">,</span> <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)</span>
            
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;std_heat_flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;std_heat_flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span>\
            <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;std_frwt_flux&#39;</span><span class="p">,</span> 
                <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> <span class="n">do_load</span><span class="o">=</span><span class="n">do_load</span><span class="p">,</span> <span class="n">do_persist</span><span class="o">=</span><span class="n">do_persist</span><span class="p">,</span> 
                <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)[</span><span class="s1">&#39;std_frwt_flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> \
            <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;std_rest_flux&#39;</span><span class="p">,</span> 
                <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> <span class="n">do_load</span><span class="o">=</span><span class="n">do_load</span><span class="p">,</span> <span class="n">do_persist</span><span class="o">=</span><span class="n">do_persist</span><span class="p">,</span> 
                <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)[</span><span class="s1">&#39;std_rest_flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">data_attrs</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">attrs</span> <span class="c1"># rescue attributes will get lost during multipolication</span>
            <span class="n">data</span>       <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;std_heat_flux&#39;</span><span class="p">:</span><span class="s1">&#39;dmoc_fd&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;ndens&#39;</span> <span class="p">:(</span><span class="s2">&quot;ndens&quot;</span><span class="p">,</span><span class="n">std_dens</span><span class="p">)})</span>
            <span class="n">data_dMOC</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_dMOC</span><span class="p">,</span> <span class="n">data</span><span class="p">],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c1"># compute single flux from heat_flux &amp; freshwater_flux &amp;restoring_flux</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_dMOC</span><span class="p">,</span> 
                <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;std_heat_flux&#39;</span><span class="p">,</span> 
                <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> <span class="n">do_load</span><span class="o">=</span><span class="n">do_load</span><span class="p">,</span> <span class="n">do_persist</span><span class="o">=</span><span class="n">do_persist</span><span class="p">,</span> 
                <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;std_heat_flux&#39;</span><span class="p">:</span><span class="s1">&#39;dmoc_fh&#39;</span><span class="p">})],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span> 
            
            <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_dMOC</span><span class="p">,</span> 
                <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;std_frwt_flux&#39;</span><span class="p">,</span> 
                <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> <span class="n">do_load</span><span class="o">=</span><span class="n">do_load</span><span class="p">,</span> <span class="n">do_persist</span><span class="o">=</span><span class="n">do_persist</span><span class="p">,</span> 
                <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;std_frwt_flux&#39;</span><span class="p">:</span><span class="s1">&#39;dmoc_fw&#39;</span><span class="p">})],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>   
            
            <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_dMOC</span><span class="p">,</span> 
                <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;std_rest_flux&#39;</span><span class="p">,</span> 
                <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> <span class="n">do_load</span><span class="o">=</span><span class="n">do_load</span><span class="p">,</span> <span class="n">do_persist</span><span class="o">=</span><span class="n">do_persist</span><span class="p">,</span> 
                <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;std_rest_flux&#39;</span><span class="p">:</span><span class="s1">&#39;dmoc_fr&#39;</span><span class="p">})],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>   
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># add density levels and density level weights</span>
        <span class="c1"># kick out dummy ndens varaible that is wrong in the files, replace it with </span>
        <span class="c1"># proper dens variable</span>
        <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;ndens&#39;</span><span class="p">)</span> 
        <span class="n">wd</span><span class="p">,</span> <span class="n">w</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">std_dens</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dens</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="p">(</span><span class="n">wd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">wd</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">wd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>  <span class="c1"># drho @  std_dens level boundary</span>
        <span class="n">w_dens</span>    <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ndens&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        
        <span class="c1"># check if input data have been chunked</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunks</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">w_dens</span> <span class="o">=</span> <span class="n">w_dens</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;ndens&#39;</span><span class="p">:</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]})</span>
            <span class="n">dens</span>   <span class="o">=</span> <span class="n">dens</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span>  <span class="s1">&#39;ndens&#39;</span><span class="p">:</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]})</span>
        <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span> <span class="s1">&#39;dens&#39;</span>  <span class="p">:</span><span class="n">dens</span>  <span class="p">,</span> \
                                              <span class="s1">&#39;w_dens&#39;</span><span class="p">:</span><span class="n">w_dens</span> <span class="p">})</span>
        <span class="k">del</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">wd</span><span class="p">,</span> <span class="n">w_dens</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># rescue global attributes will get lost during multiplication</span>
        <span class="n">gattrs</span><span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">attrs</span> 
        
        <span class="c1"># multiply with weights</span>
        <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span> <span class="o">/</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">w_dens</span> <span class="o">*</span> <span class="mi">1024</span>
        <span class="k">if</span> <span class="n">do_dflx</span><span class="p">:</span> 
            <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span> <span class="o">/</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">w_A</span><span class="c1">#--&gt; element area</span>
        
        <span class="c1"># put back global attributes</span>
        <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">gattrs</span><span class="p">)</span>
        <span class="k">del</span><span class="p">(</span><span class="n">gattrs</span><span class="p">)</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># add volume trend  </span>
    <span class="k">if</span> <span class="n">add_trend</span><span class="p">:</span>  
        <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_dMOC</span><span class="p">,</span> 
                              <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;std_dens_dVdT&#39;</span><span class="p">,</span> 
                              <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                              <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> 
                              <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;std_heat_flux&#39;</span><span class="p">:</span><span class="s1">&#39;dmoc_dvdt&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;ndens&#39;</span><span class="p">)],</span>
                              <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># skip this when doing diapycnal vertical velocity</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">do_wdiap</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">do_dflx</span><span class="p">)</span> <span class="ow">and</span> <span class="n">do_zcoord</span><span class="p">:</span>
        <span class="c1"># the std_dens_Z variable from the DMOC diagnostic output of FESOM2, does</span>
        <span class="c1"># not really allow for a proper projection onto zcoord. the DMOC in zcoord</span>
        <span class="c1"># becomes way to shallow and unrealistic in that term. </span>
        <span class="c1"># Best option do compute the projection is via the densitz class layer</span>
        <span class="c1"># thickness H, second best option is via is via the sigma2 density on vertices</span>
        <span class="c1"># and the interpolation of the densitz bins to estimate the vertical coordinate</span>
        
        <span class="c1"># check if input data have been chunked</span>
        <span class="c1"># if any(data_dMOC.chunks.values()) and any(dens.chunks.values())==False:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">and</span> <span class="n">dens</span><span class="o">.</span><span class="n">chunks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>    
            <span class="n">dens</span> <span class="o">=</span> <span class="n">dens</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span>  <span class="s1">&#39;ndens&#39;</span><span class="p">:</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]})</span>
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">if</span> <span class="n">do_useZinfo</span><span class="o">==</span><span class="s1">&#39;std_dens_H&#39;</span><span class="p">:</span>
            <span class="c1"># add vertical density class thickness</span>
            <span class="n">data_h</span> <span class="o">=</span> <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;std_dens_H&#39;</span><span class="p">,</span> 
                        <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> 
                        <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                        <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> <span class="n">do_load</span><span class="o">=</span><span class="n">do_load</span><span class="p">,</span> <span class="n">do_persist</span><span class="o">=</span><span class="n">do_persist</span><span class="p">,</span> 
                        <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;std_dens_H&#39;</span><span class="p">:</span><span class="s1">&#39;ndens_h&#39;</span><span class="p">})</span>
            <span class="n">data_h</span> <span class="o">=</span> <span class="n">data_h</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;dens&#39;</span><span class="p">:</span><span class="n">dens</span><span class="p">})</span>
            <span class="n">data_h</span> <span class="o">=</span> <span class="n">data_h</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;ndens&#39;</span><span class="p">,</span> <span class="s1">&#39;elemi&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span> <span class="c1">#--&gt; drop not needed variables</span>
            <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_dMOC</span><span class="p">,</span> <span class="n">data_h</span><span class="p">],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">do_ndensz</span><span class="p">:</span>
                <span class="c1"># compute vertical density class z position from class thickness by </span>
                <span class="c1"># cumulative summation </span>
                <span class="n">data_z</span> <span class="o">=</span> <span class="n">data_h</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;ndens_h&#39;</span><span class="p">:</span><span class="s1">&#39;ndens_z&#39;</span><span class="p">})</span>
                <span class="n">data_z</span> <span class="o">=</span> <span class="n">data_z</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;ndens&#39;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1">#data_z = data_z.assign_coords({&#39;ndens&#39; :(&quot;ndens&quot;,std_dens)})</span>
                <span class="n">data_z</span> <span class="o">=</span> <span class="n">data_z</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_h</span><span class="o">.</span><span class="n">ndens_h</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_dMOC</span><span class="p">,</span> <span class="n">data_z</span><span class="p">],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>
                <span class="k">del</span><span class="p">(</span><span class="n">data_z</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">data_h</span><span class="p">)</span>
            
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">elif</span> <span class="n">do_useZinfo</span><span class="o">==</span><span class="s1">&#39;std_dens_Z&#39;</span><span class="p">:</span>
            <span class="c1"># add vertical density class position computed in FESOM2 --&gt;</span>
            <span class="c1"># gives worst results for zcoordinate projection</span>
            <span class="n">data_z</span> <span class="o">=</span> <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;std_dens_Z&#39;</span>   <span class="p">,</span> 
                        <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> 
                        <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                        <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> <span class="n">do_load</span><span class="o">=</span><span class="n">do_load</span><span class="p">,</span> <span class="n">do_persist</span><span class="o">=</span><span class="n">do_persist</span><span class="p">,</span> 
                        <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;std_dens_Z&#39;</span><span class="p">:</span><span class="s1">&#39;ndens_z&#39;</span><span class="p">})</span>
            <span class="n">data_z</span> <span class="o">=</span> <span class="n">data_z</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;dens&#39;</span><span class="p">:</span><span class="n">dens</span><span class="p">})</span>
            <span class="n">data_z</span> <span class="o">=</span> <span class="n">data_z</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;ndens&#39;</span><span class="p">,</span> <span class="s1">&#39;elemi&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span> <span class="c1">#--&gt; drop not needed variables</span>
            <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_dMOC</span><span class="p">,</span> <span class="n">data_z</span><span class="p">],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">data_z</span><span class="p">)</span>
            
        <span class="c1">#_______________________________________________________________________</span>
        <span class="k">elif</span> <span class="n">do_useZinfo</span><span class="o">==</span><span class="s1">&#39;density_dMOC&#39;</span> <span class="ow">or</span> <span class="n">do_useZinfo</span><span class="o">==</span><span class="s1">&#39;hydrography&#39;</span><span class="p">:</span>
            <span class="c1"># load sigma2 density on nodes </span>
            <span class="k">if</span> <span class="n">do_useZinfo</span><span class="o">==</span><span class="s1">&#39;density_dMOC&#39;</span><span class="p">:</span>
                <span class="n">data_sigma2</span> <span class="o">=</span> <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;density_dMOC&#39;</span><span class="p">,</span> 
                            <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> 
                            <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_zarithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                            <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> <span class="n">do_load</span><span class="o">=</span><span class="n">do_load</span><span class="p">,</span> <span class="n">do_persist</span><span class="o">=</span><span class="n">do_persist</span><span class="p">,</span> 
                            <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;density_dMOC&#39;</span><span class="p">:</span><span class="s1">&#39;nz_rho&#39;</span><span class="p">})</span>
                
                <span class="c1"># make land sea mask nan</span>
                <span class="n">data_sigma2</span> <span class="o">=</span> <span class="n">data_sigma2</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_sigma2</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">)</span>
            
                <span class="c1"># first put back here the land sea mask nan&#39;s than subtract ref </span>
                <span class="c1"># denity --&lt;&gt; like that land remains Nan respective zero later</span>
                <span class="n">data_sigma2</span> <span class="o">=</span> <span class="n">data_sigma2</span> <span class="o">-</span> <span class="mf">1000.00</span>
            
            <span class="k">elif</span> <span class="n">do_useZinfo</span><span class="o">==</span><span class="s1">&#39;hydrography&#39;</span><span class="p">:</span>
                <span class="c1"># load sigma2 density on nodes based on temperatur and salinity</span>
                <span class="c1"># hydrography</span>
                <span class="n">data_sigma2</span> <span class="o">=</span> <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;sigma2&#39;</span><span class="p">,</span> 
                            <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> 
                            <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_zarithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                            <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> <span class="n">do_load</span><span class="o">=</span><span class="n">do_load</span><span class="p">,</span> <span class="n">do_persist</span><span class="o">=</span><span class="n">do_persist</span><span class="p">,</span> 
                            <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;sigma2&#39;</span><span class="p">:</span><span class="s1">&#39;nz_rho&#39;</span><span class="p">})</span>
                
                <span class="c1"># make land sea mask nan --&gt; here ref density is already substracted</span>
                <span class="n">data_sigma2</span> <span class="o">=</span> <span class="n">data_sigma2</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_sigma2</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">)</span>
            
            <span class="n">data_sigma2</span>  <span class="o">=</span> <span class="n">data_sigma2</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;ndens&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;nodi&#39;</span><span class="p">,</span> <span class="s1">&#39;nodiz&#39;</span><span class="p">,</span> <span class="s1">&#39;w_A&#39;</span><span class="p">])</span> 
            <span class="n">data_sigma2</span>  <span class="o">=</span> <span class="n">data_sigma2</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;dens&#39;</span><span class="p">:</span><span class="n">dens</span><span class="p">})</span>
            
            <span class="c1"># have to do it via assign otherwise cant write [elem x ndens] into [nod2d x ndens] </span>
            <span class="c1"># array an save the attributes in the same time</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_sigma2</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
                <span class="n">data_sigma2</span>  <span class="o">=</span> <span class="n">data_sigma2</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">nz_rho</span><span class="o">=</span><span class="n">data_sigma2</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">data_sigma2</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][:,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;elem&quot;</span><span class="p">,</span><span class="s1">&#39;n3&#39;</span><span class="p">]),:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_sigma2</span>  <span class="o">=</span> <span class="n">data_sigma2</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">nz_rho</span><span class="o">=</span><span class="n">data_sigma2</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">data_sigma2</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span>   <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;elem&quot;</span><span class="p">,</span><span class="s1">&#39;n3&#39;</span><span class="p">]),:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">)</span>
            
            <span class="c1"># Check if the dataset is empty</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span> <span class="n">data_sigma2</span> <span class="o">=</span> <span class="n">data_sigma2</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;ndens&#39;</span><span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">})</span>
            <span class="k">else</span>                      <span class="p">:</span> <span class="n">data_sigma2</span> <span class="o">=</span> <span class="n">data_sigma2</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">],</span> <span class="s1">&#39;ndens&#39;</span><span class="p">:</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]})</span>
            
            <span class="n">data_sigma2</span> <span class="o">=</span> <span class="n">data_sigma2</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_sigma2</span><span class="o">.</span><span class="n">nz_rho</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
            
            <span class="c1"># add to Dataset</span>
            <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_dMOC</span><span class="p">,</span> <span class="n">data_sigma2</span><span class="p">],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">data_sigma2</span><span class="p">)</span>
            
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">do_dflx</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="s1">&#39;inner&#39;</span> <span class="ow">in</span> <span class="n">which_transf</span> <span class="ow">or</span> <span class="s1">&#39;dmoc&#39;</span> <span class="ow">in</span> <span class="n">which_transf</span> <span class="p">):</span>
        <span class="c1"># check if input data have been chunked</span>
        <span class="c1"># if any(data_dMOC.chunks.values()) and any(dens.chunks.values())==False:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">and</span> <span class="n">dens</span><span class="o">.</span><span class="n">chunks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dens</span> <span class="o">=</span> <span class="n">dens</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span>  <span class="s1">&#39;ndens&#39;</span><span class="p">:</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]})</span>
        
        <span class="c1"># add divergence of density classes --&gt; diapycnal velocity</span>
        <span class="n">data_div</span>  <span class="o">=</span> <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;std_dens_DIV&#39;</span> <span class="p">,</span> 
                        <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> 
                        <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                        <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> <span class="n">do_load</span><span class="o">=</span><span class="n">do_load</span><span class="p">,</span> <span class="n">do_persist</span><span class="o">=</span><span class="n">do_persist</span><span class="p">,</span> 
                        <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;std_dens_DIV&#39;</span><span class="p">:</span><span class="s1">&#39;dmoc&#39;</span><span class="p">})</span>
        <span class="n">data_div</span>  <span class="o">=</span> <span class="n">data_div</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;ndens&#39;</span><span class="p">,</span> <span class="s1">&#39;nodi&#39;</span><span class="p">])</span> 
        <span class="n">data_div</span>  <span class="o">=</span> <span class="n">data_div</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;dens&#39;</span><span class="p">:</span><span class="n">dens</span><span class="p">})</span>
        
        <span class="c1"># doing this step here so that the MOC amplitude is correct, setp 1 of 2</span>
        <span class="c1"># divide with verice area</span>
        <span class="n">gattrs</span>   <span class="o">=</span> <span class="n">data_div</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">data_div</span> <span class="o">=</span> <span class="n">data_div</span><span class="o">/</span><span class="n">data_div</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span>    <span class="c1"># --&gt; vertice area</span>
        
        <span class="c1"># save global attributes</span>
        <span class="n">data_div</span> <span class="o">=</span> <span class="n">data_div</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">gattrs</span><span class="p">)</span>
        
        <span class="c1"># skip this when doing diapycnal vertical velocity</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_wdiap</span><span class="p">:</span>
            <span class="n">data_div</span>  <span class="o">=</span> <span class="n">data_div</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;w_A&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">])</span> <span class="c1"># --&gt; dont need from here on anymor</span>
            
            <span class="c1"># have to do it via assign otherwise cant write [elem x ndens] into [nod2d x ndens] </span>
            <span class="c1"># array an save the attributes in the same time, also i need to unchunk</span>
            <span class="c1"># here the array with .load() otherwise i was not able to reindex it </span>
            <span class="c1"># without causing problems </span>
            <span class="n">data_div</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">data_div</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_div</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
                <span class="n">data_div</span> <span class="o">=</span> <span class="n">data_div</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span> <span class="n">dmoc</span><span class="o">=</span><span class="n">data_div</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">][:,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;elem&quot;</span><span class="p">,</span><span class="s1">&#39;n3&#39;</span><span class="p">]),:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_div</span> <span class="o">=</span> <span class="n">data_div</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span> <span class="n">dmoc</span><span class="o">=</span><span class="n">data_div</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">][</span>   <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;elem&quot;</span><span class="p">,</span><span class="s1">&#39;n3&#39;</span><span class="p">]),:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span> <span class="n">data_div</span> <span class="o">=</span> <span class="n">data_div</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;ndens&#39;</span><span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">})</span>
            <span class="k">else</span>                      <span class="p">:</span> <span class="n">data_div</span> <span class="o">=</span> <span class="n">data_div</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">],</span> <span class="s1">&#39;ndens&#39;</span><span class="p">:</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]})</span>
            
            <span class="c1"># multiply with elemental area</span>
            <span class="k">if</span> <span class="s1">&#39;w_A&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span><span class="n">data_div</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">]}))</span>
                <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span><span class="n">data_div</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">]}))</span>
                <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">w_A</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_area</span>                       <span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span><span class="n">data_div</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">]}))</span>
            
            <span class="c1"># doing this step here so that the MOC amplitude is correct, setp 2 of 2</span>
            <span class="c1"># multiply with elemental area</span>
            <span class="n">gattrs</span>   <span class="o">=</span> <span class="n">data_div</span><span class="o">.</span><span class="n">attrs</span>
            <span class="n">data_div</span> <span class="o">=</span> <span class="n">data_div</span><span class="o">*</span><span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span><span class="c1"># --&gt; element area</span>
            
            <span class="c1"># save global attributes</span>
            <span class="n">data_div</span> <span class="o">=</span> <span class="n">data_div</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">gattrs</span><span class="p">)</span>
            
        <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_dMOC</span><span class="p">,</span> <span class="n">data_div</span><span class="p">],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>  
        <span class="k">del</span><span class="p">(</span><span class="n">data_div</span><span class="p">)</span>
        
        <span class="c1"># load density class divergence from bolus velolcity</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">do_bolus</span><span class="p">):</span> 
            <span class="c1"># add divergence of density classes --&gt; diapycnal velocity</span>
            <span class="n">data_div_bolus</span>  <span class="o">=</span> <span class="n">load_data_fesom2</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">vname</span><span class="o">=</span><span class="s1">&#39;std_dens_DIVbolus&#39;</span> <span class="p">,</span> 
                                    <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">descript</span><span class="o">=</span><span class="n">descript</span> <span class="p">,</span> <span class="n">do_info</span><span class="o">=</span><span class="n">do_info</span><span class="p">,</span> 
                                    <span class="n">do_ie2n</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_tarithm</span><span class="o">=</span><span class="n">do_tarithm</span><span class="p">,</span> <span class="n">do_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                    <span class="n">do_compute</span><span class="o">=</span><span class="n">do_compute</span><span class="p">,</span> <span class="n">do_load</span><span class="o">=</span><span class="n">do_load</span><span class="p">,</span> <span class="n">do_persist</span><span class="o">=</span><span class="n">do_persist</span><span class="p">,</span> 
                                    <span class="n">do_parallel</span><span class="o">=</span><span class="n">do_parallel</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;std_dens_DIVbolus&#39;</span><span class="p">:</span><span class="s1">&#39;dmoc_bolus&#39;</span><span class="p">})</span>
            <span class="n">data_div_bolus</span>  <span class="o">=</span> <span class="n">data_div_bolus</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;ndens&#39;</span><span class="p">,</span> <span class="s1">&#39;nodi&#39;</span><span class="p">])</span> 
            <span class="n">data_div_bolus</span>  <span class="o">=</span> <span class="n">data_div_bolus</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;dens&#39;</span><span class="p">:</span><span class="n">dens</span><span class="p">})</span>
            
            <span class="c1"># doing this step here so that the MOC amplitude is correct, setp 1 of 2</span>
            <span class="c1"># divide with verice area</span>
            <span class="n">gattrs</span>          <span class="o">=</span> <span class="n">data_div_bolus</span><span class="o">.</span><span class="n">attrs</span>
            <span class="n">data_div_bolus</span>  <span class="o">=</span> <span class="n">data_div_bolus</span><span class="o">/</span><span class="n">data_div_bolus</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span> <span class="c1"># --&gt; vertice area</span>
            
            <span class="c1"># save global attributes</span>
            <span class="n">data_div_bolus</span>  <span class="o">=</span> <span class="n">data_div_bolus</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">gattrs</span><span class="p">)</span>
            
            <span class="c1"># skip this when doing diapycnal vertical velocity</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">do_wdiap</span><span class="p">:</span>
                <span class="n">data_div_bolus</span>  <span class="o">=</span> <span class="n">data_div_bolus</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;w_A&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">])</span> <span class="c1"># --&gt; dont need from here on anymore</span>
            
                <span class="c1"># have to do it via assign otherwise cant write [elem x ndens] into [nod2d x ndens] </span>
                <span class="c1"># array an save the attributes in the same time</span>
                <span class="n">data_div_bolus</span><span class="p">[</span><span class="s1">&#39;dmoc_bolus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_div_bolus</span><span class="p">[</span><span class="s1">&#39;dmoc_bolus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_div_bolus</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
                    <span class="n">data_div_bolus</span>  <span class="o">=</span> <span class="n">data_div_bolus</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span> <span class="n">dmoc_bolus</span><span class="o">=</span><span class="n">data_div_bolus</span><span class="p">[</span><span class="s1">&#39;dmoc_bolus&#39;</span><span class="p">][:,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;elem&quot;</span><span class="p">,</span><span class="s1">&#39;n3&#39;</span><span class="p">]),</span> <span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data_div_bolus</span>  <span class="o">=</span> <span class="n">data_div_bolus</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span> <span class="n">dmoc_bolus</span><span class="o">=</span><span class="n">data_div_bolus</span><span class="p">[</span><span class="s1">&#39;dmoc_bolus&#39;</span><span class="p">][</span>   <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;elem&quot;</span><span class="p">,</span><span class="s1">&#39;n3&#39;</span><span class="p">]),:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;n3&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">)</span>
                
                <span class="c1"># Check if the dataset is empty</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span> <span class="n">data_div_bolus</span> <span class="o">=</span> <span class="n">data_div_bolus</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;ndens&#39;</span><span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">})</span>
                <span class="k">else</span>                      <span class="p">:</span> <span class="n">data_div_bolus</span> <span class="o">=</span> <span class="n">data_div_bolus</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;elem&#39;</span><span class="p">:</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">],</span> <span class="s1">&#39;ndens&#39;</span><span class="p">:</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">chunksizes</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]})</span>
                
                <span class="c1"># doing this step here so that the MOC amplitude is correct, setp 1 of 2</span>
                <span class="c1"># multiply with elemental area</span>
                <span class="n">data_div_bolus</span> <span class="o">=</span> <span class="n">data_div_bolus</span><span class="o">*</span><span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span><span class="c1"># --&gt; element area</span>
            
            <span class="c1"># add bolus dmoc to existing dmoc --&gt; thus only one array to process</span>
            <span class="k">if</span> <span class="n">add_bolus</span><span class="p">:</span>
                <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">data_div_bolus</span><span class="p">[</span><span class="s1">&#39;dmoc_bolus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>     
                <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_dMOC</span><span class="p">,</span> <span class="n">data_div_bolus</span><span class="p">],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s2">&quot;no_conflicts&quot;</span><span class="p">)</span>  
            <span class="k">del</span><span class="p">(</span><span class="n">data_div_bolus</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># drop unnecessary coordinates</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">do_wdiap</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">do_dflx</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;lon&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span> <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;lon&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;elemi&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span> <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;elemi&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;nodi&#39;</span>  <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span> <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;nodi&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;nzi&#39;</span>   <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span> <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;nzi&#39;</span><span class="p">])</span>
    
    <span class="n">str_proj</span> <span class="o">=</span> <span class="s1">&#39;dmoc&#39;</span>
    <span class="k">if</span> <span class="n">do_zcoord</span><span class="p">:</span> <span class="n">str_proj</span> <span class="o">=</span> <span class="n">str_proj</span> <span class="o">+</span> <span class="s1">&#39;+depth&#39;</span>
    <span class="k">else</span>        <span class="p">:</span> <span class="n">str_proj</span> <span class="o">=</span> <span class="n">str_proj</span> <span class="o">+</span> <span class="s1">&#39;+dens&#39;</span>
    <span class="n">data_dMOC</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;proj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_proj</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sending large graph of size&quot;</span><span class="p">)</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Large object of size </span><span class="se">\\</span><span class="s2">d+</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">d+ detected in task graph&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">do_compute</span><span class="p">:</span> <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">do_load</span>   <span class="p">:</span> <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">do_persist</span><span class="p">:</span> <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">resetwarnings</span><span class="p">()</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># return combined xarray dataset object</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data_dMOC</span><span class="p">)</span></div>

    


<span class="c1"># ___CALCULATE MERIDIONAL OVERTURNING IN DENSITY COORDINATES___________________</span>
<span class="c1">#| Global MOC, Atlantik MOC, Indo-Pacific MOC, Indo MOC                        |</span>
<span class="c1">#|                                                                             |</span>
<span class="c1">#|                                                                             |</span>
<span class="c1">#|_____________________________________________________________________________|</span>
<div class="viewcode-block" id="calc_dmoc">
<a class="viewcode-back" href="../../index.html#tripyview.sub_dmoc.calc_dmoc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_dmoc</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> 
              <span class="n">data_dMOC</span><span class="p">,</span> 
              <span class="n">dlat</span>              <span class="o">=</span> <span class="mf">1.0</span>       <span class="p">,</span> 
              <span class="n">which_moc</span>         <span class="o">=</span> <span class="s1">&#39;gmoc&#39;</span>    <span class="p">,</span> 
              <span class="n">which_transf</span>      <span class="o">=</span> <span class="kc">None</span>      <span class="p">,</span> 
              <span class="n">do_checkbasin</span>     <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span>
              <span class="n">exclude_meditoce</span>  <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span> 
              <span class="n">do_bolus</span>          <span class="o">=</span> <span class="kc">True</span>      <span class="p">,</span> 
              <span class="n">do_parallel</span>       <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span> 
              <span class="n">n_workers</span>         <span class="o">=</span> <span class="mi">10</span>        <span class="p">,</span> 
              <span class="n">do_compute</span>        <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span> 
              <span class="n">do_load</span>           <span class="o">=</span> <span class="kc">True</span>      <span class="p">,</span> 
              <span class="n">do_persist</span>        <span class="o">=</span> <span class="kc">False</span>     <span class="p">,</span> 
              <span class="n">do_info</span>           <span class="o">=</span> <span class="kc">True</span>      <span class="p">,</span> 
              <span class="n">do_dropvar</span>        <span class="o">=</span> <span class="kc">True</span>      <span class="p">,</span> 
              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; calculate meridional overturning circulation from vertical velocities </span>
<span class="sd">        (Pseudostreamfunction) either on vertices or elements</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">        :mesh:          fesom2 tripyview mesh object,  with all mesh information </span>
<span class="sd">        </span>
<span class="sd">        :data_dMOC:     xarray dataset object with 3d density class data</span>
<span class="sd">        </span>
<span class="sd">        :dlat:          float (default=1.0), latitudinal binning resolution</span>
<span class="sd">        </span>
<span class="sd">        :which_moc:     str, shp.Reader() (default=&#39;gmox&#39;) which global or regional </span>
<span class="sd">                        MOC should be computed based on present day shapefiles. </span>
<span class="sd">                        ·Options are:</span>
<span class="sd">                        </span>
<span class="sd">                        - &#39;gmoc&#39;  ... compute global MOC</span>
<span class="sd">                        - &#39;amoc&#39;  ... compute MOC for Atlantic Basin</span>
<span class="sd">                        - &#39;aamoc&#39; ... compute MOC for Atlantic+Arctic Basin</span>
<span class="sd">                        - &#39;pmoc&#39;  ... compute MOC for Pacific Basin</span>
<span class="sd">                        - &#39;ipmoc&#39; ... compute MOC for Indo-Pacific Basin (PMOC how it should be)</span>
<span class="sd">                        - &#39;imoc&#39;  ... compute MOC for Indian-Ocean Basin</span>
<span class="sd">                        - shp.Reader(&#39;path&#39;) ... compute MOC based on custom shapefile</span>
<span class="sd">                        </span>
<span class="sd">                        Important:</span>
<span class="sd">                        Between &#39;amoc&#39; and &#39;aamoc&#39; there is not much difference </span>
<span class="sd">                        in variability, but upto 1.5Sv in amplitude. Where &#39;aamoc&#39;</span>
<span class="sd">                        is stronger than &#39;amoc&#39;. There is no clear rule which one </span>
<span class="sd">                        is better, just be sure you are consistent       </span>
<span class="sd">                        </span>
<span class="sd">        :which_transf:  str (default=&#39;dmoc&#39;) which transformation should be computed</span>
<span class="sd">                        options area</span>
<span class="sd">                        </span>
<span class="sd">                        - &#39;dmoc&#39;    compute dmoc density transformation</span>
<span class="sd">                        - &#39;srf&#39;     compute density transform. from surface forcing </span>
<span class="sd">                        - &#39;inner&#39;   compute density transform. from interior mixing (dmoc-srf)</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        :do_checkbasin: bool (default=False) provide plot with regional basin selection</span>
<span class="sd">        </span>
<span class="sd">        :exclude_meditoce: bool (default=False) exclude mediteranian sea from basin selection</span>
<span class="sd">        </span>
<span class="sd">        :do_bolus:      bool (default=False) load density class divergence from bolus velolcity</span>
<span class="sd">                        and add them to the total density class divergence</span>
<span class="sd">                        </span>
<span class="sd">        :do_dropvar:    bool (default=true) drop all variables from dataset that are not                </span>
<span class="sd">                        absolutely needed</span>
<span class="sd">                        </span>
<span class="sd">        :do_parallel:   bool (default=False) do computation of binning based MOC </span>
<span class="sd">                        in parallel</span>
<span class="sd">        </span>
<span class="sd">        :n_workers:     int (default=10) how many worker (CPUs) are used for the </span>
<span class="sd">                        parallelized MOC computation</span>
<span class="sd">                        </span>
<span class="sd">                        </span>
<span class="sd">        :do_compute:    bool (default=False), do xarray dataset compute() at the end</span>
<span class="sd">                        data = data.compute(), creates a new dataobject the original</span>
<span class="sd">                        data object seems to persist</span>
<span class="sd">        </span>
<span class="sd">        :do_load:       bool (default=True), do xarray dataset load() at the end</span>
<span class="sd">                        data = data.load(), applies all operations to the original</span>
<span class="sd">                        dataset</span>
<span class="sd">                        </span>
<span class="sd">        :do_persist:    bool (default=False), do xarray dataset persist() at the end</span>
<span class="sd">                        data = data.persist(), keeps the dataset as dask array, keeps</span>
<span class="sd">                        the chunking   </span>
<span class="sd">                        </span>
<span class="sd">        :do_info:       bool (defalt=True), print variable info at the end </span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        :dmoc:          object, returns xarray dataset object with DMOC</span>
<span class="sd">        </span>
<span class="sd">    ::</span>
<span class="sd">    </span>
<span class="sd">        data_list = list()</span>
<span class="sd">        </span>
<span class="sd">        data = tpv.load_dmoc_data(mesh, datapath, std_dens, year=year, which_transf=&#39;dmoc&#39;, descript=descript,</span>
<span class="sd">                      do_zcoord=True, do_bolus=True, do_load=False, do_persist=True)</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">        dmoc     = tpv.calc_dmoc(mesh, data, dlat=1.0, which_moc=vname, which_transf=&#39;dmoc&#39;)</span>
<span class="sd">        </span>
<span class="sd">        data_list.append( dmoc )</span>
<span class="sd">    </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># rescue global dataset attributes</span>
    <span class="n">gattr</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">attrs</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">t1</span><span class="o">=</span><span class="n">clock</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># In case MOC is defined via string</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_moc</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">which_moc_name</span> <span class="o">=</span> <span class="n">which_moc</span>
        <span class="k">if</span> <span class="n">do_info</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;_____calc. &#39;</span><span class="o">+</span><span class="n">which_moc</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39; from vertical velocities via meridional bins_____&#39;</span><span class="p">)</span>
    
    <span class="c1"># In case MOC is defined via  custom shapefile e.g for deep paleo time slices</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_moc</span><span class="p">,</span> <span class="n">shp</span><span class="o">.</span><span class="n">Reader</span><span class="p">):</span>
        <span class="c1"># Extract the &#39;Name&#39; attribute for each shape</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">which_moc</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">which_moc_name</span><span class="p">,</span> <span class="n">which_moc_region</span> <span class="o">=</span> <span class="s1">&#39;moc&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># search for &quot;Name&quot; attribute in shapefile</span>
        <span class="k">if</span> <span class="s2">&quot;Name&quot;</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">which_moc</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)</span>
            <span class="n">which_moc_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">which_moc</span><span class="o">.</span><span class="n">records</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># search for &quot;Region&quot; attribute in shapefile    </span>
        <span class="k">if</span> <span class="s2">&quot;Region&quot;</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">which_moc</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
            <span class="n">which_moc_region</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">which_moc</span><span class="o">.</span><span class="n">records</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="n">do_info</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;_____calc. &#39;</span><span class="o">+</span><span class="n">which_moc_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39; from vertical velocities via meridional bins_____&#39;</span><span class="p">)</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># compute/use index for basin domain limitation</span>
    <span class="n">idxin</span>     <span class="o">=</span> <span class="n">calc_basindomain_fast</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">which_moc</span><span class="o">=</span><span class="n">which_moc</span><span class="p">,</span> <span class="n">do_onelem</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_meditoce</span><span class="o">=</span><span class="n">exclude_meditoce</span><span class="p">)</span>

    <span class="c1"># reduce to dMOC data to basin domain</span>
    <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">elem</span><span class="o">=</span><span class="n">idxin</span><span class="p">)</span>
    
    <span class="c1"># check basin selection </span>
    <span class="k">if</span> <span class="n">do_checkbasin</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.tri</span><span class="w"> </span><span class="kn">import</span> <span class="n">Triangulation</span>
        <span class="n">tri</span> <span class="o">=</span> <span class="n">Triangulation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_x</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_xa</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_y</span><span class="p">,</span><span class="n">mesh</span><span class="o">.</span><span class="n">n_ya</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_i</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_pbnd_0</span><span class="p">,:],</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_ia</span><span class="p">)))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">triplot</span><span class="p">(</span><span class="n">tri</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">triplot</span><span class="p">(</span><span class="n">tri</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">tri</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">tri</span><span class="o">.</span><span class="n">triangles</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">idxin</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_pbnd_0</span><span class="p">],</span> <span class="n">idxin</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_pbnd_a</span><span class="p">]))</span> <span class="p">,:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Basin selection&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># prepare  weights for area weighted mean over the elements for all density </span>
    <span class="c1"># classes and depth levels (in case nz_rho is loaded)</span>
    <span class="n">edims</span>  <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">dimsrt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">dtime</span><span class="o">=</span><span class="s1">&#39;None&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> 
        <span class="n">edims</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">dtime</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span>
    <span class="n">edims</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">delem</span><span class="p">,</span> <span class="n">ddens</span> <span class="o">=</span> <span class="s1">&#39;elem&#39;</span><span class="p">,</span> <span class="s1">&#39;ndens&#39;</span>
    
    <span class="k">if</span> <span class="s1">&#39;ndens_h&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="s1">&#39;ndens_z&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c1"># expand by ndens dimension --&gt; need this here to get proper area weighting </span>
        <span class="c1"># mean over the bottom topography!!!</span>
        <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;ndens_w_A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">edims</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dtime</span><span class="p">,</span> <span class="n">delem</span><span class="p">,</span> <span class="n">ddens</span><span class="p">,</span> <span class="n">missing_dims</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    
        <span class="c1"># non-existing density classes (ndens_h==0) --&gt; NaN</span>
        <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;ndens_w_A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;ndens_w_A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;ndens_h&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s1">&#39;nz_rho&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">edims</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span> <span class="n">edims</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">edims</span><span class="p">[</span><span class="s1">&#39;nz1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;nz1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="c1"># expand by nz1 dimension</span>
        <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;nz_w_A&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;w_A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">edims</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dtime</span><span class="p">,</span> <span class="n">delem</span><span class="p">,</span> <span class="s1">&#39;nz1&#39;</span><span class="p">,</span> <span class="n">missing_dims</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            
        <span class="c1"># land sea mask --&gt; NaN</span>
        <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;nz_w_A&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;nz_w_A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;nz_rho&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># scale surface density fluxes are already area weighted for zonal </span>
    <span class="c1"># integration</span>
    <span class="k">if</span> <span class="s1">&#39;dmoc_fh&#39;</span>   <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc_fh&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc_fh&#39;</span>   <span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e-6</span> 
    <span class="k">if</span> <span class="s1">&#39;dmoc_fw&#39;</span>   <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc_fw&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc_fw&#39;</span>   <span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e-6</span>
    <span class="k">if</span> <span class="s1">&#39;dmoc_fr&#39;</span>   <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc_fr&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc_fr&#39;</span>   <span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e-6</span> 
    <span class="k">if</span> <span class="s1">&#39;dmoc_fd&#39;</span>   <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc_fd&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc_fd&#39;</span>   <span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e-6</span>     
    <span class="k">if</span> <span class="s1">&#39;dmoc_dvdt&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc_dvdt&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc_dvdt&#39;</span> <span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e-6</span>
    <span class="k">if</span> <span class="s1">&#39;dmoc&#39;</span>      <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span>      <span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span>      <span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e-6</span>
    <span class="k">if</span> <span class="s1">&#39;dmoc_bolus&#39;</span><span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc_bolus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;dmoc_bolus&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e-6</span>

    <span class="c1"># multiply with weights to prepare for area weighted zonal means </span>
    <span class="k">if</span> <span class="s1">&#39;ndens_h&#39;</span>   <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;ndens_h&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;ndens_h&#39;</span>   <span class="p">]</span> <span class="o">*</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;ndens_w_A&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;ndens_z&#39;</span>   <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;ndens_z&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;ndens_z&#39;</span>   <span class="p">]</span> <span class="o">*</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;ndens_w_A&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;nz_rho&#39;</span>    <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_dMOC</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;nz_rho&#39;</span>    <span class="p">]</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;nz_rho&#39;</span>    <span class="p">]</span> <span class="o">*</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;nz_w_A&#39;</span>   <span class="p">]</span>
    <span class="n">data_dMOC</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># create meridional bins --&gt; this trick is from Nils Brückemann (ICON)</span>
    <span class="n">lat_bin</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">data_dMOC</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">/</span><span class="n">dlat</span><span class="p">)</span><span class="o">*</span><span class="n">dlat</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;elem&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span>
    <span class="n">lat</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lat_bin</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lat_bin</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">dlat</span><span class="p">,</span> <span class="n">dlat</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># define subroutine for binning over latitudes, allows for parallelisation</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dmoc_over_lat</span><span class="p">(</span><span class="n">lat_i</span><span class="p">,</span> <span class="n">lat_bin</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># compute which vertice is within the latitudinal bin</span>
        <span class="c1"># --&gt; groupby is here a factor 5-6 slower than using isel+np.where</span>
        <span class="n">data_latbin</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">elem</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lat_bin</span><span class="o">==</span><span class="n">lat_i</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">data_latbin</span> <span class="o">=</span> <span class="n">data_latbin</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;elem&#39;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">vlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_latbin</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># compute area weighted zonal mean only for the vertical zcoordinate </span>
        <span class="k">if</span> <span class="s1">&#39;ndens_h&#39;</span>   <span class="ow">in</span> <span class="n">vlist</span><span class="p">:</span> <span class="n">data_latbin</span><span class="p">[</span><span class="s1">&#39;ndens_h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_latbin</span><span class="p">[</span><span class="s1">&#39;ndens_h&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data_latbin</span><span class="p">[</span><span class="s1">&#39;ndens_w_A&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;ndens_z&#39;</span>   <span class="ow">in</span> <span class="n">vlist</span><span class="p">:</span> <span class="n">data_latbin</span><span class="p">[</span><span class="s1">&#39;ndens_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_latbin</span><span class="p">[</span><span class="s1">&#39;ndens_z&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data_latbin</span><span class="p">[</span><span class="s1">&#39;ndens_w_A&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;nz_rho&#39;</span>    <span class="ow">in</span> <span class="n">vlist</span><span class="p">:</span> <span class="n">data_latbin</span><span class="p">[</span><span class="s1">&#39;nz_rho&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">data_latbin</span><span class="p">[</span><span class="s1">&#39;nz_rho&#39;</span> <span class="p">]</span><span class="o">/</span><span class="n">data_latbin</span><span class="p">[</span><span class="s1">&#39;nz_w_A&#39;</span>   <span class="p">]</span>
        <span class="c1"># drop  now total area in bins over depth level and density class</span>
        <span class="k">if</span> <span class="s1">&#39;ndens_w_A&#39;</span> <span class="ow">in</span> <span class="n">vlist</span><span class="p">:</span> <span class="n">data_latbin</span>            <span class="o">=</span> <span class="n">data_latbin</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;ndens_w_A&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;nz_w_A&#39;</span>    <span class="ow">in</span> <span class="n">vlist</span><span class="p">:</span> <span class="n">data_latbin</span>            <span class="o">=</span> <span class="n">data_latbin</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;nz_w_A&#39;</span><span class="p">])</span>
        <span class="k">return</span><span class="p">(</span><span class="n">data_latbin</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># do serial loop over latitudinal bins</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">do_parallel</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">do_info</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> ___loop over latitudinal bins___&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">*</span><span class="mi">90</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">data_lat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iy</span><span class="p">,</span> <span class="n">lat_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lat</span><span class="p">):</span>
            <span class="c1"># here compute sum over each lat-bin</span>
            <span class="n">data_lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dmoc_over_lat</span><span class="p">(</span><span class="n">lat_i</span><span class="p">,</span> <span class="n">lat_bin</span><span class="p">,</span> <span class="n">data_dMOC</span><span class="p">))</span>
        <span class="n">dmoc</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data_lat</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span>    
    <span class="c1"># do parallel loop over latitudinal bins</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">do_info</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> ___parallel loop over longitudinal bins___&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
        <span class="n">data_lat</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_workers</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">dmoc_over_lat</span><span class="p">)(</span><span class="n">lat_i</span><span class="p">,</span> <span class="n">lat_bin</span><span class="p">,</span> <span class="n">data_dMOC</span><span class="p">)</span> <span class="k">for</span> <span class="n">lat_i</span> <span class="ow">in</span> <span class="n">lat</span><span class="p">)</span>
        <span class="n">dmoc</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data_lat</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span>
    <span class="k">del</span><span class="p">(</span><span class="n">data_lat</span><span class="p">)</span>  
        
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># rearange dimension, add necessary coordinates, attributes ... </span>
    <span class="n">dmoc</span> <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;lat&#39;</span><span class="p">:</span><span class="n">lat</span><span class="p">})</span>
    <span class="k">for</span> <span class="n">vari</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmoc</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># transpose dimension </span>
        <span class="n">dimv</span> <span class="o">=</span> <span class="s1">&#39;ndens&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;nz1&#39;</span>  <span class="ow">in</span> <span class="n">dmoc</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">dimv</span><span class="o">=</span><span class="s1">&#39;nz1&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">dmoc</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span> <span class="n">dmoc</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmoc</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="n">dimv</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span>
        <span class="k">else</span>                        <span class="p">:</span> <span class="n">dmoc</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmoc</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dimv</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span>
        
        <span class="c1">#_______________________________________________________________________</span>
        <span class="c1"># add more variable attributes</span>
        <span class="n">strmoc</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span><span class="o">+</span><span class="n">which_moc_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">vattr</span> <span class="o">=</span> <span class="n">data_dMOC</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="k">if</span>   <span class="n">vari</span><span class="o">==</span><span class="s1">&#39;dmoc_fh&#39;</span>   <span class="p">:</span> <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Transformation from heat flux&#39;</span>                 <span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="n">strmoc</span><span class="o">+</span><span class="s1">&#39;_fh&#39;</span>   <span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;Sv&#39;</span>   <span class="p">})</span>
        <span class="k">elif</span> <span class="n">vari</span><span class="o">==</span><span class="s1">&#39;dmoc_fw&#39;</span>   <span class="p">:</span> <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Transformation from freshwater flux&#39;</span>           <span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="n">strmoc</span><span class="o">+</span><span class="s1">&#39;_fw&#39;</span>   <span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;Sv&#39;</span>   <span class="p">})</span>
        <span class="k">elif</span> <span class="n">vari</span><span class="o">==</span><span class="s1">&#39;dmoc_fr&#39;</span>   <span class="p">:</span> <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Transformation from surface salinity restoring&#39;</span><span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="n">strmoc</span><span class="o">+</span><span class="s1">&#39;_fr&#39;</span>   <span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;Sv&#39;</span>   <span class="p">})</span>
        <span class="k">elif</span> <span class="n">vari</span><span class="o">==</span><span class="s1">&#39;dmoc_fd&#39;</span>   <span class="p">:</span> <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Transformation from total density flu&#39;</span>         <span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="n">strmoc</span><span class="o">+</span><span class="s1">&#39;_fd&#39;</span>   <span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;Sv&#39;</span>   <span class="p">})</span>
        <span class="k">elif</span> <span class="n">vari</span><span class="o">==</span><span class="s1">&#39;dmoc_dvdt&#39;</span> <span class="p">:</span> <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Transformation from volume change&#39;</span>             <span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="n">strmoc</span><span class="o">+</span><span class="s1">&#39;_dv&#39;</span>   <span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;Sv&#39;</span>   <span class="p">})</span>
        <span class="k">elif</span> <span class="n">vari</span><span class="o">==</span><span class="s1">&#39;dmoc&#39;</span>      <span class="p">:</span> <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Density MOC&#39;</span>                                   <span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="n">strmoc</span>         <span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;Sv&#39;</span>   <span class="p">})</span>
        <span class="k">elif</span> <span class="n">vari</span><span class="o">==</span><span class="s1">&#39;dmoc_bolus&#39;</span><span class="p">:</span> <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Density MOC bolus vel.&#39;</span>                        <span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="n">strmoc</span><span class="o">+</span><span class="s1">&#39;_bolus&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;Sv&#39;</span>   <span class="p">})</span>
        <span class="k">elif</span> <span class="n">vari</span><span class="o">==</span><span class="s1">&#39;ndens_h&#39;</span>   <span class="p">:</span> <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Density class thickness&#39;</span>                       <span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="s1">&#39;ndens_h&#39;</span>      <span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;m&#39;</span>    <span class="p">})</span>
        <span class="k">elif</span> <span class="n">vari</span><span class="o">==</span><span class="s1">&#39;ndens_zfh&#39;</span> <span class="p">:</span> <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Density class z position&#39;</span>                      <span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="s1">&#39;ndens_zfh&#39;</span>    <span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;m&#39;</span>    <span class="p">})</span>
        <span class="k">elif</span> <span class="n">vari</span><span class="o">==</span><span class="s1">&#39;ndens_z&#39;</span>   <span class="p">:</span> <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Density class z position&#39;</span>                      <span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="s1">&#39;ndens_z&#39;</span>      <span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;m&#39;</span>    <span class="p">})</span>
        <span class="k">elif</span> <span class="n">vari</span><span class="o">==</span><span class="s1">&#39;nz_rho&#39;</span>    <span class="p">:</span> <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;sigma2 density in zcoord&#39;</span>                      <span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="s1">&#39;nz_rho&#39;</span>       <span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;kg/m³&#39;</span><span class="p">})</span>
        <span class="n">dmoc</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span><span class="o">=</span><span class="n">dmoc</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">vattr</span><span class="p">)</span>
    <span class="k">del</span><span class="p">(</span><span class="n">data_dMOC</span><span class="p">)</span>
    <span class="n">dmoc</span><span class="o">=</span><span class="n">dmoc</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">gattr</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># exclude variables that should not be cumulatively integrated --&gt; than do</span>
    <span class="c1"># cumulative sumation over lat</span>
    <span class="n">var_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmoc</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="s1">&#39;ndens_h&#39;</span>   <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span> <span class="n">var_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;ndens_h&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;ndens_z&#39;</span>   <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span> <span class="n">var_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;ndens_z&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;nz_rho&#39;</span>    <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span> <span class="n">var_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;nz_rho&#39;</span> <span class="p">)</span>   
    
    <span class="c1"># 1) flip dimension along latitude S-&gt;N --&gt; N-&gt;S </span>
    <span class="c1"># 2) do cumulative sumation from N-&gt;S</span>
    <span class="c1"># 3) flip dimension back to S-&gt;N</span>
    <span class="k">if</span> <span class="n">do_info</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; --&gt; do cumsum over latitudes&#39;</span><span class="p">)</span>
    <span class="n">reverse</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span>
        <span class="n">dmoc</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dmoc</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>

    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># cumulative sum over density </span>
    <span class="k">if</span> <span class="n">do_info</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; --&gt; do cumsum over density (bottom--&gt;top)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;dmoc&#39;</span>      <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmoc</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">dmoc</span><span class="p">[</span> <span class="s1">&#39;dmoc&#39;</span>       <span class="p">]</span> <span class="o">=</span> <span class="n">dmoc</span><span class="p">[</span> <span class="s1">&#39;dmoc&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ndens</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;ndens&#39;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ndens</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s1">&#39;dmoc_bolus&#39;</span><span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmoc</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">dmoc</span><span class="p">[</span> <span class="s1">&#39;dmoc_bolus&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">dmoc</span><span class="p">[</span> <span class="s1">&#39;dmoc_bolus&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ndens</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;ndens&#39;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ndens</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># compute z-position (z) from (f) density class thickness (h)</span>
    <span class="k">if</span> <span class="s1">&#39;ndens_h&#39;</span>   <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmoc</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">dmoc</span><span class="p">[</span> <span class="s1">&#39;ndens_zfh&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">dmoc</span><span class="p">[</span> <span class="s1">&#39;ndens_h&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;ndens&#39;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dmoc</span><span class="p">[</span> <span class="s1">&#39;ndens_zfh&#39;</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">dmoc</span><span class="p">[</span> <span class="s1">&#39;ndens_zfh&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">roll</span><span class="p">({</span><span class="s1">&#39;ndens&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
        <span class="n">dmoc</span><span class="p">[</span> <span class="s1">&#39;ndens_zfh&#39;</span>  <span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">ndens</span><span class="o">=</span><span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span><span class="o">=</span><span class="mf">0.0</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># Move grid related variables into coordinate section of the xarray dataset</span>
    <span class="k">if</span> <span class="s1">&#39;ndens_h&#39;</span>   <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmoc</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">dmoc</span> <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="s1">&#39;ndens_h&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;ndens_zfh&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmoc</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">dmoc</span> <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="s1">&#39;ndens_zfh&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;nz_rho&#39;</span>    <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmoc</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">dmoc</span> <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="s1">&#39;nz_rho&#39;</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># Add bolus MOC to normal MOC</span>
    <span class="k">if</span> <span class="s1">&#39;dmoc&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmoc</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="s1">&#39;dmoc_bolus&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmoc</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">do_bolus</span><span class="p">:</span>  
        <span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_bolus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">do_dropvar</span><span class="p">:</span> <span class="n">dmoc</span> <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;dmoc_bolus&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">which_transf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
        <span class="k">if</span> <span class="s1">&#39;srf&#39;</span> <span class="ow">in</span> <span class="n">which_transf</span><span class="p">:</span> 
            <span class="k">if</span> <span class="s1">&#39;dmoc_fh&#39;</span> <span class="ow">in</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">data_vars</span> <span class="ow">and</span> <span class="s1">&#39;dmoc_fw&#39;</span> <span class="ow">in</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">data_vars</span> <span class="ow">and</span> <span class="s1">&#39;dmoc_fr&#39;</span> <span class="ow">in</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_srf&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span><span class="p">(</span><span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_fh&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_fw&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_fr&#39;</span><span class="p">])</span>
                
                <span class="n">vattr</span> <span class="o">=</span> <span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_fh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
                <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Surface Transformation&#39;</span>                 <span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="n">strmoc</span><span class="o">+</span><span class="s1">&#39;_srf&#39;</span>   <span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;Sv&#39;</span>   <span class="p">})</span>
                <span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_srf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_srf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">vattr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">do_dropvar</span><span class="p">:</span> <span class="n">dmoc</span>  <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;dmoc_fh&#39;</span><span class="p">,</span> <span class="s1">&#39;dmoc_fw&#39;</span><span class="p">,</span> <span class="s1">&#39;dmoc_fr&#39;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="s1">&#39;inner&#39;</span> <span class="ow">in</span> <span class="n">which_transf</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;dmoc_fh&#39;</span> <span class="ow">in</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">data_vars</span> <span class="ow">and</span> <span class="s1">&#39;dmoc_fw&#39;</span> <span class="ow">in</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">data_vars</span> <span class="ow">and</span> <span class="s1">&#39;dmoc_fr&#39;</span> <span class="ow">in</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">data_vars</span> <span class="ow">and</span> <span class="s1">&#39;dmoc&#39;</span> <span class="ow">in</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_inner&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_fh&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_fw&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_fr&#39;</span><span class="p">])</span>
                
                <span class="n">vattr</span> <span class="o">=</span> <span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
                <span class="n">vattr</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Inner Transformation&#39;</span>                 <span class="p">,</span> <span class="s1">&#39;short_name&#39;</span><span class="p">:</span><span class="n">strmoc</span><span class="o">+</span><span class="s1">&#39;_inner&#39;</span>   <span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;Sv&#39;</span>   <span class="p">})</span>
                <span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_inner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmoc</span><span class="p">[</span><span class="s1">&#39;dmoc_inner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">vattr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">do_dropvar</span><span class="p">:</span> <span class="n">dmoc</span>  <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;dmoc_fh&#39;</span><span class="p">,</span> <span class="s1">&#39;dmoc_fw&#39;</span><span class="p">,</span> <span class="s1">&#39;dmoc_fr&#39;</span><span class="p">,</span> <span class="s1">&#39;dmoc&#39;</span><span class="p">])</span>
                
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># compute depth of max and mean bottom topography</span>
    <span class="n">elemz</span>     <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zlev</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span><span class="p">]),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">])</span>
    <span class="n">elemz</span>     <span class="o">=</span> <span class="n">elemz</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">elem</span><span class="o">=</span><span class="n">idxin</span><span class="p">)</span>
    <span class="n">elemz_m</span>   <span class="o">=</span> <span class="n">elemz</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">lat_bin</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">dmoc</span>      <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">botmax</span> <span class="o">=</span><span class="n">elemz_m</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">))</span>
    
    <span class="n">elemz_m</span>   <span class="o">=</span> <span class="n">elemz</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">lat_bin</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">dmoc</span>      <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">botmean</span><span class="o">=</span><span class="n">elemz_m</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">))</span>
    <span class="k">del</span> <span class="p">(</span><span class="n">elemz</span><span class="p">,</span> <span class="n">elemz_m</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="c1"># compute index of max mean bottom topography</span>
    <span class="n">elemiz</span>    <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">e_iz</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">])</span>
    <span class="n">elemiz</span>    <span class="o">=</span> <span class="n">elemiz</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">elem</span><span class="o">=</span><span class="n">idxin</span><span class="p">)</span>
    <span class="n">elemiz</span>    <span class="o">=</span> <span class="n">elemiz</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">lat_bin</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">dmoc</span>      <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">botmaxi</span><span class="o">=</span><span class="n">elemiz</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">))</span>
    <span class="k">del</span><span class="p">(</span><span class="n">elemiz</span><span class="p">)</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">if</span> <span class="n">do_compute</span><span class="p">:</span> <span class="n">dmoc</span> <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">do_load</span>   <span class="p">:</span> <span class="n">dmoc</span> <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">do_persist</span><span class="p">:</span> <span class="n">dmoc</span> <span class="o">=</span> <span class="n">dmoc</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="k">return</span><span class="p">(</span><span class="n">dmoc</span><span class="p">)</span></div>




<span class="c1">#_______________________________________________________________________________     </span>
<span class="c1"># do creepy brute force play around to enforce more or less monotonicity in </span>
<span class="c1"># dens_z, std_dens_Z --&gt; not realy recommendet to do only as a last option</span>
<div class="viewcode-block" id="do_ztransform">
<a class="viewcode-back" href="../../index.html#tripyview.sub_dmoc.do_ztransform">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">do_ztransform</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">numpy.matlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">repmat</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">interpolate</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy.ma</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ma</span>
    
    <span class="c1"># use depth information of depth of density classes at latitude</span>
    <span class="n">data_y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ndens_z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1">#     data_y = data[&#39;dmoc_zpos&#39;].values.copy()</span>
<span class="c1">#     data_y[1,:] = 0.0</span>
<span class="c1">#     data_y[-1,:] = -6250</span>
    <span class="n">data_y</span><span class="p">[</span><span class="n">data_y</span><span class="o">&gt;=-</span><span class="mf">1.0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            
    <span class="c1"># do dirty trick here !!! make sure that below the deepest depth at </span>
    <span class="c1"># every latitude that there is no nan value or a value shallower than</span>
    <span class="c1"># the deepest depth left</span>
    <span class="n">nlat</span>  <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">size</span>
    <span class="n">ndens</span> <span class="o">=</span>  <span class="n">data_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlat</span><span class="p">):</span>
        <span class="n">min_datay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data_y</span><span class="p">[:,</span><span class="n">kk</span><span class="p">])</span>
        <span class="n">min_dep</span>   <span class="o">=</span> <span class="o">-</span><span class="mf">6200.0</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ndens</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span> <span class="c1"># to bottom to top</span>
            <span class="k">if</span> <span class="n">data_y</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span><span class="o">==</span><span class="n">min_datay</span><span class="p">:</span><span class="k">break</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_y</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">kk</span><span class="p">])</span> <span class="ow">or</span> <span class="n">data_y</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span><span class="o">&gt;</span><span class="n">min_datay</span><span class="p">:</span> <span class="n">data_y</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span><span class="o">=</span><span class="n">min_datay</span>
<span class="c1">#             if np.isnan(data_y[jj,kk]) or data_y[jj,kk]&gt;min_datay: data_y[jj,kk]=min_dep</span>
    <span class="k">del</span><span class="p">(</span><span class="n">min_datay</span><span class="p">)</span>  
    <span class="c1"># same but for the surface</span>
    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlat</span><span class="p">):</span>
        <span class="n">max_datay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data_y</span><span class="p">[:,</span><span class="n">kk</span><span class="p">])</span>
        <span class="n">max_dep</span>   <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ndens</span><span class="p">)):</span> 
            <span class="k">if</span> <span class="n">data_y</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span><span class="o">==</span><span class="n">max_datay</span><span class="p">:</span><span class="k">break</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_y</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">kk</span><span class="p">])</span> <span class="ow">or</span> <span class="n">data_y</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span><span class="o">&lt;</span><span class="n">max_datay</span><span class="p">:</span> <span class="n">data_y</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">kk</span><span class="p">]</span><span class="o">=</span><span class="n">max_datay</span>        
<span class="c1">#             if np.isnan(data_y[jj,kk]) or data_y[jj,kk]&lt;max_datay: data_y[jj,kk]=max_dep        </span>
    <span class="k">del</span><span class="p">(</span><span class="n">max_datay</span><span class="p">)</span>        
    <span class="c1"># do [ndens x nlat] matrix for latitudes</span>
    <span class="n">data_x</span>   <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data_x</span>   <span class="o">=</span> <span class="n">repmat</span><span class="p">(</span><span class="n">data_x</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#     data_x   = repmat(data_x,data[&#39;ndens&#39;].values.size,1)</span>
            
    <span class="c1">## do nearest neighbour interpolation of remaining nan values in depth_y</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">data_x</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="c1">#     xx, yy = np.meshgrid(data_x[0,:], data[&#39;ndens&#39;].values)</span>
    <span class="n">data_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">data_y</span><span class="p">)</span>
    <span class="n">data_y</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">griddata</span><span class="p">((</span><span class="n">xx</span><span class="p">[</span><span class="o">~</span><span class="n">data_y</span><span class="o">.</span><span class="n">mask</span><span class="p">],</span> <span class="n">yy</span><span class="p">[</span><span class="o">~</span><span class="n">data_y</span><span class="o">.</span><span class="n">mask</span><span class="p">]),</span> <span class="n">data_y</span><span class="p">[</span><span class="o">~</span><span class="n">data_y</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                  <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    
    
    <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">idx</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_y</span><span class="p">[</span><span class="n">ni</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">&lt;</span><span class="n">data_y</span><span class="p">[</span><span class="n">ni</span><span class="p">,:])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
            <span class="n">data_y</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_y</span><span class="p">[</span><span class="n">ni</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span>
            
<span class="c1">#     data_y[-1,:] = -6000</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data_x</span><span class="p">,</span> <span class="n">data_y</span><span class="p">)</span>        </div>


<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________</span>
<div class="viewcode-block" id="do_ztransform_martin">
<a class="viewcode-back" href="../../index.html#tripyview.sub_dmoc.do_ztransform_martin">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">do_ztransform_martin</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">lat</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">dep</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="p">)</span>
    <span class="n">nlat</span><span class="p">,</span> <span class="n">ndens</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dens</span><span class="o">.</span><span class="n">size</span> 
    <span class="n">nz</span>          <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">size</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">sigma2</span>    <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nz_rho&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">dmoc</span>      <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">data_dmocz</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sigma2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1">#f = interp1d(np.array(std_dens), dmoc, axis=0, bounds_error = False, fill_value=0)   </span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">dens</span><span class="p">,</span> <span class="n">dmoc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds_error</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlat</span><span class="p">):</span>
        <span class="n">data_dmocz</span><span class="p">[:,</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">sigma2</span><span class="p">[:,</span><span class="n">li</span><span class="p">])[:,</span><span class="n">li</span><span class="p">]</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">data_dmocz</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">)</span></div>


<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________</span>
<div class="viewcode-block" id="do_ztransform_mom6">
<a class="viewcode-back" href="../../index.html#tripyview.sub_dmoc.do_ztransform_mom6">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">do_ztransform_mom6</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>

    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">lat</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">dep</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="p">)</span>
    <span class="n">nlat</span><span class="p">,</span> <span class="n">ndens</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dens</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">size</span>
    <span class="n">sigma2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nz_rho&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">sigma2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sigma2</span><span class="p">)]</span><span class="o">=</span><span class="mf">40.0</span>

    <span class="n">data_v</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,:]</span>
    <span class="n">data_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">ndens</span><span class="p">,</span><span class="n">nlat</span><span class="p">])</span><span class="o">*</span><span class="n">lat</span>
    <span class="n">data_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ndens</span><span class="p">,</span><span class="n">nlat</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlat</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">sigma2</span><span class="p">[:,</span><span class="n">li</span><span class="p">],</span> <span class="n">dep</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>        
        <span class="c1">#data_y[:,li] = f(std_dens[:])</span>
        <span class="n">data_y</span><span class="p">[:,</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">dens</span><span class="p">[:])</span>
    <span class="n">data_y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_y</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="c1">#print(data_x.shape)</span>
    <span class="c1">#print(data_y.shape)</span>
    <span class="c1">#print(data_v.shape)</span>
    <span class="c1">#densc=dict({&#39;data_x&#39;:data_x, &#39;data_y&#39;:data_y, &#39;data_v&#39;:data_v})</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">data_dmocz</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nz</span><span class="p">,</span> <span class="n">nlat</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlat</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">data_y</span><span class="p">[:,</span><span class="n">li</span><span class="p">],</span> <span class="n">data_v</span><span class="p">[:,</span><span class="n">li</span><span class="p">],</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">data_dmocz</span><span class="p">[:,</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
    

    <span class="k">return</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">data_dmocz</span><span class="p">)</span></div>


<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#_______________________________________________________________________________</span>
<div class="viewcode-block" id="do_ztransform_hydrography">
<a class="viewcode-back" href="../../index.html#tripyview.sub_dmoc.do_ztransform_hydrography">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">do_ztransform_hydrography</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --&gt; </span>
<span class="sd">    ____________________________________________________________________________</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">lat</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ndens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">dep</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">zmid</span><span class="p">)</span>
    <span class="n">nlat</span><span class="p">,</span> <span class="n">ndens</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dens</span><span class="o">.</span><span class="n">size</span> 
    <span class="n">nz</span>          <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">size</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">sigma2</span>    <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nz_rho&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">dmoc</span>      <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dmoc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    
    <span class="c1">#___________________________________________________________________________</span>
    <span class="n">data_dmocz</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sigma2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">dens</span><span class="p">,</span> <span class="n">dmoc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds_error</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlat</span><span class="p">):</span>
        <span class="c1">#data_dmocz[:,li] = np.interp(sigma2[:,li], dens, dmoc[:,li])</span>
        
        
        <span class="n">data_dmocz</span><span class="p">[:,</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">sigma2</span><span class="p">[:,</span><span class="n">li</span><span class="p">])[:,</span><span class="n">li</span><span class="p">]</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">data_dmocz</span><span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          
          <h3>Table of Contents</h3>
          
          <search role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
            </form>
          </search>

        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="Related">
            <a href="../../py-modindex.html" title="Python Module Index"
              >modules</a> |
            <a href="../../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Patrick Scholz.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>